<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Gado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f9f0 0%, #e6f3ff 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Estilos da p√°gina de login */
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
        }

        .login-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .login-title {
            font-size: 2.5rem;
            color: #2d5a3d;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .login-subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .location-info {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #1e40af;
        }

        .login-form {
            margin-bottom: 20px;
        }

        .login-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1.1rem;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .login-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            transform: translateY(-2px);
        }

        .login-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .login-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e5e7eb;
        }

        .login-feature {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            transition: transform 0.3s ease;
        }

        .login-feature:hover {
            transform: translateY(-3px);
        }

        .login-feature-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .login-feature-text {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Estilos da aplica√ß√£o principal */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d5a3d;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        h1 {
            text-align: center;
            color: #2d5a3d;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            background: white;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 4px;
        }

        .nav-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #2d5a3d;
        }

        .nav-tab.active {
            background: #2d5a3d;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .nav-tab:hover:not(.active) {
            background: #f0f9f0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #2d5a3d;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            padding: 20px;
            border-radius: 12px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-card.user { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .dashboard-card.temp { background: linear-gradient(135deg, #f97316, #ea580c); }
        .dashboard-card.humidity { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .dashboard-card.cattle { background: linear-gradient(135deg, #10b981, #059669); }

        .dashboard-card .icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .dashboard-card h3 {
            margin: 0;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 4px 0;
        }

        .dashboard-card .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .form-group input[type="date"] {
            font-family: inherit;
        }

        .btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: #6366f1;
        }

        .btn-secondary:hover {
            background: #4f46e5;
        }

        .btn-purple {
            background: #8b5cf6;
        }

        .btn-purple:hover {
            background: #7c3aed;
        }

        .vaccines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .vaccine-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .vaccine-checkbox:hover {
            background-color: #f3f4f6;
        }

        .add-new-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .add-new-container input {
            flex: 1;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-container {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-container input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background-color: #f0f9f0;
            font-weight: 600;
            color: #2d5a3d;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
        }

        .badge-category {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .badge-vaccine {
            background-color: #e9d5ff;
            color: #7c2d12;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #374151;
        }

        .stats-summary {
            background: #f9fafb;
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .quick-summary {
            margin-top: 30px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #374151;
        }

        .loading {
            color: #6b7280;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .login-container {
                padding: 30px 20px;
            }

            .login-title {
                font-size: 2rem;
            }

            h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-direction: column;
                align-items: stretch;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .search-container {
                min-width: auto;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-logo">üêÑ</div>
            <h1 class="login-title">Bem-vindo!</h1>
            <p class="login-subtitle">Sistema de Gerenciamento de Gado</p>
            
            <div id="locationInfo" class="location-info" style="display: none;">
                <div id="locationText">üìç Detectando localiza√ß√£o...</div>
            </div>
            
            <form class="login-form" onsubmit="login(event)">
                <input 
                    type="text" 
                    id="userName" 
                    class="login-input" 
                    placeholder="Digite seu nome..." 
                    required 
                    maxlength="50"
                    autocomplete="name"
                >
                <button type="submit" class="login-btn" id="loginBtn">
                    Entrar no Sistema
                </button>
            </form>

            <div class="login-features">
                <div class="login-feature">
                    <span class="login-feature-icon">üìä</span>
                    <div class="login-feature-text">Relat√≥rios</div>
                </div>
                <div class="login-feature">
                    <span class="login-feature-icon">üêÑ</span>
                    <div class="login-feature-text">Gest√£o</div>
                </div>
                <div class="login-feature">
                    <span class="login-feature-icon">üíâ</span>
                    <div class="login-feature-text">Vacinas</div>
                </div>
                <div class="login-feature">
                    <span class="login-feature-icon">üìà</span>
                    <div class="login-feature-text">An√°lises</div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="main-app">
        <div class="container">
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">J</div>
                    <div>
                        <div><strong>Ol√°, <span id="userDisplayName">Usu√°rio</span>!</strong></div>
                        <div style="color: #6b7280; font-size: 0.9rem;" id="userLocation">
                            üìç <span id="locationDisplay">Carregando localiza√ß√£o...</span>
                        </div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    üö™ Sair
                </button>
            </div>

            <h1>Sistema de Gerenciamento de Gado</h1>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">
                    üë§ Dashboard
                </button>
                <button class="nav-tab" onclick="showTab('add')">
                    ‚ûï Adicionar Gado
                </button>
                <button class="nav-tab" onclick="showTab('list')">
                    üìã Lista de Gado
                </button>
                <button class="nav-tab" onclick="showTab('charts')">
                    üìä Estat√≠sticas
                </button>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2>üë§ Dashboard do Usu√°rio</h2>
                    <div class="dashboard-grid">
                        <div class="dashboard-card user">
                            <div>
                                <h3>Usu√°rio</h3>
                                <div class="value" id="dashboardUserName">Usu√°rio</div>
                                <div class="subtitle" id="dashboardLocation">Carregando...</div>
                            </div>
                            <div class="icon">üë§</div>
                        </div>
                        
                        <div class="dashboard-card temp">
                            <div>
                                <h3>Temperatura</h3>
                                <div class="value" id="tempValue">--¬∞C</div>
                                <div class="subtitle" id="weatherDesc">Carregando...</div>
                            </div>
                            <div class="icon">üå°Ô∏è</div>
                        </div>
                        
                        <div class="dashboard-card humidity">
                            <div>
                                <h3>Umidade</h3>
                                <div class="value" id="humidityValue">--%</div>
                                <div class="subtitle">Condi√ß√£o atual</div>
                            </div>
                            <div class="icon">üíß</div>
                        </div>
                        
                        <div class="dashboard-card cattle">
                            <div>
                                <h3>Total de Gado</h3>
                                <div class="value" id="totalCattle">0</div>
                                <div class="subtitle">Animais cadastrados</div>
                            </div>
                            <div class="icon">üêÑ</div>
                        </div>
                    </div>

                    <div id="quickSummary" class="quick-summary" style="display: none;">
                        <h3>Resumo R√°pido</h3>
                        <div class="summary-grid">
                            <div class="summary-card">
                                <div class="summary-label">Peso M√©dio</div>
                                <div class="summary-value" id="avgWeight">0 kg</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">Categoria Mais Comum</div>
                                <div class="summary-value" id="commonCategory">-</div>
                            </div>
                            <div class="summary-card">
                                <div class="summary-label">√öltimo Cadastro</div>
                                <div class="summary-value" id="lastAdded">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="add" class="tab-content">
                <div class="card">
                    <h2>‚ûï Adicionar Novo Gado</h2>
                    <div class="form-grid">
                        <div>
                            <div class="form-group">
                                <label>üè∑Ô∏è Identifica√ß√£o do Gado</label>
                                <input type="text" id="cattleId" placeholder="Ex: BOV001, A123, etc.">
                            </div>

                            <div class="form-group">
                                <label>üìÖ Data de Nascimento</label>
                                <input type="date" id="cattleBirthDate">
                            </div>

                            <div class="form-group">
                                <label>‚öñÔ∏è Peso Atual (kg)</label>
                                <input type="number" id="cattleWeight" placeholder="Ex: 450">
                            </div>

                            <div class="form-group">
                                <label>üìÇ Categoria</label>
                                <select id="cattleCategory">
                                    <option value="">Selecione uma categoria</option>
                                </select>
                                <div class="add-new-container">
                                    <input type="text" id="newCategory" placeholder="Nova categoria">
                                    <button class="btn btn-secondary" type="button" onclick="addCategory()">Adicionar</button>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="form-group">
                                <label>üíâ Vacinas Aplicadas</label>
                                <div id="vaccinesContainer" class="vaccines-grid">
                                    </div>
                                <div class="add-new-container">
                                    <input type="text" id="newVaccine" placeholder="Nova vacina">
                                    <button class="btn btn-purple" type="button" onclick="addVaccine()">Adicionar</button>
                                </div>
                            </div>

                            <button class="btn" onclick="addCattle()" style="width: 100%; padding: 16px; font-size: 1.1rem;">
                                Cadastrar Gado
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="list" class="tab-content">
                <div class="card">
                    <h2>üìã Lista de Gado (<span id="cattleCount">0</span> animais)</h2>
                    
                    <div class="filters">
                        <div class="search-container">
                            <input type="text" id="searchTerm" placeholder="Buscar por identifica√ß√£o..." onkeyup="filterCattle()">
                            <span class="search-icon">üîç</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>üîç Filtro:</span>
                            <select id="categoryFilter" onchange="filterCattle()">
                                <option value="all">Todas as categorias</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="cattleTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data Nascimento</th>
                                    <th>Peso (kg)</th>
                                    <th>Categoria</th>
                                    <th>Vacinas</th>
                                    <th>Data Cadastro</th>
                                </tr>
                            </thead>
                            <tbody id="cattleTableBody">
                            </tbody>
                        </table>
                        <div id="emptyState" class="empty-state">
                            Nenhum gado cadastrado ainda.
                        </div>
                    </div>
                </div>
            </div>

            <div id="charts" class="tab-content">
                <div class="card">
                    <h2>üìä Estat√≠sticas do Rebanho</h2>
                    
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Distribui√ß√£o por Categoria</h3>
                            <canvas id="categoryChart" width="400" height="300"></canvas>
                            <div id="categoryEmpty" class="empty-state" style="display: none;">
                                Sem dados para exibir
                            </div>
                        </div>

                        <div class="chart-container">
                            <h3>Cobertura Vacinal</h3>
                            <canvas id="vaccineChart" width="400" height="300"></canvas>
                            <div id="vaccineEmpty" class="empty-state" style="display: none;">
                                Sem dados para exibir
                            </div>
                        </div>
                    </div>

                    <div id="statsSection" class="stats-summary" style="display: none;">
                        <h3>Resumo Estat√≠stico</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="statTotal" style="color: #10b981;">0</div>
                                <div class="stat-label">Total de Animais</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="statCategories" style="color: #3b82f6;">0</div>
                                <div class="stat-label">Categorias</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="statVaccines" style="color: #8b5cf6;">0</div>
                                <div class="stat-label">Tipos de Vacina</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="statAvgWeight" style="color: #f59e0b;">0</div>
                                <div class="stat-label">Peso M√©dio (kg)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados globais para o usu√°rio atual
        let currentUser = null;
        let cattle = [];
        let categories = [];
        let vaccines = [];
        let userLocation = { city: '', state: '', country: '', lat: null, lon: null };
        
        // **SUBSTITUA PELA SUA CHAVE DE API DO OPENWEATHERMAP**
        const OPENWEATHER_API_KEY = '6b78a94becfdff74b732c9bd59a89b1f';
        
        // Vari√°veis para os gr√°ficos
        let categoryChart = null;
        let vaccineChart = null;
        
        // Chave de armazenamento no localStorage
        const STORAGE_KEY = 'cattle_management_app_data';

        // Sistema de armazenamento usando localStorage
        function saveData() {
            // Salvar todos os dados do usu√°rio atual no objeto principal
            if (currentUser) {
                const appData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                appData[currentUser.name] = {
                    cattle: cattle,
                    categories: categories,
                    vaccines: vaccines,
                    location: userLocation,
                    loginDate: currentUser.loginDate,
                    loginTime: currentUser.loginTime
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                console.log('Dados do usu√°rio salvos:', appData[currentUser.name]);
            }
        }

        // Carregar dados do localStorage
        function loadData(userName) {
            const appData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            const userData = appData[userName];
            
            if (userData) {
                cattle = userData.cattle || [];
                categories = userData.categories || [];
                vaccines = userData.vaccines || [];
                userLocation = userData.location || { city: '', state: '', country: '' };
                console.log('Dados do usu√°rio carregados:', userData);
                return true;
            } else {
                // Se o usu√°rio √© novo, inicializar com dados padr√£o
                cattle = [];
                categories = ['Bezerro', 'Novilho', 'Vaca', 'Touro', 'Garrote'];
                vaccines = ['Febre Aftosa', 'Brucelose', 'Raiva', 'IBR', 'BVD'];
                userLocation = { city: 'Carregando...', state: 'Carregando...', country: 'Carregando...' };
                console.log('Novo usu√°rio, dados inicializados.');
                return false;
            }
        }

        // Geolocaliza√ß√£o
        async function getUserLocation() {
            try {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            try {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                await getLocationFromCoords(lat, lon);
                                await getRealWeatherData(lat, lon);
                            } catch (error) {
                                console.log('Erro ao obter localiza√ß√£o:', error);
                                setDefaultLocation();
                            }
                        },
                        (error) => {
                            console.log('Geolocaliza√ß√£o negada ou erro:', error);
                            setDefaultLocation();
                        },
                        {
                            timeout: 10000,
                            maximumAge: 300000 // 5 minutos
                        }
                    );
                } else {
                    setDefaultLocation();
                }
            } catch (error) {
                console.log('Erro geral de localiza√ß√£o:', error);
                setDefaultLocation();
            }
        }

        // NOVO: Obter nome da localiza√ß√£o a partir de coordenadas usando a API de Geocodifica√ß√£o do OpenWeatherMap
        async function getLocationFromCoords(lat, lon) {
            try {
                const apiUrl = `http://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${OPENWEATHER_API_KEY}`;
                
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (response.ok && data.length > 0) {
                    const locationData = data[0];
                    userLocation.city = locationData.name || 'Localiza√ß√£o Desconhecida';
                    userLocation.state = locationData.state || 'Regi√£o Desconhecida';
                    userLocation.country = locationData.country || 'Pa√≠s Desconhecido';
                    userLocation.lat = lat;
                    userLocation.lon = lon;
                    updateLocationDisplay();
                } else {
                    console.error('Erro ao buscar nome da localiza√ß√£o:', data);
                    setDefaultLocation();
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o da API de geocodifica√ß√£o:', error);
                setDefaultLocation();
            }
        }

        // Localiza√ß√£o e clima padr√£o (fallback)
        async function setDefaultLocation() {
            userLocation = {
                city: 'Candel√°ria',
                state: 'Rio Grande do Sul',
                country: 'Brasil',
                lat: -29.67,
                lon: -52.41
            };
            updateLocationDisplay();
            await getRealWeatherData(userLocation.lat, userLocation.lon);
        }

        // Nova fun√ß√£o para buscar dados de clima reais
        async function getRealWeatherData(lat, lon) {
            if (OPENWEATHER_API_KEY === 'YOUR_API_KEY' || OPENWEATHER_API_KEY === '') {
                document.getElementById('tempValue').textContent = '--¬∞C';
                document.getElementById('weatherDesc').textContent = 'API Key necess√°ria';
                document.getElementById('humidityValue').textContent = '--%';
                console.warn('Por favor, insira sua chave de API do OpenWeatherMap para obter dados de clima reais.');
                return;
            }

            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=pt_br`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (response.ok) {
                    const temp = data.main.temp.toFixed(1);
                    const humidity = data.main.humidity;
                    const description = data.weather[0].description;

                    document.getElementById('tempValue').textContent = `${temp}¬∞C`;
                    document.getElementById('weatherDesc').textContent = description.charAt(0).toUpperCase() + description.slice(1);
                    document.getElementById('humidityValue').textContent = `${humidity}%`;
                } else {
                    console.error('Erro ao buscar dados do clima:', data.message);
                    document.getElementById('tempValue').textContent = '--¬∞C';
                    document.getElementById('weatherDesc').textContent = 'Erro ao carregar';
                    document.getElementById('humidityValue').textContent = '--%';
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o da API do clima:', error);
                document.getElementById('tempValue').textContent = '--¬∞C';
                document.getElementById('weatherDesc').textContent = 'Erro de conex√£o';
                document.getElementById('humidityValue').textContent = '--%';
            }
        }


        // Atualizar display da localiza√ß√£o
        function updateLocationDisplay() {
            const locationText = `${userLocation.city}, ${userLocation.state}`;
            
            const loginLocationInfo = document.getElementById('locationInfo');
            const loginLocationText = document.getElementById('locationText');
            if (loginLocationInfo && loginLocationText) {
                loginLocationText.textContent = `üìç ${locationText}`;
                loginLocationInfo.style.display = 'block';
            }

            const locationDisplay = document.getElementById('locationDisplay');
            const dashboardLocation = document.getElementById('dashboardLocation');
            
            if (locationDisplay) {
                locationDisplay.textContent = locationText;
            }
            if (dashboardLocation) {
                dashboardLocation.textContent = locationText;
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            getUserLocation();
            
            // Verificar se h√° um usu√°rio logado na √∫ltima sess√£o
            const lastLoggedInUser = localStorage.getItem('lastLoggedInUser');
            if (lastLoggedInUser) {
                loadData(lastLoggedInUser);
                currentUser = {
                    name: lastLoggedInUser,
                    loginDate: new Date().toLocaleDateString('pt-BR'),
                    loginTime: new Date().toLocaleTimeString('pt-BR'),
                    location: userLocation
                };
                showMainApp();
            } else {
                showLoginPage();
            }
        });

        // Login
        function login(event) {
            event.preventDefault();
            const userName = document.getElementById('userName').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            
            if (userName.length < 2) {
                alert('Por favor, digite um nome com pelo menos 2 caracteres.');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Entrando...';

            setTimeout(() => {
                // Carregar ou inicializar dados para este usu√°rio
                loadData(userName);

                currentUser = {
                    name: userName,
                    loginDate: new Date().toLocaleDateString('pt-BR'),
                    loginTime: new Date().toLocaleTimeString('pt-BR'),
                    location: userLocation
                };

                // Salvar o nome do usu√°rio logado para a pr√≥xima sess√£o
                localStorage.setItem('lastLoggedInUser', userName);

                saveData();
                showMainApp();
                
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar no Sistema';
            }, 1000);
        }

        // Logout
        function logout() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                currentUser = null;
                localStorage.removeItem('lastLoggedInUser');
                document.getElementById('userName').value = '';
                showLoginPage();
            }
        }

        // Mostrar p√°gina de login
        function showLoginPage() {
            const loginPage = document.getElementById('loginPage');
            const mainApp = document.getElementById('mainApp');
            
            loginPage.style.display = 'flex';
            mainApp.classList.remove('active');
            mainApp.style.display = 'none';
            
            setTimeout(() => {
                document.getElementById('userName').focus();
            }, 100);
        }

        // Mostrar aplica√ß√£o principal
        function showMainApp() {
            const loginPage = document.getElementById('loginPage');
            const mainApp = document.getElementById('mainApp');
            
            loginPage.style.display = 'none';
            mainApp.style.display = 'block';
            mainApp.classList.add('active');
            
            updateUserInterface();
            updateCategorySelect();
            updateVaccinesContainer();
            updateCategoryFilter();
            updateDisplay();
        }

        // Atualizar interface do usu√°rio
        function updateUserInterface() {
            if (currentUser) {
                const firstName = currentUser.name.split(' ')[0];
                const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                document.getElementById('userDisplayName').textContent = firstName;
                document.getElementById('dashboardUserName').textContent = currentUser.name;
                document.getElementById('userAvatar').textContent = initials.substring(0, 2);
            }
        }

        // Navega√ß√£o entre abas
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach((tab) => {
                if (tab.onclick.toString().includes(tabId)) {
                    tab.classList.add('active');
                }
            });

            if (tabId === 'charts') {
                setTimeout(updateCharts, 100);
            }
        }

        // Adicionar categoria
        function addCategory() {
            const newCategory = document.getElementById('newCategory').value.trim();
            if (newCategory && !categories.includes(newCategory)) {
                categories.push(newCategory);
                document.getElementById('newCategory').value = '';
                updateCategorySelect();
                updateCategoryFilter();
                saveData();
                alert(`Categoria "${newCategory}" adicionada com sucesso!`);
            } else if (categories.includes(newCategory)) {
                alert('Esta categoria j√° existe!');
            }
        }

        // Adicionar vacina
        function addVaccine() {
            const newVaccine = document.getElementById('newVaccine').value.trim();
            if (newVaccine && !vaccines.includes(newVaccine)) {
                vaccines.push(newVaccine);
                document.getElementById('newVaccine').value = '';
                updateVaccinesContainer();
                saveData();
                alert(`Vacina "${newVaccine}" adicionada com sucesso!`);
            } else if (vaccines.includes(newVaccine)) {
                alert('Esta vacina j√° existe!');
            }
        }

        // Adicionar gado
        function addCattle() {
            const id = document.getElementById('cattleId').value.trim().toUpperCase();
            const birthDate = document.getElementById('cattleBirthDate').value;
            const weight = parseFloat(document.getElementById('cattleWeight').value);
            const category = document.getElementById('cattleCategory').value;
            
            if (!id) {
                alert('Por favor, digite uma identifica√ß√£o para o gado.');
                document.getElementById('cattleId').focus();
                return;
            }

            if (!birthDate) {
                alert('Por favor, selecione a data de nascimento.');
                document.getElementById('cattleBirthDate').focus();
                return;
            }

            if (!weight || weight <= 0) {
                alert('Por favor, digite um peso v√°lido.');
                document.getElementById('cattleWeight').focus();
                return;
            }

            if (!category) {
                alert('Por favor, selecione uma categoria.');
                document.getElementById('cattleCategory').focus();
                return;
            }
            
            if (cattle.some(animal => animal.id === id)) {
                alert('J√° existe um animal com esta identifica√ß√£o!');
                document.getElementById('cattleId').focus();
                return;
            }
            
            const selectedVaccines = [];
            document.querySelectorAll('input[name="vaccine"]:checked').forEach(checkbox => {
                selectedVaccines.push(checkbox.value);
            });

            const newAnimal = {
                id: id,
                birthDate: birthDate,
                weight: weight,
                category: category,
                vaccines: selectedVaccines,
                addedDate: new Date().toLocaleDateString('pt-BR'),
                addedTime: new Date().toLocaleTimeString('pt-BR'),
                addedBy: currentUser.name
            };

            cattle.push(newAnimal);
            
            document.getElementById('cattleId').value = '';
            document.getElementById('cattleBirthDate').value = '';
            document.getElementById('cattleWeight').value = '';
            document.getElementById('cattleCategory').value = '';
            document.querySelectorAll('input[name="vaccine"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            saveData();
            updateDisplay();
            alert(`Gado ${id} cadastrado com sucesso!`);
            
            document.getElementById('cattleId').focus();
        }

        // Atualizar select de categorias
        function updateCategorySelect() {
            const select = document.getElementById('cattleCategory');
            const currentValue = select.value;
            select.innerHTML = '<option value="">Selecione uma categoria</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
            select.value = currentValue;
        }

        // Atualizar container de vacinas
        function updateVaccinesContainer() {
            const container = document.getElementById('vaccinesContainer');
            container.innerHTML = '';
            vaccines.forEach(vaccine => {
                const label = document.createElement('label');
                label.className = 'vaccine-checkbox';
                label.innerHTML = `
                    <input type="checkbox" name="vaccine" value="${vaccine}">
                    <span>${vaccine}</span>
                `;
                container.appendChild(label);
            });
        }

        // Atualizar filtro de categorias
        function updateCategoryFilter() {
            const filter = document.getElementById('categoryFilter');
            const currentValue = filter.value;
            filter.innerHTML = '<option value="all">Todas as categorias</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filter.appendChild(option);
            });
            filter.value = currentValue;
        }

        // Filtrar gado
        function filterCattle() {
            const searchTerm = document.getElementById('searchTerm').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            const filteredCattle = cattle.filter(animal => {
                const matchesSearch = animal.id.toLowerCase().includes(searchTerm);
                const matchesCategory = categoryFilter === 'all' || animal.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            updateCattleTable(filteredCattle);
        }

        // Atualizar tabela de gado
        function updateCattleTable(cattleList = cattle) {
            const tbody = document.getElementById('cattleTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (cattleList.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                emptyState.textContent = cattle.length === 0 ? 'Nenhum gado cadastrado ainda.' : 'Nenhum resultado encontrado.';
            } else {
                emptyState.style.display = 'none';
                tbody.innerHTML = cattleList.map(animal => `
                    <tr>
                        <td><strong>${animal.id}</strong></td>
                        <td>${animal.birthDate}</td>
                        <td>${animal.weight} kg</td>
                        <td><span class="badge badge-category">${animal.category}</span></td>
                        <td>
                            ${animal.vaccines.length > 0 ? 
                                animal.vaccines.map(vaccine => 
                                    `<span class="badge badge-vaccine">${vaccine}</span>`
                                ).join('') 
                                : '<span style="color: #6b7280;">Nenhuma</span>'
                            }
                        </td>
                        <td>${animal.addedDate}</td>
                    </tr>
                `).join('');
            }
        }

        // Atualizar gr√°ficos
        function updateCharts() {
            updateCategoryChart();
            updateVaccineChart();
            updateStats();
        }

        // Gr√°fico de categorias
        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const categoryData = categories.map(category => ({
                name: category,
                count: cattle.filter(animal => animal.category === category).length
            })).filter(item => item.count > 0);

            const emptyState = document.getElementById('categoryEmpty');
            const canvas = document.getElementById('categoryChart');

            if (categoryData.length === 0) {
                emptyState.style.display = 'block';
                canvas.style.display = 'none';
                if (categoryChart) {
                    categoryChart.destroy();
                    categoryChart = null;
                }
                return;
            }

            emptyState.style.display = 'none';
            canvas.style.display = 'block';

            if (categoryChart) {
                categoryChart.destroy();
            }

            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384'];

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categoryData.map(item => item.name),
                    datasets: [{
                        data: categoryData.map(item => item.count),
                        backgroundColor: colors.slice(0, categoryData.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico de vacinas
        function updateVaccineChart() {
            const ctx = document.getElementById('vaccineChart').getContext('2d');
            const vaccineData = vaccines.map(vaccine => ({
                name: vaccine,
                count: cattle.filter(animal => animal.vaccines.includes(vaccine)).length
            })).filter(item => item.count > 0);

            const emptyState = document.getElementById('vaccineEmpty');
            const canvas = document.getElementById('vaccineChart');

            if (vaccineData.length === 0) {
                emptyState.style.display = 'block';
                canvas.style.display = 'none';
                if (vaccineChart) {
                    vaccineChart.destroy();
                    vaccineChart = null;
                }
                return;
            }

            emptyState.style.display = 'none';
            canvas.style.display = 'block';

            if (vaccineChart) {
                vaccineChart.destroy();
            }

            vaccineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: vaccineData.map(item => item.name),
                    datasets: [{
                        label: 'Animais Vacinados',
                        data: vaccineData.map(item => item.count),
                        backgroundColor: '#36A2EB',
                        borderColor: '#1E88E5',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = cattle.length;
                                    const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                                    return `${context.raw} animais (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const statsSection = document.getElementById('statsSection');
            
            if (cattle.length > 0) {
                statsSection.style.display = 'block';
                
                const avgWeight = cattle.reduce((sum, animal) => sum + animal.weight, 0) / cattle.length;
                const usedCategories = [...new Set(cattle.map(animal => animal.category))].length;
                const usedVaccines = [...new Set(cattle.flatMap(animal => animal.vaccines))].length;
                
                document.getElementById('statTotal').textContent = cattle.length;
                document.getElementById('statCategories').textContent = usedCategories;
                document.getElementById('statVaccines').textContent = usedVaccines;
                document.getElementById('statAvgWeight').textContent = Math.round(avgWeight);
            } else {
                statsSection.style.display = 'none';
            }
        }

        // Atualizar resumo r√°pido do dashboard
        function updateQuickSummary() {
            const quickSummary = document.getElementById('quickSummary');
            
            if (cattle.length > 0) {
                quickSummary.style.display = 'block';
                
                const avgWeight = cattle.reduce((sum, animal) => sum + animal.weight, 0) / cattle.length;
                const categoryCount = {};
                cattle.forEach(animal => {
                    categoryCount[animal.category] = (categoryCount[animal.category] || 0) + 1;
                });
                
                const commonCategory = Object.keys(categoryCount).reduce((a, b) => 
                    categoryCount[a] > categoryCount[b] ? a : b, '');
                
                const lastAnimal = cattle[cattle.length - 1];
                
                document.getElementById('avgWeight').textContent = avgWeight.toFixed(1) + ' kg';
                document.getElementById('commonCategory').textContent = commonCategory || '-';
                document.getElementById('lastAdded').textContent = lastAnimal ? lastAnimal.addedDate : '-';
            } else {
                quickSummary.style.display = 'none';
            }
        }

        // Atualizar toda a interface
        function updateDisplay() {
            document.getElementById('totalCattle').textContent = cattle.length;
            document.getElementById('cattleCount').textContent = cattle.length;
            
            updateCattleTable();
            updateCategoryFilter();
            updateQuickSummary();
            
            if (document.getElementById('charts').classList.contains('active')) {
                updateCharts();
            }
        }

        // Teclas de atalho
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const activeElement = document.activeElement;
                
                if (activeElement && activeElement.id === 'userName') {
                    const form = activeElement.closest('form');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
                
                if (activeElement && activeElement.id === 'newCategory') {
                    addCategory();
                }
                
                if (activeElement && activeElement.id === 'newVaccine') {
                    addVaccine();
                }
            }
        });

        // Adicionar dados de exemplo (opcional)
        function addSampleData() {
            if (cattle.length === 0) {
                const sampleCattle = [
                    {
                        id: 'BOV001',
                        birthDate: '2023-01-15',
                        weight: 450,
                        category: 'Vaca',
                        vaccines: ['Febre Aftosa', 'Brucelose'],
                        addedDate: new Date().toLocaleDateString('pt-BR'),
                        addedTime: new Date().toLocaleTimeString('pt-BR'),
                        addedBy: currentUser?.name || 'Sistema'
                    },
                    {
                        id: 'BOV002',
                        birthDate: '2024-03-22',
                        weight: 380,
                        category: 'Novilho',
                        vaccines: ['Febre Aftosa', 'Raiva'],
                        addedDate: new Date().toLocaleDateString('pt-BR'),
                        addedTime: new Date().toLocaleTimeString('pt-BR'),
                        addedBy: currentUser?.name || 'Sistema'
                    },
                    {
                        id: 'BOV003',
                        birthDate: '2022-08-10',
                        weight: 520,
                        category: 'Touro',
                        vaccines: ['Febre Aftosa', 'Brucelose', 'IBR'],
                        addedDate: new Date().toLocaleDateString('pt-BR'),
                        addedTime: new Date().toLocaleTimeString('pt-BR'),
                        addedBy: currentUser?.name || 'Sistema'
                    }
                ];
                
                cattle.push(...sampleCattle);
                saveData();
                updateDisplay();
                console.log('Dados de exemplo adicionados');
            }
        }
        
        // Adicionar dados de exemplo se o usu√°rio for novo e n√£o tiver dados
        document.addEventListener('DOMContentLoaded', () => {
            const lastLoggedInUser = localStorage.getItem('lastLoggedInUser');
            if (lastLoggedInUser) {
                loadData(lastLoggedInUser);
            }
            if (cattle.length === 0) {
                addSampleData();
            }
        });
    </script>
</body>

</html>
