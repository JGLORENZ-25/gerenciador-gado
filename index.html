<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Gado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f9f0 0%, #e6f3ff 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Estilos das p√°ginas de autentica√ß√£o */
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
        }

        .login-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .login-title {
            font-size: 2.5rem;
            color: #2d5a3d;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .login-subtitle {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .location-info {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #1e40af;
        }

        .login-form {
            margin-bottom: 20px;
        }

        .login-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1.1rem;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .login-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            transform: translateY(-2px);
        }

        .login-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-register {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            margin-top: 10px;
        }

        .btn-register:hover:not(:disabled) {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
            gap: 10px;
        }

        .link-btn {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            transition: color 0.3s ease;
        }

        .link-btn:hover {
            color: #1d4ed8;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: center;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: center;
        }

        .login-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e5e7eb;
        }

        .login-feature {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            transition: transform 0.3s ease;
        }

        .login-feature:hover {
            transform: translateY(-3px);
        }

        .login-feature-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .login-feature-text {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Estilos da aplica√ß√£o principal */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d5a3d;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        h1 {
            text-align: center;
            color: #2d5a3d;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            padding: 20px;
            border-radius: 12px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-card.user { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .dashboard-card.temp { background: linear-gradient(135deg, #f97316, #ea580c); }
        .dashboard-card.humidity { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .dashboard-card.cattle { background: linear-gradient(135deg, #10b981, #059669); }

        .dashboard-card .icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .dashboard-card h3 {
            margin: 0;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 4px 0;
        }

        .dashboard-card .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Pinboard Layout */
        .pinboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .pinboard-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .pinboard-card.large {
            grid-column: span 2;
        }

        .pinboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f9f0;
        }

        .pinboard-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2d5a3d;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pinboard-body {
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
        }

        /* Grupos */
        .group-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #10b981;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .group-item:hover {
            background: #f0f9f0;
            transform: translateX(5px);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .group-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2d5a3d;
        }

        .group-count {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .group-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .group-info-item {
            display: flex;
            flex-direction: column;
        }

        .group-info-label {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .group-info-value {
            font-weight: 600;
            color: #374151;
        }

        .profit-positive {
            color: #10b981;
        }

        .profit-negative {
            color: #ef4444;
        }

        /* Financeiro */
        .financial-summary {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .financial-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .financial-label {
            font-weight: 500;
            color: #6b7280;
        }

        .financial-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Formul√°rios */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group input,
        .input-group select {
            flex: 1;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
        }

        /* Bot√µes */
        .btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: #6366f1;
        }

        .btn-secondary:hover {
            background: #4f46e5;
        }
        
        .btn-warning {
            background: #f59e0b;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }

        .btn-delete {
            background: #ef4444;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Tabelas */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        .compact-table {
            width: 100%;
            font-size: 0.9rem;
        }

        .compact-table th,
        .compact-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .compact-table th {
            background-color: #f0f9f0;
            font-weight: 600;
            color: #2d5a3d;
        }

        .compact-table tr:hover {
            background-color: #f9fafb;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background-color: #f0f9f0;
            font-weight: 600;
            color: #2d5a3d;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
        }

        .badge-category {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .badge-number {
            background-color: #d1fae5;
            color: #065f46;
        }

        /* Estados vazios */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            margin: 20px auto;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .modal-close:hover {
            color: #555;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .pinboard-card.large {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .login-container {
                padding: 30px 20px;
            }

            .login-title {
                font-size: 2rem;
            }

            h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .pinboard-container {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .auth-footer {
                flex-direction: column;
                text-align: center;
            }

            .form-row {
                flex-direction: column;
            }

            .financial-grid {
                grid-template-columns: 1fr;
            }

            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="initialPage" class="login-page">
        <div class="login-container">
            <div class="login-logo">üêÑ</div>
            <h1 class="login-title">Bem-vindo!</h1>
            <p class="login-subtitle">Sistema de Gerenciamento de Gado</p>
            
            <div id="locationInfo" class="location-info" style="display: none;">
                <div id="locationText">üìç Detectando localiza√ß√£o...</div>
            </div>
            
            <div class="auth-buttons">
                <button class="login-btn" onclick="showLoginForm()">
                    üîë Fazer Login
                </button>
                <button class="login-btn btn-register" onclick="showRegisterForm()">
                    üìù Registrar-se
                </button>
            </div>

            <div class="login-features">
                <div class="login-feature">
                    <span class="login-feature-icon">üìä</span>
                    <div class="login-feature-text">Relat√≥rios</div>
                </div>
                <div class="login-feature">
                    <span class="login-feature-icon">üêÑ</span>
                    <div class="login-feature-text">Gest√£o</div>
                </div>
                <div class="login-feature">
                    <span class="login-feature-icon">üí∞</span>
                    <div class="login-feature-text">Financeiro</div>
                </div>
                <div class="login-feature">
                    <span class="login-feature-icon">üìà</span>
                    <div class="login-feature-text">An√°lises</div>
                </div>
            </div>
        </div>
    </div>

    <div id="loginPage" class="login-page" style="display: none;">
        <div class="login-container">
            <div class="login-logo">üîë</div>
            <h1 class="login-title">Login</h1>
            <p class="login-subtitle">Entre em sua conta</p>
            
            <form class="login-form" onsubmit="login(event)">
                <input 
                    type="text" 
                    id="loginUserName" 
                    class="login-input" 
                    placeholder="Digite seu nome de usu√°rio..." 
                    required 
                    maxlength="50"
                    autocomplete="username"
                >
                <input 
                    type="password" 
                    id="loginPassword" 
                    class="login-input" 
                    placeholder="Digite sua senha..." 
                    required 
                    autocomplete="current-password"
                >
                <button type="submit" class="login-btn" id="loginBtn">
                    Entrar
                </button>
            </form>

            <div class="auth-footer">
                <button class="link-btn" onclick="showInitialPage()">
                    ‚Üê Voltar
                </button>
                <button class="link-btn" onclick="showRegisterForm()">
                    N√£o tem conta? Registre-se
                </button>
            </div>
        </div>
    </div>

    <div id="registerPage" class="login-page" style="display: none;">
        <div class="login-container">
            <div class="login-logo">üìù</div>
            <h1 class="login-title">Registrar</h1>
            <p class="login-subtitle">Crie sua nova conta</p>
            
            <form class="login-form" onsubmit="register(event)">
                <input 
                    type="text" 
                    id="registerUserName" 
                    class="login-input" 
                    placeholder="Digite seu nome de usu√°rio..." 
                    required 
                    maxlength="50"
                    autocomplete="username"
                >
                <input 
                    type="text" 
                    id="registerFullName" 
                    class="login-input" 
                    placeholder="Digite seu nome completo..." 
                    required 
                    maxlength="100"
                    autocomplete="name"
                >
                <input 
                    type="password" 
                    id="registerPassword" 
                    class="login-input" 
                    placeholder="Crie uma senha..." 
                    required 
                    minlength="6"
                    autocomplete="new-password"
                >
                <input 
                    type="password" 
                    id="confirmPassword" 
                    class="login-input" 
                    placeholder="Confirme sua senha..." 
                    required 
                    minlength="6"
                    autocomplete="new-password"
                >
                <button type="submit" class="login-btn" id="registerBtn">
                    Criar Conta
                </button>
            </form>

            <div class="auth-footer">
                <button class="link-btn" onclick="showInitialPage()">
                    ‚Üê Voltar
                </button>
                <button class="link-btn" onclick="showLoginForm()">
                    J√° tem conta? Fa√ßa login
                </button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="main-app">
        <div class="container">
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">J</div>
                    <div>
                        <div><strong>Ol√°, <span id="userDisplayName">Usu√°rio</span>!</strong></div>
                        <div style="color: #6b7280; font-size: 0.9rem;" id="userLocation">
                            üìç <span id="locationDisplay">Carregando localiza√ß√£o...</span>
                        </div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    üö™ Sair
                </button>
            </div>

            <h1>Sistema de Gerenciamento de Gado</h1>

            <div class="card">
                <div class="dashboard-grid">
                    <div class="dashboard-card user">
                        <div>
                            <h3>Usu√°rio</h3>
                            <div class="value" id="dashboardUserName">Usu√°rio</div>
                            <div class="subtitle" id="dashboardLocation">Carregando...</div>
                        </div>
                        <div class="icon">üë§</div>
                    </div>
                    
                    <div class="dashboard-card temp">
                        <div>
                            <h3>Temperatura</h3>
                            <div class="value" id="tempValue">--¬∞C</div>
                            <div class="subtitle" id="weatherDesc">Carregando...</div>
                        </div>
                        <div class="icon">üå°Ô∏è</div>
                    </div>
                    
                    <div class="dashboard-card humidity">
                        <div>
                            <h3>Umidade</h3>
                            <div class="value" id="humidityValue">--%</div>
                            <div class="subtitle">Condi√ß√£o atual</div>
                        </div>
                        <div class="icon">üíß</div>
                    </div>
                    
                    <div class="dashboard-card cattle">
                        <div>
                            <h3>Total de Grupos</h3>
                            <div class="value" id="totalGroups">0</div>
                            <div class="subtitle">Grupos cadastrados</div>
                        </div>
                        <div class="icon">üêÑ</div>
                    </div>
                </div>
            </div>

            <div class="pinboard-container">
                <div class="pinboard-card">
                    <div class="pinboard-header">
                        <div class="pinboard-title">üêÑ Grupos de Gado</div>
                        <button class="btn btn-small" onclick="openModal('addGroupModal')">‚ûï Novo Grupo</button>
                    </div>
                    <div class="pinboard-body" id="groupsList">
                        <div class="empty-state">Nenhum grupo cadastrado.</div>
                    </div>
                </div>

                <div class="pinboard-card">
                    <div class="pinboard-header">
                        <div class="pinboard-title">üì¶ Estoque</div>
                        <button class="btn btn-small" onclick="openModal('addProductModal')">‚ûï Adicionar</button>
                    </div>
                    <div class="pinboard-body">
                        <div class="table-container">
                            <table class="compact-table">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Qtd</th>
                                    </tr>
                                </thead>
                                <tbody id="stockTableBody">
                                </tbody>
                            </table>
                            <div id="emptyStockState" class="empty-state">
                                Nenhum produto em estoque.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pinboard-card large">
                    <div class="pinboard-header">
                        <div class="pinboard-title">üí∞ Resumo Financeiro</div>
                    </div>
                    <div class="pinboard-body">
                        <div class="financial-grid">
                            <div class="financial-item">
                                <span class="financial-label">Investimento em Gado</span>
                                <span class="financial-value" style="color: #ef4444;" id="totalInvestment">R$ 0,00</span>
                            </div>
                            <div class="financial-item">
                                <span class="financial-label">Despesas Totais</span>
                                <span class="financial-value" style="color: #f59e0b;" id="totalSupplies">R$ 0,00</span>
                            </div>
                            <div class="financial-item">
                                <span class="financial-label">Receita Estimada</span>
                                <span class="financial-value" style="color: #10b981;" id="totalRevenue">R$ 0,00</span>
                            </div>
                            <div class="financial-item">
                                <span class="financial-label">Lucro/Preju√≠zo</span>
                                <span class="financial-value profit-positive" id="totalProfit">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pinboard-card">
                    <div class="pinboard-header">
                        <div class="pinboard-title">üí∏ Gastos Recentes</div>
                        <button class="btn btn-small" onclick="openModal('addExpenseModal')">‚ûï Registrar</button>
                    </div>
                    <div class="pinboard-body">
                        <div class="table-container">
                            <table class="compact-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody id="expensesTableBody">
                                </tbody>
                            </table>
                            <div id="emptyExpensesState" class="empty-state">
                                Nenhum gasto registrado.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addGroupModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addGroupModal')">&times;</span>
            <h2>‚ûï Novo Grupo de Gado</h2>
            <div class="form-group">
                <label>Nome do Grupo</label>
                <input type="text" id="groupName" placeholder="Ex: Lote Janeiro 2025">
            </div>
            <div class="form-group">
                <label>Quantidade de Animais</label>
                <input type="number" id="groupQuantity" placeholder="0" min="1">
            </div>
            <div class="form-group">
                <label>Peso M√©dio por Animal (kg)</label>
                <input type="number" id="groupAvgWeight" placeholder="0">
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="groupCategory">
                    <option value="Bezerro">Bezerro</option>
                    <option value="Novilho">Novilho</option>
                    <option value="Vaca">Vaca</option>
                    <option value="Touro">Touro</option>
                    <option value="Garrote">Garrote</option>
                </select>
            </div>
            <div class="form-group">
                <label>Custo por Animal (R$)</label>
                <input type="number" id="groupCostPerAnimal" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>ou Custo Total do Grupo (R$)</label>
                <input type="number" id="groupTotalCost" placeholder="0.00" step="0.01">
            </div>
            <button class="btn" onclick="addGroup()" style="width: 100%; margin-top: 20px;">
                Criar Grupo
            </button>
        </div>
    </div>

    <div id="editGroupModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('editGroupModal')">&times;</span>
            <h2>‚úèÔ∏è Editar Dados do Grupo</h2>
            <div class="form-group">
                <label>Nome do Grupo</label>
                <input type="text" id="editGroupName">
            </div>
            <div class="form-group">
                <label>Quantidade de Animais</label>
                <input type="number" id="editGroupQuantity" min="1">
            </div>
            <div class="form-group">
                <label>Peso M√©dio por Animal (kg)</label>
                <input type="number" id="editGroupAvgWeight">
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="editGroupCategory">
                    <option value="Bezerro">Bezerro</option>
                    <option value="Novilho">Novilho</option>
                    <option value="Vaca">Vaca</option>
                    <option value="Touro">Touro</option>
                    <option value="Garrote">Garrote</option>
                </select>
            </div>
            <div class="form-group">
                <label>Custo Inicial Total (R$)</label>
                <input type="number" id="editGroupTotalCost" step="0.01">
            </div>
            <button class="btn btn-warning" onclick="saveGroupEdit()" style="width: 100%; margin-top: 20px;">
                Salvar Altera√ß√µes
            </button>
        </div>
    </div>

    <div id="groupDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="modal-close" onclick="closeModal('groupDetailsModal')">&times;</span>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="groupDetailsTitle" style="margin:0;">üìä Detalhes do Grupo</h2>
                <button class="btn btn-warning btn-small" onclick="openEditGroupModal()">‚úèÔ∏è Editar Grupo</button>
            </div>
            
            <div id="groupDetailsContent"></div>
            
            <div style="margin-top: 20px;">
                <h3>üåæ Aplicar Produto do Estoque</h3>
                <div class="input-group">
                    <select id="supplyProductSelect" style="flex: 1; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px;">
                        <option value="">Selecione um produto...</option>
                    </select>
                    <input type="number" id="supplyQuantityUsed" placeholder="Quantidade" step="0.01" style="width: 150px;">
                    <input type="date" id="supplyDate" style="width: 150px;">
                    <button class="btn btn-small" onclick="addSupplyExpense()">Aplicar</button>
                </div>
                <div id="stockWarning" style="display: none; color: #ef4444; font-size: 0.9rem; margin-top: 5px;">
                    ‚ö†Ô∏è Produto n√£o dispon√≠vel em estoque suficiente
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h3>üíµ Definir Receita (Venda)</h3>
                <div class="input-group">
                    <input type="number" id="revenueAmount" placeholder="Valor Total da Venda (R$)" step="0.01">
                    <button class="btn btn-secondary btn-small" onclick="setRevenue()">Salvar Receita</button>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-delete" onclick="deleteGroup()">üóëÔ∏è Excluir Grupo</button>
                <button class="btn btn-secondary" onclick="closeModal('groupDetailsModal')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addProductModal')">&times;</span>
            <h2>üì¶ Adicionar Produto ao Estoque</h2>
            <div class="form-group">
                <label>Nome do Produto</label>
                <input type="text" id="productName" placeholder="Ex: Ra√ß√£o, Sal Mineral">
            </div>
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <input type="text" id="productDescription" placeholder="Detalhes do produto">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="productQuantity" placeholder="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Unidade</label>
                    <select id="productUnit">
                        <option value="kg">kg</option>
                        <option value="litros">Litros</option>
                        <option value="unidades">Unidades</option>
                        <option value="sacas">Sacas</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Valor Total (R$)</label>
                <input type="number" id="productValue" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>Tipo de Transa√ß√£o</label>
                <select id="productTransactionType">
                    <option value="compra">Compra (Adicionar ao Estoque)</option>
                    <option value="venda">Venda (Remover do Estoque)</option>
                </select>
            </div>
            <button class="btn" onclick="addProduct()" style="width: 100%; margin-top: 20px;">
                Processar Transa√ß√£o
            </button>
        </div>
    </div>

    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('addExpenseModal')">&times;</span>
            <h2>üí∏ Registrar Gasto</h2>
            <div class="form-group">
                <label>Data do Gasto</label>
                <input type="date" id="expenseDate">
            </div>
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <input type="text" id="expenseDescription" placeholder="Ex: Veterin√°rio, Manuten√ß√£o">
            </div>
            <div class="form-group">
                <label>Valor (R$)</label>
                <input type="number" id="expenseAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <input type="text" id="expenseCategory" placeholder="Ex: Sa√∫de, Manuten√ß√£o">
            </div>
            <button class="btn" onclick="addExpense()" style="width: 100%; margin-top: 20px;">
                Registrar Gasto
            </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDyKezs7gqjE9HUw_HjUMqA7ofxc5Sp9Bc",
            authDomain: "meu-gado-site.firebaseapp.com",
            projectId: "meu-gado-site",
            storageBucket: "meu-gado-site.firebasestorage.app",
            messagingSenderId: "913921456792",
            appId: "1:913921456792:web:5f1ccdbf20d423ee822eed",
            measurementId: "G-MYK82JG8E2"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Dados globais
        let currentUser = null;
        let cattleGroups = [];
        let stock = [];
        let expenses = [];
        let userLocation = { city: '', state: '', country: '', lat: null, lon: null };
        let currentGroupId = null;
        
        // Chave API OpenWeatherMap
        const OPENWEATHER_API_KEY = '6b78a94becfdff74b732c9bd59a89b1f';
        
        const LAST_USER_KEY = 'lastLoggedInUser';
        const AUTO_LOGIN_KEY = 'autoLoginToken';

        // Sistema de armazenamento usando Firebase Firestore
        async function saveData() {
            if (!currentUser) return;

            const userRef = db.collection('users').doc(currentUser.id);

            const userData = {
                cattleGroups: cattleGroups,
                stock: stock,
                expenses: expenses,
                location: userLocation,
                loginDate: currentUser.loginDate,
                loginTime: currentUser.loginTime,
                fullName: currentUser.fullName,
                lastLogin: new Date().toISOString()
            };

            try {
                await userRef.set(userData, { merge: true });
                console.log('Dados do usu√°rio salvos no Firebase!');
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
            }
        }

        // Carregar dados do Firebase Firestore
        async function loadData(userId) {
            const userRef = db.collection('users').doc(userId);

            try {
                const doc = await userRef.get();
                if (doc.exists) {
                    const userData = doc.data();
                    cattleGroups = userData.cattleGroups || [];
                    stock = userData.stock || [];
                    expenses = userData.expenses || [];
                    userLocation = userData.location || { city: 'Carregando...', state: 'Carregando...', country: 'Carregando...' };
                    console.log('Dados do usu√°rio carregados do Firebase!');
                    return userData;
                } else {
                    cattleGroups = [];
                    stock = [];
                    expenses = [];
                    userLocation = { city: 'Carregando...', state: 'Carregando...', country: 'Carregando...' };
                    console.log('Novo usu√°rio, dados inicializados.');
                    return null;
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                return null;
            }
        }

        // Registrar novo usu√°rio
        async function registerUser(userName, fullName, password) {
            const userId = userName.trim().toLowerCase().replace(/[^a-z0-9_]/g, '_');
            const authRef = db.collection('auth').doc(userId);
            const userRef = db.collection('users').doc(userId);

            try {
                const authDoc = await authRef.get();
                if (authDoc.exists) {
                    throw new Error('Nome de usu√°rio j√° existe!');
                }

                const passwordHash = btoa(password + userId);

                await authRef.set({
                    userName: userName.trim(),
                    fullName: fullName.trim(),
                    passwordHash: passwordHash,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });

                await userRef.set({
                    cattleGroups: [],
                    stock: [],
                    expenses: [],
                    location: userLocation,
                    fullName: fullName.trim(),
                    createdAt: new Date().toISOString()
                });

                return { success: true, userId: userId };
            } catch (error) {
                console.error('Erro ao registrar usu√°rio:', error);
                return { success: false, error: error.message };
            }
        }

        // Verificar credenciais do usu√°rio
        async function verifyUser(userName, password) {
            const userId = userName.trim().toLowerCase().replace(/[^a-z0-9_]/g, '_');
            const authRef = db.collection('auth').doc(userId);

            try {
                const authDoc = await authRef.get();
                if (!authDoc.exists) {
                    throw new Error('Usu√°rio n√£o encontrado!');
                }

                const authData = authDoc.data();
                const passwordHash = btoa(password + userId);

                if (authData.passwordHash !== passwordHash) {
                    throw new Error('Senha incorreta!');
                }

                await authRef.update({
                    lastLogin: new Date().toISOString()
                });

                return { 
                    success: true, 
                    userId: userId,
                    fullName: authData.fullName,
                    userName: authData.userName
                };
            } catch (error) {
                console.error('Erro na verifica√ß√£o:', error);
                return { success: false, error: error.message };
            }
        }

        // Geolocaliza√ß√£o
        async function getUserLocation() {
            try {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            try {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                await getLocationFromCoords(lat, lon);
                                await getRealWeatherData(lat, lon);
                            } catch (error) {
                                console.log('Erro ao obter localiza√ß√£o:', error);
                                setDefaultLocation();
                            }
                        },
                        (error) => {
                            console.log('Geolocaliza√ß√£o negada ou erro:', error);
                            setDefaultLocation();
                        },
                        {
                            timeout: 10000,
                            maximumAge: 300000
                        }
                    );
                } else {
                    setDefaultLocation();
                }
            } catch (error) {
                console.log('Erro geral de localiza√ß√£o:', error);
                setDefaultLocation();
            }
        }

        async function getLocationFromCoords(lat, lon) {
            try {
                const apiUrl = `https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${OPENWEATHER_API_KEY}`;
                
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (response.ok && data.length > 0) {
                    const locationData = data[0];
                    userLocation.city = locationData.name || 'Localiza√ß√£o Desconhecida';
                    userLocation.state = locationData.state || 'Regi√£o Desconhecida';
                    userLocation.country = locationData.country || 'Pa√≠s Desconhecido';
                    userLocation.lat = lat;
                    userLocation.lon = lon;
                    updateLocationDisplay();
                } else {
                    console.error('Erro ao buscar nome da localiza√ß√£o:', data);
                    setDefaultLocation();
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o da API de geocodifica√ß√£o:', error);
                setDefaultLocation();
            }
        }

        async function setDefaultLocation() {
            userLocation = {
                city: 'Candel√°ria',
                state: 'Rio Grande do Sul',
                country: 'Brasil',
                lat: -29.67,
                lon: -52.41
            };
            updateLocationDisplay();
            await getRealWeatherData(userLocation.lat, userLocation.lon);
        }

        async function getRealWeatherData(lat, lon) {
            if (OPENWEATHER_API_KEY === '' || OPENWEATHER_API_KEY === 'SUA_CHAVE_DE_API_AQUI') {
                document.getElementById('tempValue').textContent = '--¬∞C';
                document.getElementById('weatherDesc').textContent = 'API Key necess√°ria';
                document.getElementById('humidityValue').textContent = '--%';
                console.warn('Por favor, insira sua chave de API do OpenWeatherMap.');
                return;
            }

            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=pt_br`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (response.ok) {
                    const temp = data.main.temp.toFixed(1);
                    const humidity = data.main.humidity;
                    const description = data.weather[0].description;

                    document.getElementById('tempValue').textContent = `${temp}¬∞C`;
                    document.getElementById('weatherDesc').textContent = description.charAt(0).toUpperCase() + description.slice(1);
                    document.getElementById('humidityValue').textContent = `${humidity}%`;
                } else {
                    console.error('Erro ao buscar dados do clima:', data.message);
                    document.getElementById('tempValue').textContent = '--¬∞C';
                    document.getElementById('weatherDesc').textContent = 'Erro ao carregar';
                    document.getElementById('humidityValue').textContent = '--%';
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o da API do clima:', error);
                document.getElementById('tempValue').textContent = '--¬∞C';
                document.getElementById('weatherDesc').textContent = 'Erro de conex√£o';
                document.getElementById('humidityValue').textContent = '--%';
            }
        }

        function updateLocationDisplay() {
            const locationText = `${userLocation.city}, ${userLocation.state}`;
            
            const loginLocationInfo = document.getElementById('locationInfo');
            const loginLocationText = document.getElementById('locationText');
            if (loginLocationInfo && loginLocationText) {
                loginLocationText.textContent = `üìç ${locationText}`;
                loginLocationInfo.style.display = 'block';
            }

            const locationDisplay = document.getElementById('locationDisplay');
            const dashboardLocation = document.getElementById('dashboardLocation');
            
            if (locationDisplay) {
                locationDisplay.textContent = locationText;
            }
            if (dashboardLocation) {
                dashboardLocation.textContent = locationText;
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            getUserLocation();
            
            const autoLoginToken = localStorage.getItem(AUTO_LOGIN_KEY);
            if (autoLoginToken) {
                try {
                    const tokenData = JSON.parse(autoLoginToken);
                    const result = await verifyUser(tokenData.userName, tokenData.password);
                    
                    if (result.success) {
                        await loginUser(result);
                        return;
                    } else {
                        localStorage.removeItem(AUTO_LOGIN_KEY);
                    }
                } catch (error) {
                    console.error('Erro no login autom√°tico:', error);
                    localStorage.removeItem(AUTO_LOGIN_KEY);
                }
            }
            
            showInitialPage();
        });

        function showInitialPage() {
            hideAllPages();
            document.getElementById('initialPage').style.display = 'flex';
        }

        function showLoginForm() {
            hideAllPages();
            document.getElementById('loginPage').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('loginUserName').focus();
            }, 100);
        }

        function showRegisterForm() {
            hideAllPages();
            document.getElementById('registerPage').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('registerUserName').focus();
            }, 100);
        }

        function hideAllPages() {
            document.getElementById('initialPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'none';
        }

        function showMessage(containerId, message, isError = true) {
            const container = document.querySelector(`#${containerId} .login-form`);
            
            const existingMessage = container.querySelector('.error-message, .success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = isError ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            container.insertBefore(messageDiv, container.firstChild);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        async function register(event) {
            event.preventDefault();
            
            const userName = document.getElementById('registerUserName').value.trim();
            const fullName = document.getElementById('registerFullName').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const registerBtn = document.getElementById('registerBtn');
            
            if (userName.length < 3) {
                showMessage('registerPage', 'Nome de usu√°rio deve ter pelo menos 3 caracteres.');
                return;
            }
            
            if (!/^[a-zA-Z0-9_]+$/.test(userName)) {
                showMessage('registerPage', 'Nome de usu√°rio deve conter apenas letras, n√∫meros e underscore.');
                return;
            }
            
            if (fullName.length < 2) {
                showMessage('registerPage', 'Nome completo deve ter pelo menos 2 caracteres.');
                return;
            }
            
            if (password.length < 6) {
                showMessage('registerPage', 'Senha deve ter pelo menos 6 caracteres.');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('registerPage', 'As senhas n√£o coincidem.');
                return;
            }
            
            registerBtn.disabled = true;
            registerBtn.textContent = 'Criando conta...';
            
            try {
                const result = await registerUser(userName, fullName, password);
                
                if (result.success) {
                    showMessage('registerPage', 'Conta criada com sucesso! Redirecionando...', false);
                    
                    setTimeout(() => {
                        const userData = {
                            success: true,
                            userId: result.userId,
                            fullName: fullName,
                            userName: userName
                        };
                        loginUser(userData, userName, password);
                    }, 1500);
                } else {
                    showMessage('registerPage', result.error);
                }
            } catch (error) {
                showMessage('registerPage', 'Erro interno. Tente novamente.');
                console.error('Erro no registro:', error);
            }
            
            registerBtn.disabled = false;
            registerBtn.textContent = 'Criar Conta';
        }

        async function login(event) {
            event.preventDefault();
            
            const userName = document.getElementById('loginUserName').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (userName.length < 3) {
                showMessage('loginPage', 'Nome de usu√°rio deve ter pelo menos 3 caracteres.');
                return;
            }
            
            if (password.length < 6) {
                showMessage('loginPage', 'Senha deve ter pelo menos 6 caracteres.');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Entrando...';
            
            try {
                const result = await verifyUser(userName, password);
                
                if (result.success) {
                    await loginUser(result, userName, password);
                } else {
                    showMessage('loginPage', result.error);
                }
            } catch (error) {
                showMessage('loginPage', 'Erro interno. Tente novamente.');
                console.error('Erro no login:', error);
            }
            
            loginBtn.disabled = false;
            loginBtn.textContent = 'Entrar';
        }

        async function loginUser(userData, userName = null, password = null) {
            await loadData(userData.userId);

            currentUser = {
                name: userData.userName || userData.fullName,
                fullName: userData.fullName,
                id: userData.userId,
                loginDate: new Date().toLocaleDateString('pt-BR'),
                loginTime: new Date().toLocaleTimeString('pt-BR'),
                location: userLocation
            };

            await saveData();
            
            if (userName && password) {
                const autoLoginData = {
                    userName: userName,
                    password: password
                };
                localStorage.setItem(AUTO_LOGIN_KEY, JSON.stringify(autoLoginData));
            }
            
            showMainApp();
        }

        function logout() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                currentUser = null;
                localStorage.removeItem(AUTO_LOGIN_KEY);
                
                document.getElementById('loginUserName').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('registerUserName').value = '';
                document.getElementById('registerFullName').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                showInitialPage();
            }
        }

        function showMainApp() {
            hideAllPages();
            const mainApp = document.getElementById('mainApp');
            
            mainApp.style.display = 'block';
            mainApp.classList.add('active');
            
            updateUserInterface();
            updateDisplay();
        }

        function updateUserInterface() {
            if (currentUser) {
                const firstName = currentUser.fullName ? currentUser.fullName.split(' ')[0] : currentUser.name.split(' ')[0];
                const displayName = currentUser.fullName || currentUser.name;
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                document.getElementById('userDisplayName').textContent = firstName;
                document.getElementById('dashboardUserName').textContent = displayName;
                document.getElementById('userAvatar').textContent = initials.substring(0, 2);
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            
            if (id === 'addGroupModal') {
                document.getElementById('groupName').value = '';
                document.getElementById('groupQuantity').value = '';
                document.getElementById('groupAvgWeight').value = '';
                document.getElementById('groupCostPerAnimal').value = '';
                document.getElementById('groupTotalCost').value = '';
            }
        }

        async function addGroup() {
            const name = document.getElementById('groupName').value.trim();
            const quantity = parseInt(document.getElementById('groupQuantity').value);
            const avgWeight = parseFloat(document.getElementById('groupAvgWeight').value);
            const category = document.getElementById('groupCategory').value;
            const costPerAnimal = parseFloat(document.getElementById('groupCostPerAnimal').value) || 0;
            const totalCost = parseFloat(document.getElementById('groupTotalCost').value) || 0;
            
            if (!name || !quantity || quantity <= 0 || !avgWeight || avgWeight <= 0) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            let finalTotalCost = totalCost;
            if (costPerAnimal > 0 && totalCost === 0) {
                finalTotalCost = costPerAnimal * quantity;
            } else if (costPerAnimal === 0 && totalCost === 0) {
                alert('Por favor, informe o custo por animal ou o custo total do grupo.');
                return;
            }

            const newGroup = {
                id: Date.now().toString(),
                name: name,
                quantity: quantity,
                avgWeight: avgWeight,
                category: category,
                initialCost: finalTotalCost,
                supplyExpenses: [],
                revenue: 0,
                createdDate: new Date().toLocaleDateString('pt-BR'),
                createdBy: currentUser.fullName || currentUser.name
            };

            cattleGroups.push(newGroup);
            await saveData();
            closeModal('addGroupModal');
            updateDisplay();
            alert(`Grupo "${name}" cadastrado com sucesso!`);
        }

        function showGroupDetails(groupId) {
            currentGroupId = groupId;
            const group = cattleGroups.find(g => g.id === groupId);
            if (!group) return;

            updateStockProductSelect();

            document.getElementById('groupDetailsTitle').textContent = `üìä ${group.name}`;
            
            const totalSupplies = group.supplyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalCost = group.initialCost + totalSupplies;
            const profit = group.revenue - totalCost;
            const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';

            let suppliesTable = '';
            if (group.supplyExpenses.length > 0) {
                suppliesTable = `
                    <h4 style="margin-top: 20px;">Gastos com Insumos (Alimenta√ß√£o/Manejo)</h4>
                    <table class="compact-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Produto</th>
                                <th>Quantidade</th>
                                <th>Valor Unit.</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${group.supplyExpenses.map(exp => `
                                <tr>
                                    <td>${exp.date}</td>
                                    <td>${exp.productName || exp.description}</td>
                                    <td>${exp.quantity ? exp.quantity.toFixed(2) + ' ' + exp.unit : '-'}</td>
                                    <td>${exp.unitValue ? 'R$ ' + exp.unitValue.toFixed(2).replace('.', ',') : '-'}</td>
                                    <td>R$ ${exp.amount.toFixed(2).replace('.', ',')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            document.getElementById('groupDetailsContent').innerHTML = `
                <div class="group-info" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div class="group-info-item">
                        <div class="group-info-label">Quantidade</div>
                        <div class="group-info-value">${group.quantity} animais</div>
                    </div>
                    <div class="group-info-item">
                        <div class="group-info-label">Peso M√©dio</div>
                        <div class="group-info-value">${group.avgWeight} kg</div>
                    </div>
                    <div class="group-info-item">
                        <div class="group-info-label">Categoria</div>
                        <div class="group-info-value">${group.category}</div>
                    </div>
                    <div class="group-info-item">
                        <div class="group-info-label">Data de Cadastro</div>
                        <div class="group-info-value">${group.createdDate}</div>
                    </div>
                </div>

                <div class="financial-summary">
                    <div class="financial-grid">
                        <div class="financial-item">
                            <span class="financial-label">Investimento Inicial</span>
                            <span class="financial-value" style="color: #ef4444;">R$ ${group.initialCost.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="financial-item">
                            <span class="financial-label">Gastos com Insumos</span>
                            <span class="financial-value" style="color: #f59e0b;">R$ ${totalSupplies.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="financial-item">
                            <span class="financial-label">Custo Total</span>
                            <span class="financial-value" style="color: #6b7280;">R$ ${totalCost.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="financial-item">
                            <span class="financial-label">Receita</span>
                            <span class="financial-value" style="color: #10b981;">R$ ${group.revenue.toFixed(2).replace('.', ',')}</span>
                        </div>
                        <div class="financial-item" style="grid-column: span 2; background: ${profit >= 0 ? '#ecfdf5' : '#fef2f2'};">
                            <span class="financial-label" style="font-size: 1.1rem;"><strong>Lucro/Preju√≠zo</strong></span>
                            <span class="financial-value ${profitClass}" style="font-size: 1.5rem;">R$ ${profit.toFixed(2).replace('.', ',')}</span>
                        </div>
                    </div>
                </div>

                ${suppliesTable}
            `;

            openModal('groupDetailsModal');
        }

        // NOVA FUN√á√ÉO: Abrir modal de edi√ß√£o com dados preenchidos
        function openEditGroupModal() {
            if (!currentGroupId) return;
            const group = cattleGroups.find(g => g.id === currentGroupId);
            if (!group) return;

            document.getElementById('editGroupName').value = group.name;
            document.getElementById('editGroupQuantity').value = group.quantity;
            document.getElementById('editGroupAvgWeight').value = group.avgWeight;
            document.getElementById('editGroupCategory').value = group.category;
            document.getElementById('editGroupTotalCost').value = group.initialCost;

            // Fechar o modal de detalhes e abrir o de edi√ß√£o
            closeModal('groupDetailsModal');
            openModal('editGroupModal');
        }

        // NOVA FUN√á√ÉO: Salvar edi√ß√£o do grupo
        async function saveGroupEdit() {
            if (!currentGroupId) return;
            
            const name = document.getElementById('editGroupName').value.trim();
            const quantity = parseInt(document.getElementById('editGroupQuantity').value);
            const avgWeight = parseFloat(document.getElementById('editGroupAvgWeight').value);
            const category = document.getElementById('editGroupCategory').value;
            const initialCost = parseFloat(document.getElementById('editGroupTotalCost').value);

            if (!name || !quantity || quantity <= 0 || !avgWeight || avgWeight <= 0) {
                alert('Por favor, preencha os campos obrigat√≥rios corretamente.');
                return;
            }

            const groupIndex = cattleGroups.findIndex(g => g.id === currentGroupId);
            if (groupIndex !== -1) {
                // Atualizar propriedades
                cattleGroups[groupIndex].name = name;
                cattleGroups[groupIndex].quantity = quantity;
                cattleGroups[groupIndex].avgWeight = avgWeight;
                cattleGroups[groupIndex].category = category;
                cattleGroups[groupIndex].initialCost = initialCost || 0;

                await saveData();
                closeModal('editGroupModal');
                
                // Reabrir detalhes atualizados
                showGroupDetails(currentGroupId);
                updateDisplay();
                alert('Grupo atualizado com sucesso!');
            }
        }

        function updateStockProductSelect() {
            const select = document.getElementById('supplyProductSelect');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione um produto...</option>';
            
            stock.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.quantity.toFixed(2)} ${product.unit} dispon√≠vel)`;
                select.appendChild(option);
            });

            select.addEventListener('change', function() {
                const stockWarning = document.getElementById('stockWarning');
                if (this.value) {
                    const product = stock.find(p => p.id === this.value);
                    if (product && product.quantity <= 0) {
                        stockWarning.style.display = 'block';
                    } else {
                        stockWarning.style.display = 'none';
                    }
                } else {
                    stockWarning.style.display = 'none';
                }
            });
        }

        async function addSupplyExpense() {
            if (!currentGroupId) return;

            const productSelect = document.getElementById('supplyProductSelect');
            const productId = productSelect.value;
            const quantityUsed = parseFloat(document.getElementById('supplyQuantityUsed').value);
            const date = document.getElementById('supplyDate').value;

            if (!productId || !quantityUsed || quantityUsed <= 0 || !date) {
                alert('Por favor, preencha todos os campos corretamente.');
                return;
            }

            const product = stock.find(p => p.id === productId);
            if (!product) {
                alert('Produto n√£o encontrado!');
                return;
            }

            if (product.quantity < quantityUsed) {
                alert(`Quantidade insuficiente em estoque! Dispon√≠vel: ${product.quantity} ${product.unit}`);
                return;
            }

            const group = cattleGroups.find(g => g.id === currentGroupId);
            if (!group) return;

            const avgUnitValue = product.totalValue / product.quantity;
            const totalCost = avgUnitValue * quantityUsed;

            product.quantity -= quantityUsed;
            product.totalValue -= totalCost;

            if (product.quantity <= 0) {
                stock = stock.filter(p => p.id !== productId);
            }

            group.supplyExpenses.push({
                date: date,
                productName: product.name,
                description: `${quantityUsed.toFixed(2)} ${product.unit} de ${product.name}`,
                quantity: quantityUsed,
                unit: product.unit,
                amount: totalCost,
                unitValue: avgUnitValue
            });

            document.getElementById('supplyProductSelect').value = '';
            document.getElementById('supplyQuantityUsed').value = '';
            document.getElementById('supplyDate').value = '';

            await saveData();
            updateStockProductSelect();
            showGroupDetails(currentGroupId);
            updateDisplay();
            alert(`${quantityUsed.toFixed(2)} ${product.unit} de ${product.name} aplicado ao grupo com sucesso!`);
        }

        async function setRevenue() {
            if (!currentGroupId) return;

            const amount = parseFloat(document.getElementById('revenueAmount').value);

            if (!amount || amount <= 0) {
                alert('Por favor, informe um valor v√°lido.');
                return;
            }

            const group = cattleGroups.find(g => g.id === currentGroupId);
            if (!group) return;

            group.revenue = amount;
            document.getElementById('revenueAmount').value = '';

            await saveData();
            showGroupDetails(currentGroupId);
            updateDisplay();
            alert('Receita atualizada com sucesso!');
        }

        async function deleteGroup() {
            if (!currentGroupId) return;

            if (confirm('Tem certeza que deseja excluir este grupo? Esta a√ß√£o n√£o pode ser desfeita.')) {
                cattleGroups = cattleGroups.filter(g => g.id !== currentGroupId);
                await saveData();
                closeModal('groupDetailsModal');
                updateDisplay();
                alert('Grupo exclu√≠do com sucesso!');
            }
        }

        function updateGroupsList() {
            const groupsList = document.getElementById('groupsList');
            
            if (cattleGroups.length === 0) {
                groupsList.innerHTML = '<div class="empty-state">Nenhum grupo cadastrado.</div>';
                return;
            }

            groupsList.innerHTML = cattleGroups.map(group => {
                const totalSupplies = group.supplyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                const totalCost = group.initialCost + totalSupplies;
                const profit = group.revenue - totalCost;
                const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';

                return `
                    <div class="group-item" onclick="showGroupDetails('${group.id}')">
                        <div class="group-header">
                            <div class="group-name">${group.name}</div>
                            <div class="group-count">${group.quantity} üêÑ</div>
                        </div>
                        <div class="group-info">
                            <div class="group-info-item">
                                <span class="group-info-label">Custo Total</span>
                                <span class="group-info-value">R$ ${totalCost.toFixed(2).replace('.', ',')}</span>
                            </div>
                            <div class="group-info-item">
                                <span class="group-info-label">Receita</span>
                                <span class="group-info-value">R$ ${group.revenue.toFixed(2).replace('.', ',')}</span>
                            </div>
                            <div class="group-info-item">
                                <span class="group-info-label">Lucro</span>
                                <span class="group-info-value ${profitClass}">R$ ${profit.toFixed(2).replace('.', ',')}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const quantity = parseFloat(document.getElementById('productQuantity').value);
            const unit = document.getElementById('productUnit').value;
            const value = parseFloat(document.getElementById('productValue').value);
            const transactionType = document.getElementById('productTransactionType').value;
            
            if (!name || !description || isNaN(quantity) || quantity <= 0 || isNaN(value) || value < 0) {
                alert('Por favor, preencha todos os campos do produto corretamente.');
                return;
            }

            const existingProduct = stock.find(p => p.name.toLowerCase() === name.toLowerCase());
            
            if (transactionType === 'venda') {
                if (!existingProduct || existingProduct.quantity < quantity) {
                    alert('Quantidade insuficiente em estoque para venda!');
                    return;
                }
                
                existingProduct.quantity -= quantity;
                existingProduct.totalValue = Math.max(0, existingProduct.totalValue - value);
                
                existingProduct.transactions = existingProduct.transactions || [];
                existingProduct.transactions.push({
                    type: 'venda',
                    date: new Date().toLocaleDateString('pt-BR'),
                    quantity: quantity,
                    value: value
                });
                
                if (existingProduct.quantity === 0) {
                    stock = stock.filter(p => p.id !== existingProduct.id);
                }
                
                alert(`Venda de ${quantity} ${unit} de ${name} registrada com sucesso!`);
            } else {
                if (existingProduct) {
                    existingProduct.quantity += quantity;
                    existingProduct.totalValue += value;
                    
                    existingProduct.transactions = existingProduct.transactions || [];
                    existingProduct.transactions.push({
                        type: 'compra',
                        date: new Date().toLocaleDateString('pt-BR'),
                        quantity: quantity,
                        value: value
                    });
                } else {
                    const newProduct = {
                        id: Date.now().toString(),
                        name: name,
                        description: description,
                        quantity: quantity,
                        unit: unit,
                        totalValue: value,
                        transactions: [{
                            type: 'compra',
                            date: new Date().toLocaleDateString('pt-BR'),
                            quantity: quantity,
                            value: value
                        }]
                    };
                    stock.push(newProduct);
                }
                
                alert(`${quantity} ${unit} de ${name} adicionado ao estoque!`);
            }
            
            document.getElementById('productName').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productQuantity').value = '';
            document.getElementById('productValue').value = '';
            
            await saveData();
            closeModal('addProductModal');
            updateStockTable();
        }

        function updateStockTable() {
            const tbody = document.getElementById('stockTableBody');
            const emptyState = document.getElementById('emptyStockState');
            
            if (stock.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                tbody.innerHTML = stock.map(product => {
                    const avgValue = product.quantity > 0 ? product.totalValue / product.quantity : 0;
                    return `
                        <tr>
                            <td>
                                <strong>${product.name}</strong><br>
                                <small style="color: #6b7280;">${product.description}</small><br>
                                <small style="color: #059669;">Valor m√©dio: R$ ${avgValue.toFixed(2).replace('.', ',')}/${product.unit}</small>
                            </td>
                            <td>
                                <span class="badge badge-number">${product.quantity.toFixed(2)} ${product.unit}</span><br>
                                <small style="color: #6b7280;">Total: R$ ${product.totalValue.toFixed(2).replace('.', ',')}</small>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }
        
        async function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value.trim();

            if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
                alert('Por favor, preencha todos os campos do gasto corretamente.');
                return;
            }
            
            const newExpense = {
                date: date,
                description: description,
                amount: amount,
                category: category
            };
            
            expenses.push(newExpense);
            
            document.getElementById('expenseDate').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseCategory').value = '';
            
            await saveData();
            closeModal('addExpenseModal');
            updateExpensesTable();
            updateFinancialSummary(); // Atualiza o financeiro ao adicionar gasto
            alert('Gasto registrado com sucesso!');
        }

        function updateExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            const emptyState = document.getElementById('emptyExpensesState');
            
            if (expenses.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                
                const recentExpenses = expenses.slice(-5).reverse();
                
                tbody.innerHTML = recentExpenses.map(expense => `
                    <tr>
                        <td>${expense.date}</td>
                        <td>${expense.description}</td>
                        <td>R$ ${expense.amount.toFixed(2).replace('.', ',')}</td>
                    </tr>
                `).join('');
            }
        }

        // FUN√á√ÉO FINANCEIRA CORRIGIDA
        function updateFinancialSummary() {
            let totalInvestment = 0;
            let totalSupplies = 0;
            let totalRevenue = 0;

            // 1. Somar dados dos grupos
            cattleGroups.forEach(group => {
                totalInvestment += group.initialCost || 0;
                
                // Somar insumos deste grupo
                const groupSupplies = group.supplyExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
                totalSupplies += groupSupplies;
                
                totalRevenue += group.revenue || 0;
            });

            // 2. Somar gastos gerais (Veterin√°rio, Manuten√ß√£o, etc.)
            expenses.forEach(expense => {
                totalSupplies += expense.amount || 0;
            });

            const totalProfit = totalRevenue - (totalInvestment + totalSupplies);
            const profitClass = totalProfit >= 0 ? 'profit-positive' : 'profit-negative';

            document.getElementById('totalInvestment').textContent = `R$ ${totalInvestment.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalSupplies').textContent = `R$ ${totalSupplies.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalRevenue').textContent = `R$ ${totalRevenue.toFixed(2).replace('.', ',')}`;
            
            const profitElement = document.getElementById('totalProfit');
            profitElement.textContent = `R$ ${totalProfit.toFixed(2).replace('.', ',')}`;
            profitElement.className = `financial-value ${profitClass}`;
        }

        function updateDisplay() {
            document.getElementById('totalGroups').textContent = cattleGroups.length;
            
            updateGroupsList();
            updateStockTable();
            updateExpensesTable();
            updateFinancialSummary();
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                const activeElement = document.activeElement;
                
                if (activeElement && (activeElement.id === 'loginUserName' || activeElement.id === 'loginPassword')) {
                    const form = activeElement.closest('form');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
                
                if (activeElement && (activeElement.id === 'registerUserName' || activeElement.id === 'registerFullName' || 
                    activeElement.id === 'registerPassword' || activeElement.id === 'confirmPassword')) {
                    const form = activeElement.closest('form');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
            }
        });
    </script>
</body>
</html>
