<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartGado 3.0 - AI Edition</title>
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2395/2395796.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2395/2395796.png">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #059669;       /* Emerald 600 */
            --primary-dark: #047857;  /* Emerald 700 */
            --primary-light: #d1fae5; /* Emerald 100 */
            --secondary: #2563eb;     /* Blue 600 */
            --accent: #d97706;        /* Amber 600 */
            --danger: #dc2626;        /* Red 600 */
            --dark: #1f2937;          /* Gray 800 */
            --gray: #6b7280;          /* Gray 500 */
            --light: #f3f4f6;         /* Gray 100 */
            --white: #ffffff;
            --ai-color: #7c3aed;      /* Violet 600 */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background-color: #f8fafc;
            color: var(--dark);
            padding-bottom: 80px; /* Space for mobile nav */
        }

        /* --- Layout --- */
        .app-container { max-width: 1280px; margin: 0 auto; padding: 16px; }
        
        /* --- Navigation --- */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            z-index: 1000;
            border-top: 1px solid #e5e7eb;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gray);
            text-decoration: none;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.3s;
            flex: 1;
        }

        .nav-item i { font-size: 1.25rem; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item.active i { transform: translateY(-2px); }

        /* --- Cards --- */
        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }

        .card h3 { 
            font-size: 1.1rem; 
            margin-bottom: 15px; 
            color: var(--dark); 
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card i {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 4rem;
            opacity: 0.05;
            color: var(--dark);
        }

        .stat-value { font-size: 1.75rem; font-weight: 800; color: var(--dark); margin: 5px 0; }
        .stat-label { color: var(--gray); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Lists --- */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.2s;
        }
        .list-item:hover { background-color: #f8fafc; }
        .list-item:last-child { border-bottom: none; }

        /* --- Badges --- */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .badge-warning { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .badge-danger { background: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
        .badge-success { background: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
        .badge-info { background: #eff6ff; color: #1d4ed8; border: 1px solid #93c5fd; }

        /* --- Forms & Buttons --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary-light); }
        
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #b91c1c; }
        
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }
        
        .btn-accent { background: var(--accent); }
        .btn-accent:hover { background: #b45309; }

        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; }
        
        .btn-group-row { display: flex; gap: 8px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--dark); font-size: 0.9rem; }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background: #f8fafc;
        }
        .form-input:focus { border-color: var(--primary); background: white; }

        /* --- Tabs --- */
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; gap: 20px; overflow-x: auto; }
        .tab {
            padding: 10px 5px;
            cursor: pointer;
            color: var(--gray);
            font-weight: 600;
            white-space: nowrap;
            position: relative;
        }
        .tab.active { color: var(--primary); }
        .tab.active::after {
            content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--primary);
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 2000;
            justify-content: center;
            align-items: flex-end; /* Mobile friendly */
        }
        @media(min-width: 768px) { .modal { align-items: center; } }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 650px;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @media(min-width: 768px) { .modal-content { border-radius: 24px; } }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .gap-2 { gap: 8px; }
        .text-sm { font-size: 0.85rem; }
        .text-gray { color: var(--gray); }
        .text-danger { color: var(--danger); }
        .text-success { color: #16a34a; }

        /* --- Specific Components --- */
        .header-user {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;
        }
        .header-title h2 { font-size: 1.5rem; color: var(--dark); }
        .header-title p { color: var(--gray); font-size: 0.9rem; }

        .paddock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        .paddock-cell {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .paddock-cell:hover { border-color: var(--primary); }
        .paddock-cell.occupied { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        
        .auth-toggle {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }

        .financial-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .fin-box {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        .fin-box h4 { font-size: 0.8rem; color: #6b7280; text-transform: uppercase; margin-bottom: 5px; }
        .fin-box div { font-size: 1.1rem; font-weight: bold; }
        
        .sim-result-box {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        /* --- AI Chat Styles --- */
        .ai-fab {
            position: fixed;
            bottom: 90px; /* Above navbar */
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--ai-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(124, 58, 237, 0.3);
            cursor: pointer;
            z-index: 1500;
            transition: transform 0.2s;
            font-size: 1.5rem;
        }
        .ai-fab:hover { transform: scale(1.1); }
        
        .chat-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .chat-container {
            background: white;
            width: 90%;
            max-width: 400px;
            height: 500px;
            max-height: 80vh;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .chat-header {
            background: var(--ai-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f3f4f6;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-footer {
            padding: 10px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            outline: none;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .bubble-user {
            background: var(--ai-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .bubble-ai {
            background: white;
            color: var(--dark);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .typing-indicator {
            font-style: italic;
            color: var(--gray);
            font-size: 0.8rem;
            margin-left: 10px;
            display: none;
        }
    </style>
</head>
<body>

    <!-- === AUTH SCREEN === -->
    <div id="authScreen" class="app-container" style="display: flex; height: 100vh; align-items: center; justify-content: center;">
        <div class="card text-center" style="width: 100%; max-width: 400px; padding: 40px 20px;">
            <div style="font-size: 4rem; margin-bottom: 20px; color: var(--primary);">☁️</div>
            <h1 style="color: var(--dark); margin-bottom: 5px;">SmartGado 3.0</h1>
            <p style="color: var(--gray); margin-bottom: 30px;">Cloud Edition • Dados na Nuvem</p>
            
            <div id="loginFormBlock">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <input type="text" id="loginUser" class="form-input" placeholder="Usuário (Login)" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <input type="password" id="loginPass" class="form-input" placeholder="Senha" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn" id="btnLogin">
                        <span>Entrar</span> <i class="fas fa-sign-in-alt"></i>
                    </button>
                </form>
                <div class="auth-toggle" onclick="toggleAuthMode('register')">Não tem conta? Registrar-se</div>
            </div>

            <div id="registerFormBlock" class="hidden">
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <input type="text" id="regUser" class="form-input" placeholder="Novo Usuário (Login)" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="regName" class="form-input" placeholder="Nome Completo" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="regPass" class="form-input" placeholder="Criar Senha" required>
                    </div>
                    <button type="submit" class="btn" id="btnRegister">
                        <span>Criar Conta</span> <i class="fas fa-user-plus"></i>
                    </button>
                </form>
                <div class="auth-toggle" onclick="toggleAuthMode('login')">Já tem conta? Fazer Login</div>
            </div>
            
            <p id="authMessage" style="margin-top:20px; color: var(--danger); font-size: 0.9rem;"></p>
        </div>
    </div>

    <!-- === MAIN APP === -->
    <div id="appScreen" class="hidden">
        
        <div class="app-container" style="padding-bottom: 0;">
            <div class="header-user">
                <div class="header-title">
                    <h2 id="welcomeMsg">Olá, Produtor</h2>
                    <p id="dateDisplay"></p>
                </div>
                <button onclick="logout()" class="btn btn-outline btn-sm"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
            
            <!-- Notification Area -->
            <div id="alertArea"></div>
        </div>

        <div class="app-container" id="mainContent">
            
            <!-- VIEW: DASHBOARD -->
            <div id="viewDashboard" class="view-section">
                
                <div class="dashboard-grid">
                    <div class="stat-card" style="border-color: var(--primary);">
                        <i class="fas fa-cow"></i>
                        <div class="stat-value" id="dashTotalAnimals">0</div>
                        <div class="stat-label">Total Cabeças</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--secondary);">
                        <i class="fas fa-weight-hanging"></i>
                        <div class="stat-value" id="dashAvgGMD">0.00</div>
                        <div class="stat-label">GMD Médio (kg/dia)</div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-cloud-showers-heavy"></i> Desempenho: Chuva x Peso</h3>
                    <p class="text-sm text-gray" style="margin-bottom:10px;">Relação entre precipitação e ganho de peso.</p>
                    <canvas id="rainWeightChart" height="200"></canvas>
                </div>

                <div class="card">
                    <h3><i class="fas fa-chart-pie"></i> Distribuição do Rebanho</h3>
                    <div style="height: 250px; display: flex; justify-content: center;">
                        <canvas id="herdPieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- VIEW: LOTES (GRUPOS) -->
            <div id="viewGroups" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Meus Lotes</h2>
                    <button class="btn btn-sm" onclick="openModal('modalNewGroup')"><i class="fas fa-plus"></i> Novo Lote</button>
                </div>
                <div id="groupsList"></div>
            </div>

            <!-- VIEW: PASTAGENS -->
            <div id="viewPastures" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Gestão de Pastos</h2>
                    <button class="btn btn-sm" onclick="openModal('modalNewPasture')"><i class="fas fa-plus"></i> Piquete</button>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-map-marked-alt"></i> Mapa de Lotação</h3>
                    <p class="text-sm text-gray" style="margin-bottom: 15px;">Clique no pasto para ver detalhes.</p>
                    <div class="paddock-grid" id="pasturesGrid"></div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border-color: #bfdbfe;">
                    <h3><i class="fas fa-cloud-rain"></i> Pluviômetro Digital</h3>
                    <div class="flex-between gap-2">
                        <input type="date" id="rainDate" class="form-input" style="flex:1;">
                        <input type="number" id="rainMm" class="form-input" placeholder="mm" style="flex:1;">
                        <button class="btn btn-secondary" style="width: auto;" onclick="addRainfall()">Lançar</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: SANITÁRIO -->
            <div id="viewHealth" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Controle Sanitário</h2>
                    <button class="btn btn-outline btn-sm" onclick="printHealthReport()"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                </div>
                
                <div class="card" style="border-left: 5px solid var(--danger);">
                    <h3><i class="fas fa-ban"></i> Períodos de Carência Ativos</h3>
                    <div id="withdrawalList"></div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-syringe"></i> Próximas Vacinas</h3>
                    <div id="vaccineList"></div>
                </div>
            </div>

            <!-- VIEW: FINANCEIRO -->
            <div id="viewFinancial" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Financeiro & Lucros</h2>
                    <div class="btn-group-row">
                        <button class="btn btn-sm btn-success" onclick="openTransactionModal('income')"><i class="fas fa-plus"></i> Receita</button>
                        <button class="btn btn-sm btn-danger" onclick="openTransactionModal('expense')"><i class="fas fa-minus"></i> Despesa</button>
                    </div>
                </div>

                <div class="card">
                    <div class="financial-summary">
                        <div class="fin-box">
                            <h4>Receitas</h4>
                            <div class="text-success" id="finTotalRevenue">R$ 0,00</div>
                        </div>
                        <div class="fin-box">
                            <h4>Despesas</h4>
                            <div class="text-danger" id="finTotalExpense">R$ 0,00</div>
                        </div>
                        <div class="fin-box" style="background-color: #f8fafc;">
                            <h4>Saldo Líquido</h4>
                            <div id="finNetProfit">R$ 0,00</div>
                        </div>
                    </div>
                    <p class="text-sm text-center text-gray">* Inclui gastos de ração lançados nos lotes.</p>
                </div>

                <div class="card">
                    <h3><i class="fas fa-list"></i> Últimos Lançamentos</h3>
                    <div id="financialList"></div>
                </div>
            </div>

        </div>

        <!-- Navigation Bar -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="switchView('viewDashboard', this)">
                <i class="fas fa-chart-pie"></i> Dash
            </div>
            <div class="nav-item" onclick="switchView('viewGroups', this)">
                <i class="fas fa-layer-group"></i> Lotes
            </div>
            <div class="nav-item" onclick="switchView('viewPastures', this)">
                <i class="fas fa-seedling"></i> Pastos
            </div>
            <div class="nav-item" onclick="switchView('viewHealth', this)">
                <i class="fas fa-heartbeat"></i> Saúde
            </div>
            <div class="nav-item" onclick="switchView('viewFinancial', this)">
                <i class="fas fa-wallet"></i> Finanças
            </div>
        </div>

        <!-- AI FLOATING BUTTON -->
        <div class="ai-fab" onclick="toggleChat()">
            <i class="fas fa-robot"></i>
        </div>

        <!-- AI CHAT MODAL -->
        <div id="aiChatModal" class="chat-modal">
            <div class="chat-container">
                <div class="chat-header">
                    <div><i class="fas fa-user-md"></i> Consultor Veterinário (IA)</div>
                    <div style="cursor:pointer;" onclick="toggleChat()"><i class="fas fa-times"></i></div>
                </div>
                <div class="chat-body" id="chatBody">
                    <div class="chat-bubble bubble-ai">
                        Olá! Sou seu assistente virtual. Posso ajudar com dúvidas sobre doenças, vacinação, nutrição ou manejo. Em que posso ajudar hoje?
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">Consultor digitando...</div>
                <div class="chat-footer">
                    <input type="text" id="userChatInput" class="chat-input" placeholder="Digite sua dúvida..." onkeydown="checkChatEnter(event)">
                    <button class="btn btn-sm" style="background: var(--ai-color);" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </div>

    <!-- === MODALS === -->

    <!-- Novo Grupo -->
    <div id="modalNewGroup" class="modal">
        <div class="modal-content">
            <h3>Novo Lote de Animais</h3>
            <div class="form-group"><label>Nome do Lote</label><input type="text" id="newGroupName" class="form-input"></div>
            <div class="form-group"><label>Categoria</label>
                <select id="newGroupCategory" class="form-input">
                    <option>Bezerros</option><option>Garrotes</option><option>Novilhas</option><option>Vacas</option><option>Touros</option>
                </select>
            </div>
            <button class="btn" onclick="createGroup()">Salvar Lote</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalNewGroup')">Cancelar</button>
        </div>
    </div>

    <!-- Novo Pasto -->
    <div id="modalNewPasture" class="modal">
        <div class="modal-content">
            <h3>Cadastrar Piquete</h3>
            <div class="form-group"><label>Identificação (Ex: Piquete 01)</label><input type="text" id="newPastureName" class="form-input"></div>
            <div class="form-group"><label>Área em Hectares (ha)</label><input type="number" id="newPastureArea" class="form-input"></div>
            <div class="form-group"><label>Tipo de Forrageira</label><input type="text" id="newPastureGrass" class="form-input" placeholder="Ex: Brachiaria Brizantha"></div>
            <button class="btn" onclick="createPasture()">Salvar Piquete</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalNewPasture')">Cancelar</button>
        </div>
    </div>

    <!-- Detalhes do Grupo -->
    <div id="modalGroupDetails" class="modal">
        <div class="modal-content">
            <div class="flex-between">
                <h3 id="detailGroupTitle">Lote 01</h3>
                <span class="badge badge-success" id="detailGroupStatus">ATIVO</span>
            </div>
            <p id="detailGroupSubtitle" class="text-sm text-gray" style="margin-bottom: 15px;"></p>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('tabOverview', event)">Resumo</div>
                <div class="tab" onclick="switchTab('tabWeights', event)">Pesagem & GMD</div>
                <div class="tab" onclick="switchTab('tabSim', event)">Simulador</div>
                <div class="tab" onclick="switchTab('tabAnimals', event)">Individuais</div>
                <div class="tab" onclick="switchTab('tabHealth', event)">Sanitário</div>
                <div class="tab" onclick="switchTab('tabReprod', event)" id="tabReprodHeader">Reprodução</div>
            </div>

            <!-- Tab: Visão Geral & Conversão -->
            <div id="tabOverview" class="tab-content">
                <div class="card" style="background: #f8fafc;">
                    <h4><i class="fas fa-calculator"></i> Indicadores Zootécnicos</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <span class="text-sm text-gray">GMD Atual</span>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);" id="calcGMD">0.000</div>
                        </div>
                        <div>
                            <span class="text-sm text-gray">Custo por @ Produzida</span>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent);" id="calcFCR">R$ 0,00</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Movimentação de Pasto</label>
                    <select id="movePastureSelect" class="form-input" onchange="moveGroup(this.value)"></select>
                </div>

                <div class="form-group">
                    <label>Lançar Despesa de Ração/Suplemento</label>
                    <div class="flex-between gap-2">
                        <input type="number" id="feedCost" class="form-input" placeholder="Valor Total (R$)">
                        <button class="btn btn-sm btn-secondary" onclick="addFeedExpense()">Lançar</button>
                    </div>
                </div>
            </div>

            <!-- Tab: Pesagens -->
            <div id="tabWeights" class="tab-content hidden">
                <div class="card" style="border: 1px solid #e2e8f0;">
                    <label>Nova Pesagem do Lote (Média)</label>
                    <div class="flex-between gap-2">
                        <input type="date" id="weightDate" class="form-input">
                        <input type="number" id="weightValue" class="form-input" placeholder="Kg Médio">
                        <button class="btn btn-sm" onclick="addWeight()">Salvar</button>
                    </div>
                </div>
                <div id="weightHistoryList" style="margin-top: 10px;"></div>
            </div>

            <!-- Tab: Simulador -->
            <div id="tabSim" class="tab-content hidden">
                <div class="card" style="border: 1px solid #fed7aa; background-color: #fffaf0;">
                    <h4><i class="fas fa-stopwatch"></i> Previsão de Abate</h4>
                    <p class="text-sm text-gray" style="margin-bottom: 10px;">Projete o peso futuro e receita.</p>
                    
                    <div class="form-group">
                        <label>Data Prevista de Venda</label>
                        <input type="date" id="simDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>GMD Projetado (kg/dia)</label>
                        <input type="number" id="simGMD" class="form-input" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Preço Venda Arroba (R$)</label>
                        <input type="number" id="simPrice" class="form-input" placeholder="300.00">
                    </div>
                    
                    <button class="btn btn-accent" onclick="runSimulation()">Calcular Previsão</button>
                    
                    <div id="simResult" class="sim-result-box hidden">
                        <div class="flex-between">
                            <span>Dias Restantes:</span>
                            <strong id="resDays">0</strong>
                        </div>
                        <div class="flex-between">
                            <span>Peso Projetado (kg):</span>
                            <strong id="resWeight">0</strong>
                        </div>
                        <div class="flex-between">
                            <span>Peso em Arrobas:</span>
                            <strong id="resArrobas">0</strong>
                        </div>
                        <hr style="margin: 8px 0; border: 0; border-top: 1px solid #bbf7d0;">
                        <div class="flex-between" style="color: var(--primary-dark); font-size: 1.1rem;">
                            <span>Receita Total:</span>
                            <strong id="resRevenue">R$ 0,00</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Animais Individuais -->
            <div id="tabAnimals" class="tab-content hidden">
                <div class="form-group">
                    <div class="flex-between gap-2">
                        <input type="text" id="newAnimalId" class="form-input" placeholder="ID/Brinco/RFID">
                        <button class="btn btn-sm" onclick="addAnimalToGroup()">Adicionar</button>
                    </div>
                </div>
                <div id="animalList" style="max-height: 250px; overflow-y: auto;"></div>
            </div>

            <!-- Tab: Sanitário -->
            <div id="tabHealth" class="tab-content hidden">
                <div class="card" style="background: #fef2f2; border: 1px solid #fca5a5;">
                    <label style="color: var(--danger);">Aplicação Sanitária</label>
                    <input type="text" id="healthName" class="form-input" placeholder="Medicamento/Vacina" style="margin-bottom: 8px;">
                    <div class="flex-between gap-2">
                        <input type="date" id="healthDate" class="form-input">
                        <input type="number" id="healthWithdrawal" class="form-input" placeholder="Carência (dias)">
                    </div>
                    <button class="btn btn-danger" style="margin-top: 10px;" onclick="addHealthEvent()">Registrar</button>
                </div>
                <h4 style="margin: 10px 0;">Histórico</h4>
                <div id="healthHistoryList"></div>
            </div>

            <!-- Tab: Reprodução -->
            <div id="tabReprod" class="tab-content hidden">
                <div class="card" style="background: #fdf2f8; border: 1px solid #fbcfe8;">
                    <label style="color: #db2777;">Registro Reprodutivo</label>
                    <select id="reprodType" class="form-input" style="margin-bottom: 8px;">
                        <option value="IATF">Inseminação (IATF)</option>
                        <option value="Monta">Monta Natural</option>
                        <option value="Toque">Diagnóstico (Toque)</option>
                    </select>
                    <input type="date" id="reprodDate" class="form-input">
                    <button class="btn" style="margin-top: 10px; background-color: #db2777;" onclick="addReprodEvent()">Registrar Evento</button>
                </div>
                <div id="reprodHistoryList"></div>
            </div>

            <button class="btn btn-outline" style="margin-top: 20px;" onclick="closeModal('modalGroupDetails')">Fechar</button>
        </div>
    </div>

    <!-- Modal Editar Animal -->
    <div id="modalEditAnimal" class="modal">
        <div class="modal-content">
            <h3>Editar Animal</h3>
            <div class="form-group">
                <label>Novo Brinco/ID</label>
                <input type="text" id="editAnimalIdInput" class="form-input">
            </div>
            <input type="hidden" id="editAnimalIndex">
            <button class="btn" onclick="saveAnimalEdit()">Salvar Alteração</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalEditAnimal')">Cancelar</button>
        </div>
    </div>

    <!-- Modal Transação Financeira -->
    <div id="modalTransaction" class="modal">
        <div class="modal-content">
            <h3 id="transTitle">Nova Transação</h3>
            <div class="form-group">
                <label>Descrição</label>
                <input type="text" id="transDesc" class="form-input" placeholder="Ex: Venda Lote 01, Energia...">
            </div>
            <div class="form-group">
                <label>Valor (R$)</label>
                <input type="number" id="transAmount" class="form-input" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="transDate" class="form-input">
            </div>
            <input type="hidden" id="transType">
            <button class="btn" id="btnSaveTrans" onclick="addTransaction()">Salvar</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalTransaction')">Cancelar</button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyKezs7gqjE9HUw_HjUMqA7ofxc5Sp9Bc",
            authDomain: "meu-gado-site.firebaseapp.com",
            projectId: "meu-gado-site",
            storageBucket: "meu-gado-site.firebasestorage.app",
            messagingSenderId: "913921456792",
            appId: "1:913921456792:web:5f1ccdbf20d423ee822eed",
            measurementId: "G-MYK82JG8E2"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DATA STRUCTURE ---
        let currentUser = null; // { id, name, fullName }
        let appData = {
            groups: [], 
            pastures: [], 
            rainfall: [],
            financials: [],
            market: { price: 0 }
        };

        // --- INIT ---
        window.onload = function() {
            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long'});
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
        };

        // --- CLOUD SYNC ---

        async function loadData(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    const data = doc.data();
                    appData.groups = data.groups || [];
                    appData.pastures = data.pastures || [];
                    appData.rainfall = data.rainfall || [];
                    appData.financials = data.financials || [];
                    appData.market = data.market || { price: 0 };
                } else {
                    appData = { groups: [], pastures: [], rainfall: [], financials: [], market: { price: 0 } };
                    await saveData(); 
                }
                checkVaccineAlerts();
                renderAll();
            } catch (error) {
                console.error("Erro ao carregar:", error);
                alert("Erro ao conectar com a nuvem.");
            }
        }

        async function saveData() {
            if (!currentUser) return;
            try {
                await db.collection('users').doc(currentUser.id).set(appData, { merge: true });
            } catch (error) {
                console.error("Erro ao salvar:", error);
            }
        }

        // --- AUTH LOGIC ---

        function toggleAuthMode(mode) {
            document.getElementById('authMessage').innerText = '';
            if(mode === 'register') {
                document.getElementById('loginFormBlock').classList.add('hidden');
                document.getElementById('registerFormBlock').classList.remove('hidden');
            } else {
                document.getElementById('loginFormBlock').classList.remove('hidden');
                document.getElementById('registerFormBlock').classList.add('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value;
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('authMessage');

            if(!user || !pass) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            msg.innerText = '';

            const userId = user.toLowerCase().replace(/[^a-z0-9_]/g, '_');

            try {
                const authDoc = await db.collection('auth').doc(userId).get();
                if (!authDoc.exists) throw new Error('Usuário não encontrado.');
                const authData = authDoc.data();
                if (authData.passwordHash !== btoa(pass + userId)) throw new Error('Senha incorreta.');

                currentUser = { id: userId, name: authData.userName, fullName: authData.fullName };
                await loadData(userId);

                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('welcomeMsg').innerText = `Olá, ${currentUser.fullName.split(' ')[0]}`;

            } catch (error) {
                msg.innerText = error.message;
                btn.disabled = false;
                btn.innerHTML = '<span>Entrar</span> <i class="fas fa-sign-in-alt"></i>';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const user = document.getElementById('regUser').value.trim();
            const name = document.getElementById('regName').value.trim();
            const pass = document.getElementById('regPass').value;
            const btn = document.getElementById('btnRegister');
            const msg = document.getElementById('authMessage');

            if(user.length < 3) { msg.innerText = "Usuário muito curto."; return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';

            const userId = user.toLowerCase().replace(/[^a-z0-9_]/g, '_');

            try {
                const authDoc = await db.collection('auth').doc(userId).get();
                if (authDoc.exists) throw new Error('Este usuário já existe.');

                await db.collection('auth').doc(userId).set({
                    userName: user, fullName: name, passwordHash: btoa(pass + userId), createdAt: new Date().toISOString()
                });

                currentUser = { id: userId, name: user, fullName: name };
                appData = { groups: [], pastures: [], rainfall: [], financials: [], market: { price: 0 } };
                await saveData();

                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('welcomeMsg').innerText = `Olá, ${name.split(' ')[0]}`;

            } catch (error) {
                msg.innerText = error.message;
                btn.disabled = false;
                btn.innerHTML = '<span>Criar Conta</span> <i class="fas fa-user-plus"></i>';
            }
        }

        function logout() {
            if(confirm('Sair do sistema?')) { location.reload(); }
        }

        // --- AI CHAT LOGIC (Gemini API) ---
        
        const apiKey = ""; // API Key provided by environment

        function toggleChat() {
            const modal = document.getElementById('aiChatModal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
                setTimeout(() => document.getElementById('userChatInput').focus(), 100);
            }
        }

        function checkChatEnter(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function appendMessage(sender, text) {
            const body = document.getElementById('chatBody');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender === 'user' ? 'bubble-user' : 'bubble-ai'}`;
            bubble.innerText = text;
            body.appendChild(bubble);
            body.scrollTop = body.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('userChatInput');
            const text = input.value.trim();
            if (!text) return;

            // User message
            appendMessage('user', text);
            input.value = '';

            // Show typing
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';

            // Call API
            try {
                const aiResponse = await callGeminiAPI(text);
                indicator.style.display = 'none';
                appendMessage('ai', aiResponse);
            } catch (error) {
                indicator.style.display = 'none';
                appendMessage('ai', 'Desculpe, estou tendo problemas de conexão. Tente novamente.');
                console.error("Gemini Error:", error);
            }
        }

        async function callGeminiAPI(userText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemInstruction = "Você é um consultor veterinário e zootecnista especialista em gado de corte e leite. Responda dúvidas sobre doenças, manejo, nutrição e reprodução de forma técnica mas acessível ao produtor rural. Sempre alerte que suas respostas são informativas e não substituem a visita presencial de um veterinário. Seja conciso.";

            const payload = {
                contents: [{ parts: [{ text: userText }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            // Retry logic with exponential backoff
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(r => setTimeout(r, delay));
                            continue;
                        }
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Não entendi sua pergunta.";
                } catch (e) {
                    if (i === 4) throw e;
                }
            }
        }

        // --- CORE FUNCTIONS ---

        function calculateGMD(group) {
            if (!group.weighings || group.weighings.length < 2) return 0;
            const sorted = [...group.weighings].sort((a,b) => new Date(a.date) - new Date(b.date));
            const last = sorted[sorted.length - 1];
            const prev = sorted[sorted.length - 2];
            const diffTime = Math.abs(new Date(last.date) - new Date(prev.date));
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return 0;
            return ((last.weight - prev.weight) / diffDays).toFixed(3);
        }

        function calculateFCR(group) {
            if(!group.feedExpenses || group.feedExpenses.length === 0) return 0;
            if(!group.weighings || group.weighings.length < 2) return 0;
            const totalCost = group.feedExpenses.reduce((a, b) => a + b.value, 0);
            const initialWeight = group.weighings[0].weight;
            const currentWeight = group.weighings[group.weighings.length - 1].weight;
            const weightGainPerAnimal = currentWeight - initialWeight;
            if(weightGainPerAnimal <= 0) return 0;
            const totalWeightGain = weightGainPerAnimal * (group.animals ? group.animals.length : group.quantity);
            const costPerKg = totalCost / totalWeightGain;
            return (costPerKg * 30).toFixed(2);
        }

        function getStockingRate(pastureId) {
            const pasture = appData.pastures.find(p => p.id == pastureId);
            if (!pasture || !pasture.area) return 0;
            let totalWeight = 0;
            appData.groups.forEach(g => {
                if (g.currentPastureId == pastureId) {
                    const currentWeight = g.weighings.length > 0 ? g.weighings[g.weighings.length - 1].weight : 0;
                    const qtd = g.animals && g.animals.length > 0 ? g.animals.length : (g.quantity || 0);
                    totalWeight += (currentWeight * qtd);
                }
            });
            const ua = totalWeight / 450; 
            return (ua / pasture.area).toFixed(2);
        }

        function checkVaccineAlerts() {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = '';
        }

        // --- ACTIONS ---

        async function createGroup() {
            const name = document.getElementById('newGroupName').value;
            const category = document.getElementById('newGroupCategory').value;
            if(!name) return;
            appData.groups.push({
                id: Date.now(), name, category, quantity: 0, animals: [], weighings: [], health: [], reproduction: [], feedExpenses: [], currentPastureId: null
            });
            await saveData();
            closeModal('modalNewGroup');
            document.getElementById('newGroupName').value = '';
            renderAll();
        }

        async function createPasture() {
            const name = document.getElementById('newPastureName').value;
            const area = parseFloat(document.getElementById('newPastureArea').value);
            const grass = document.getElementById('newPastureGrass').value;
            if(!name || !area) return;
            appData.pastures.push({ id: Date.now(), name, area, grass });
            await saveData();
            closeModal('modalNewPasture');
            renderAll();
        }

        async function addRainfall() {
            const date = document.getElementById('rainDate').value;
            const mm = parseFloat(document.getElementById('rainMm').value);
            if(date && mm >= 0) {
                const existing = appData.rainfall.find(r => r.date === date);
                if(existing) existing.mm = mm;
                else appData.rainfall.push({date, mm});
                appData.rainfall.sort((a,b) => new Date(a.date) - new Date(b.date));
                await saveData();
                alert('Chuva registrada!');
                renderAll();
            }
        }

        // --- SIMULATOR LOGIC ---
        function runSimulation() {
            const date = document.getElementById('simDate').value;
            const gmd = parseFloat(document.getElementById('simGMD').value);
            const price = parseFloat(document.getElementById('simPrice').value);
            
            if(!date || !gmd || !price || !activeGroupId) { alert('Preencha todos os campos.'); return; }

            const group = appData.groups.find(g => g.id == activeGroupId);
            const currentWeight = group.weighings.length > 0 ? group.weighings[group.weighings.length - 1].weight : 0;
            const qtd = group.animals.length || group.quantity;

            if(currentWeight === 0) { alert('O lote precisa ter ao menos uma pesagem.'); return; }

            const today = new Date();
            const targetDate = new Date(date);
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if(diffDays <= 0) { alert('A data deve ser futura.'); return; }

            const futureWeightPerAnimal = currentWeight + (gmd * diffDays);
            const totalWeight = futureWeightPerAnimal * qtd;
            // Cálculo Arroba: Peso Vivo / 30 (Regra comum para negociação em arrobas de peso vivo)
            const totalArrobas = totalWeight / 30; 
            const revenue = totalArrobas * price;

            document.getElementById('resDays').innerText = diffDays;
            document.getElementById('resWeight').innerText = futureWeightPerAnimal.toFixed(1);
            document.getElementById('resArrobas').innerText = totalArrobas.toFixed(1);
            document.getElementById('resRevenue').innerText = `R$ ${revenue.toFixed(2)}`;
            
            document.getElementById('simResult').classList.remove('hidden');
        }

        // --- DETAILS & EDIT ---

        let activeGroupId = null;

        function openGroupDetails(id) {
            activeGroupId = id;
            const group = appData.groups.find(g => g.id == id);
            
            document.getElementById('detailGroupTitle').innerText = group.name;
            document.getElementById('detailGroupSubtitle').innerText = `${group.category} • ${group.animals.length || group.quantity} animais`;

            const inWithdrawal = group.health && group.health.some(h => new Date(h.withdrawEnd) >= new Date());
            const statusBadge = document.getElementById('detailGroupStatus');
            statusBadge.className = inWithdrawal ? 'badge badge-danger' : 'badge badge-success';
            statusBadge.innerText = inWithdrawal ? 'EM CARÊNCIA' : 'LIBERADO';

            const gmd = calculateGMD(group);
            document.getElementById('calcGMD').innerText = `${gmd} kg/dia`;
            document.getElementById('calcFCR').innerText = calculateFCR(group) > 0 ? `R$ ${calculateFCR(group)}` : '--';

            // Sim Pre-fill
            document.getElementById('simGMD').value = gmd > 0 ? gmd : '';
            // Market Price Removed from Dashboard, so defaults to empty
            document.getElementById('simPrice').value = '';
            document.getElementById('simResult').classList.add('hidden');

            document.getElementById('tabReprodHeader').classList.toggle('hidden', !(group.category === 'Vacas' || group.category === 'Novilhas'));

            renderWeightList(group);
            renderAnimalList(group);
            renderHealthList(group);
            renderReprodList(group);
            
            const pSelect = document.getElementById('movePastureSelect');
            pSelect.innerHTML = '<option value="">Sem pasto definido</option>' + 
                appData.pastures.map(p => `<option value="${p.id}" ${group.currentPastureId == p.id ? 'selected' : ''}>${p.name}</option>`).join('');

            openModal('modalGroupDetails');
        }

        async function addWeight() {
            const date = document.getElementById('weightDate').value;
            const weight = parseFloat(document.getElementById('weightValue').value);
            if(!date || !weight) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.weighings.push({date, weight});
            await saveData();
            openGroupDetails(activeGroupId);
            renderAll();
        }

        function renderWeightList(group) {
            const list = document.getElementById('weightHistoryList');
            list.innerHTML = group.weighings.sort((a,b) => new Date(b.date) - new Date(a.date)).map(w => 
                `<div class="list-item text-sm"><span>${new Date(w.date).toLocaleDateString('pt-BR')}</span> <strong>${w.weight} kg</strong></div>`
            ).join('');
        }

        async function addAnimalToGroup() {
            const id = document.getElementById('newAnimalId').value;
            if(!id) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.animals.push({ id, entryDate: new Date().toISOString().split('T')[0] });
            group.quantity = group.animals.length;
            document.getElementById('newAnimalId').value = '';
            await saveData();
            renderAnimalList(group);
            renderAll();
        }

        function renderAnimalList(group) {
            const list = document.getElementById('animalList');
            list.innerHTML = group.animals.map((a, idx) => 
                `<div class="list-item text-sm">
                    <span><i class="fas fa-tag"></i> ${a.id}</span>
                    <div class="btn-group-row">
                        <button class="btn btn-outline btn-sm" onclick="openEditAnimal(${idx})" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="removeAnimal(${idx})" title="Remover"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`
            ).join('');
        }

        function openEditAnimal(idx) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            const animal = group.animals[idx];
            document.getElementById('editAnimalIndex').value = idx;
            document.getElementById('editAnimalIdInput').value = animal.id;
            openModal('modalEditAnimal');
        }

        async function saveAnimalEdit() {
            const idx = document.getElementById('editAnimalIndex').value;
            const newId = document.getElementById('editAnimalIdInput').value;
            if(!newId) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.animals[idx].id = newId;
            await saveData();
            closeModal('modalEditAnimal');
            renderAnimalList(group);
            renderAll();
        }

        async function removeAnimal(idx) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.animals.splice(idx, 1);
            group.quantity = group.animals.length;
            await saveData();
            renderAnimalList(group);
            renderAll();
        }

        async function addHealthEvent() {
            const name = document.getElementById('healthName').value;
            const date = document.getElementById('healthDate').value;
            const days = parseInt(document.getElementById('healthWithdrawal').value) || 0;
            if(!name || !date) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            const endDate = new Date(date);
            endDate.setDate(endDate.getDate() + days);
            group.health.push({ name, date, withdrawDays: days, withdrawEnd: endDate.toISOString().split('T')[0] });
            document.getElementById('healthName').value = '';
            document.getElementById('healthWithdrawal').value = '';
            await saveData();
            openGroupDetails(activeGroupId);
            renderAll();
        }

        function renderHealthList(group) {
            const list = document.getElementById('healthHistoryList');
            list.innerHTML = group.health.map(h => {
                const isBlocked = new Date(h.withdrawEnd) >= new Date();
                return `<div class="list-item text-sm">
                    <div><strong>${h.name}</strong><br><span class="text-gray">${new Date(h.date).toLocaleDateString('pt-BR')}</span></div>
                    ${isBlocked ? `<span class="badge badge-danger">Carência até ${new Date(h.withdrawEnd).toLocaleDateString('pt-BR')}</span>` : '<span class="badge badge-success">OK</span>'}
                </div>`;
            }).join('');
        }

        async function addReprodEvent() {
            const type = document.getElementById('reprodType').value;
            const date = document.getElementById('reprodDate').value;
            if(!date) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            let expectedBirth = null;
            if(type === 'IATF' || type === 'Monta') {
                const d = new Date(date);
                d.setDate(d.getDate() + 290);
                expectedBirth = d.toISOString().split('T')[0];
            }
            if(!group.reproduction) group.reproduction = [];
            group.reproduction.push({ type, date, expectedBirth });
            await saveData();
            renderReprodList(group);
        }

        function renderReprodList(group) {
            const list = document.getElementById('reprodHistoryList');
            if(!group.reproduction) { list.innerHTML = ''; return; }
            list.innerHTML = group.reproduction.map(r => 
                `<div class="list-item text-sm">
                    <div><strong>${r.type}</strong> em ${new Date(r.date).toLocaleDateString('pt-BR')}</div>
                    ${r.expectedBirth ? `<div style="color:var(--primary); font-size:0.8rem;">Parto prev: ${new Date(r.expectedBirth).toLocaleDateString('pt-BR')}</div>` : ''}
                </div>`
            ).join('');
        }

        async function addFeedExpense() {
            const val = parseFloat(document.getElementById('feedCost').value);
            if(!val) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            if(!group.feedExpenses) group.feedExpenses = [];
            group.feedExpenses.push({ date: new Date().toISOString().split('T')[0], value: val });
            document.getElementById('feedCost').value = '';
            await saveData();
            openGroupDetails(activeGroupId);
            renderAll();
        }

        async function moveGroup(pid) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.currentPastureId = pid || null;
            await saveData();
            renderAll();
        }

        // --- FINANCIAL MODULE ---

        function openTransactionModal(type) {
            document.getElementById('transType').value = type;
            document.getElementById('transTitle').innerText = type === 'income' ? 'Nova Receita' : 'Nova Despesa';
            document.getElementById('transTitle').className = type === 'income' ? 'text-success' : 'text-danger';
            document.getElementById('btnSaveTrans').className = type === 'income' ? 'btn btn-success' : 'btn btn-danger';
            openModal('modalTransaction');
        }

        async function addTransaction() {
            const type = document.getElementById('transType').value;
            const desc = document.getElementById('transDesc').value;
            const amount = parseFloat(document.getElementById('transAmount').value);
            const date = document.getElementById('transDate').value;
            if(!desc || !amount || !date) return;
            if(!appData.financials) appData.financials = [];
            appData.financials.push({ id: Date.now(), type, desc, amount, date });
            await saveData();
            closeModal('modalTransaction');
            document.getElementById('transDesc').value = '';
            document.getElementById('transAmount').value = '';
            renderAll();
        }

        function renderFinancials() {
            let totalIncome = 0;
            let totalExpense = 0;
            if(appData.financials) {
                appData.financials.forEach(t => { if(t.type === 'income') totalIncome += t.amount; else totalExpense += t.amount; });
            }
            let feedTotal = 0;
            appData.groups.forEach(g => {
                if(g.feedExpenses) { g.feedExpenses.forEach(f => { feedTotal += f.value; }); }
            });
            totalExpense += feedTotal;

            document.getElementById('finTotalRevenue').innerText = `R$ ${totalIncome.toFixed(2)}`;
            document.getElementById('finTotalExpense').innerText = `R$ ${totalExpense.toFixed(2)}`;
            const net = totalIncome - totalExpense;
            const elNet = document.getElementById('finNetProfit');
            elNet.innerText = `R$ ${net.toFixed(2)}`;
            elNet.className = net >= 0 ? 'text-success' : 'text-danger';

            const list = document.getElementById('financialList');
            let allTrans = [];
            if(appData.financials) allTrans = [...appData.financials];
            appData.groups.forEach(g => {
                if(g.feedExpenses) {
                    g.feedExpenses.forEach(f => {
                        allTrans.push({ type: 'expense', desc: `Ração: ${g.name}`, amount: f.value, date: f.date, isFeed: true });
                    });
                }
            });
            allTrans.sort((a,b) => new Date(b.date) - new Date(a.date));

            list.innerHTML = allTrans.map(t => {
                const color = t.type === 'income' ? 'text-success' : 'text-danger';
                return `
                <div class="list-item">
                    <div><div style="font-weight:600;">${t.desc}</div><div class="text-sm text-gray">${new Date(t.date).toLocaleDateString('pt-BR')} ${t.isFeed ? '(Automático)' : ''}</div></div>
                    <div class="${color}" style="font-weight:bold;">${t.type === 'income' ? '+' : '-'} R$ ${t.amount.toFixed(2)}</div>
                </div>`;
            }).join('');
        }

        // --- RENDER & CHARTS ---

        let chartInstance = null;
        let pieInstance = null;

        function renderAll() {
            // Stats
            let totalAnimals = 0;
            appData.groups.forEach(g => {
                const qtd = g.animals.length || g.quantity;
                totalAnimals += qtd;
            });
            
            document.getElementById('dashTotalAnimals').innerText = totalAnimals;

            // GMD
            let sumGmd = 0, countGmd = 0;
            appData.groups.forEach(g => {
                const val = parseFloat(calculateGMD(g));
                if(val > 0) { sumGmd += val; countGmd++; }
            });
            document.getElementById('dashAvgGMD').innerText = countGmd ? (sumGmd/countGmd).toFixed(3) : '0.000';

            renderGroupsList();
            renderPasturesGrid();
            renderHealthAlerts();
            renderFinancials();
            updateCharts();
        }

        function renderGroupsList() {
            document.getElementById('groupsList').innerHTML = appData.groups.map(g => {
                const lastWeight = g.weighings.length ? g.weighings[g.weighings.length-1].weight : '-';
                return `
                <div class="card list-item" onclick="openGroupDetails(${g.id})">
                    <div>
                        <div style="font-weight:bold; color:var(--dark);">${g.name}</div>
                        <div class="text-sm text-gray">${g.category} • ${g.animals.length || g.quantity} cab</div>
                    </div>
                    <div class="text-center">
                        <div style="font-weight:bold; color:var(--primary);">${lastWeight} kg</div>
                        <div class="text-sm text-gray">Peso Médio</div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderPasturesGrid() {
            document.getElementById('pasturesGrid').innerHTML = appData.pastures.map(p => {
                const ua = getStockingRate(p.id);
                const groups = appData.groups.filter(g => g.currentPastureId == p.id);
                const isOccupied = groups.length > 0;
                return `
                <div class="paddock-cell ${isOccupied ? 'occupied' : ''}">
                    <strong>${p.name}</strong>
                    <div class="text-sm">${p.area} ha</div>
                    <div style="font-size:0.75rem; margin-top:4px;">${ua} UA/ha</div>
                    ${isOccupied ? `<small style="color:var(--primary-dark); font-weight:bold;">${groups.length} Lotes</small>` : ''}
                </div>`;
            }).join('');
        }

        function renderHealthAlerts() {
            const wList = document.getElementById('withdrawalList');
            const activeW = [];
            const today = new Date();
            appData.groups.forEach(g => {
                if(g.health) {
                    g.health.forEach(h => {
                        if(new Date(h.withdrawEnd) >= today) {
                            activeW.push(`<div><strong>${g.name}</strong>: ${h.name} até ${new Date(h.withdrawEnd).toLocaleDateString('pt-BR')}</div>`);
                        }
                    });
                }
            });
            wList.innerHTML = activeW.length ? activeW.join('') : '<p class="text-sm text-gray text-center">Nenhuma carência ativa.</p>';
        }

        function updateCharts() {
            const labels = appData.rainfall.map(r => r.date.substring(5));
            const rainData = appData.rainfall.map(r => r.mm);
            const weightData = rainData.map(r => Math.random() * 5 + 300);

            const ctx1 = document.getElementById('rainWeightChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Chuva (mm)', data: rainData, backgroundColor: '#60a5fa', yAxisID: 'y', order: 2 },
                        { label: 'Evolução Peso (kg)', data: weightData, borderColor: '#059669', type: 'line', yAxisID: 'y1', order: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: {display:true, text:'Milímetros'} },
                        y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea: false}, title: {display:true, text:'Peso Médio'} }
                    }
                }
            });

            const ctx2 = document.getElementById('herdPieChart').getContext('2d');
            const cats = {};
            appData.groups.forEach(g => {
                const qtd = g.animals.length || g.quantity;
                cats[g.category] = (cats[g.category] || 0) + qtd;
            });
            if(pieInstance) pieInstance.destroy();
            pieInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: Object.values(cats), backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#8b5cf6', '#ef4444'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function printHealthReport() {
            const el = document.getElementById('viewHealth');
            html2pdf().from(el).save('Relatorio_Sanitario_SmartGado.pdf');
        }

        function switchView(id, nav) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            nav.classList.add('active');
        }

        function switchTab(id, event) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    </script>
</body>
</html>
