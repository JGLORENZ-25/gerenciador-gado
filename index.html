<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeuGado</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2395/2395796.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2395/2395796.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #059669;       /* Emerald 600 */
            --primary-dark: #047857;  /* Emerald 700 */
            --primary-light: #d1fae5; /* Emerald 100 */
            --secondary: #2563eb;     /* Blue 600 */
            --accent: #d97706;        /* Amber 600 */
            --danger: #dc2626;        /* Red 600 */
            --dark: #1f2937;          /* Gray 800 */
            --gray: #6b7280;          /* Gray 500 */
            --light: #f3f4f6;         /* Gray 100 */
            --white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background-color: #f8fafc;
            color: var(--dark);
            padding-bottom: 90px;
        }

        /* --- Layout --- */
        .app-container { max-width: 1280px; margin: 0 auto; padding: 16px; }
        
        /* --- Navigation --- */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            padding: 10px 10px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            z-index: 1000;
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gray);
            text-decoration: none;
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.3s;
            flex: 1;
            min-width: 50px;
            padding: 4px 0;
        }

        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item.active i { transform: translateY(-3px); color: var(--primary); }

        /* --- Cards --- */
        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
        }

        .card h3 { 
            font-size: 1.1rem; 
            margin-bottom: 15px; 
            color: var(--dark); 
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card i {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 4rem;
            opacity: 0.05;
            color: var(--dark);
        }

        .stat-value { font-size: 1.75rem; font-weight: 800; color: var(--dark); margin: 5px 0; }
        .stat-label { color: var(--gray); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Lists --- */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.2s;
        }
        .list-item:hover { background-color: #f8fafc; }
        .list-item:last-child { border-bottom: none; }

        /* --- Badges --- */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .badge-warning { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .badge-danger { background: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
        .badge-success { background: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
        .badge-info { background: #eff6ff; color: #1d4ed8; border: 1px solid #93c5fd; }
        .badge-purple { background: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; }

        /* --- Forms & Buttons --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary-light); }
        
        .btn-danger { background: var(--danger); }
        .btn-success { background: #16a34a; }
        .btn-secondary { background: var(--secondary); }

        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; }
        
        .btn-group-row { display: flex; gap: 8px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--dark); font-size: 0.9rem; }
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s;
            background: #f8fafc;
        }
        .form-input:focus { border-color: var(--primary); background: white; }

        /* --- Tabs --- */
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; gap: 20px; overflow-x: auto; }
        .tab {
            padding: 10px 5px;
            cursor: pointer;
            color: var(--gray);
            font-weight: 600;
            white-space: nowrap;
            position: relative;
        }
        .tab.active { color: var(--primary); }
        .tab.active::after {
            content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--primary);
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 2000;
            justify-content: center;
            align-items: flex-end; /* Mobile friendly */
        }
        @media(min-width: 768px) { .modal { align-items: center; } }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 650px;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @media(min-width: 768px) { .modal-content { border-radius: 24px; } }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .gap-2 { gap: 8px; }
        .text-sm { font-size: 0.85rem; }
        .text-xs { font-size: 0.75rem; } /* Adicionado */
        .text-gray { color: var(--gray); }
        .text-danger { color: var(--danger); }
        .text-success { color: #16a34a; }

        /* --- Specific Components --- */
        .header-user { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .paddock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .paddock-cell { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; }
        .paddock-cell:hover { border-color: var(--primary); }
        .paddock-cell.occupied { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        
        .auth-toggle { margin-top: 15px; font-size: 0.9rem; color: var(--primary); cursor: pointer; text-decoration: underline; }

        .financial-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .fin-box { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #e5e7eb; }
        .fin-box div { font-size: 1.1rem; font-weight: bold; }
        
        .sim-result-box { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 16px; margin-top: 16px; }
        .stock-tag { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body>

    <div id="authScreen" class="app-container" style="display: flex; height: 100vh; align-items: center; justify-content: center;">
        <div class="card text-center" style="width: 100%; max-width: 400px; padding: 40px 20px;">
            <div style="font-size: 4rem; margin-bottom: 20px; color: var(--primary);">☁️</div>
            <h1 style="color: var(--dark); margin-bottom: 5px;">MeuGado</h1>
            <p style="color: var(--gray); margin-bottom: 30px;">Versão 1.3</p>
            
            <div id="loginFormBlock">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group"><input type="text" id="loginUser" class="form-input" placeholder="Usuário (Login)" required autocomplete="username"></div>
                    <div class="form-group"><input type="password" id="loginPass" class="form-input" placeholder="Senha" required autocomplete="current-password"></div>
                    <button type="submit" class="btn" id="btnLogin"><span>Entrar</span> <i class="fas fa-sign-in-alt"></i></button>
                </form>
                <div class="auth-toggle" onclick="toggleAuthMode('register')">Não tem conta? Registrar-se</div>
            </div>

            <div id="registerFormBlock" class="hidden">
                <form onsubmit="handleRegister(event)">
                    <div class="form-group"><input type="text" id="regUser" class="form-input" placeholder="Novo Usuário (Login)" required></div>
                    <div class="form-group"><input type="text" id="regName" class="form-input" placeholder="Nome Completo" required></div>
                    <div class="form-group"><input type="password" id="regPass" class="form-input" placeholder="Criar Senha" required></div>
                    <button type="submit" class="btn" id="btnRegister"><span>Criar Conta</span> <i class="fas fa-user-plus"></i></button>
                </form>
                <div class="auth-toggle" onclick="toggleAuthMode('login')">Já tem conta? Fazer Login</div>
            </div>
            <p id="authMessage" style="margin-top:20px; color: var(--danger); font-size: 0.9rem;"></p>
        </div>
    </div>

    <div id="appScreen" class="hidden">
        
        <div class="app-container" style="padding-bottom: 0;">
            <div class="header-user">
                <div class="header-title"><h2 id="welcomeMsg">Olá, Produtor</h2><p id="dateDisplay"></p></div>
                <button onclick="logout()" class="btn btn-outline btn-sm"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
            <div id="alertArea"></div>
        </div>

        <div class="app-container" id="mainContent">
            
            <div id="viewDashboard" class="view-section">
                <div class="dashboard-grid">
                    <div class="stat-card" style="border-color: var(--primary);">
                        <i class="fas fa-cow"></i><div class="stat-value" id="dashTotalAnimals">0</div><div class="stat-label">Total Cabeças</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--secondary);">
                        <i class="fas fa-weight-hanging"></i><div class="stat-value" id="dashAvgGMD">0.00</div><div class="stat-label">GMD Médio (kg/dia)</div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-cloud-showers-heavy"></i> Desempenho: Chuva x Peso</h3>
                    <canvas id="rainWeightChart" height="200"></canvas>
                </div>
            </div>

            <div id="viewGroups" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Meus Lotes</h2>
                    <button class="btn btn-sm" onclick="openModal('modalNewGroup')"><i class="fas fa-plus"></i> Novo Lote</button>
                </div>
                <div id="groupsList"></div>
            </div>

            <div id="viewPastures" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Gestão de Pastos</h2>
                    <button class="btn btn-sm" onclick="openModal('modalNewPasture')"><i class="fas fa-plus"></i> Piquete</button>
                </div>
                <div class="card">
                    <h3><i class="fas fa-map-marked-alt"></i> Mapa de Lotação</h3>
                    <div class="paddock-grid" id="pasturesGrid"></div>
                </div>
                <div class="card" style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border-color: #bfdbfe;">
                    <h3><i class="fas fa-cloud-rain"></i> Pluviômetro Digital</h3>
                    <div class="flex-between gap-2">
                        <input type="date" id="rainDate" class="form-input" style="flex:1;">
                        <input type="number" id="rainMm" class="form-input" placeholder="mm" style="flex:1;">
                        <button class="btn btn-secondary" style="width: auto;" onclick="addRainfall()">Lançar</button>
                    </div>
                </div>
            </div>

            <div id="viewStock" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Controle de Estoque</h2>
                    <button class="btn btn-sm btn-secondary" onclick="openModal('modalNewStockItem')"><i class="fas fa-box-open"></i> Novo Item</button>
                </div>
                
                <div class="card" style="background: #f0f9ff; border-color: #bae6fd;">
                    <div class="flex-between">
                        <div><h4>Valor em Estoque</h4><div class="text-sm text-gray">Produtos armazenados</div></div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: var(--secondary);" id="stockTotalValue">R$ 0,00</div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-cubes"></i> Meus Produtos</h3>
                    <div id="inventoryList"></div>
                </div>
            </div>

            <div id="viewFinancial" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Financeiro</h2>
                    <div class="btn-group-row">
                        <button class="btn btn-sm btn-success" onclick="openTransactionModal('income')"><i class="fas fa-plus"></i> Receita</button>
                        <button class="btn btn-sm btn-danger" onclick="openTransactionModal('expense')"><i class="fas fa-minus"></i> Despesa</button>
                    </div>
                </div>

                <div class="card">
                    <div class="financial-summary">
                        <div class="fin-box">
                            <h4>Receitas</h4>
                            <div class="text-success" id="finTotalRevenue">R$ 0,00</div>
                        </div>
                        <div class="fin-box">
                            <h4>Despesas</h4>
                            <div class="text-danger" id="finTotalExpense">R$ 0,00</div>
                        </div>
                        <div class="fin-box" style="background-color: #f8fafc;">
                            <h4>Saldo Líquido</h4>
                            <div id="finNetProfit">R$ 0,00</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-list"></i> Histórico</h3>
                    <div id="financialList"></div>
                </div>
            </div>
        </div>

        <div class="nav-bar">
            <div class="nav-item active" onclick="switchView('viewDashboard', this)">
                <i class="fas fa-chart-pie"></i> Dash
            </div>
            <div class="nav-item" onclick="switchView('viewGroups', this)">
                <i class="fas fa-layer-group"></i> Lotes
            </div>
            <div class="nav-item" onclick="switchView('viewPastures', this)">
                <i class="fas fa-seedling"></i> Pastos
            </div>
            <div class="nav-item" onclick="switchView('viewStock', this)">
                <i class="fas fa-boxes"></i> Estoque
            </div>
            <div class="nav-item" onclick="switchView('viewFinancial', this)">
                <i class="fas fa-wallet"></i> Caixa
            </div>
        </div>

    </div>

    <div id="modalNewGroup" class="modal">
        <div class="modal-content">
            <h3>Novo Lote de Animais</h3>
            <div class="form-group"><label>Nome do Lote</label><input type="text" id="newGroupName" class="form-input"></div>
            <div class="form-group"><label>Categoria</label>
                <select id="newGroupCategory" class="form-input">
                    <option>Bezerros</option><option>Garrotes</option><option>Novilhas</option><option>Vacas</option><option>Touros</option>
                </select>
            </div>
            <div class="form-group">
                <label>Valor Total de Compra (R$)</label>
                <input type="number" id="newGroupInitialCost" class="form-input" placeholder="0.00" step="0.01">
                <div class="text-sm text-gray" style="margin-top: 5px;">Custo inicial do lote (será adicionado ao histórico e despesas).</div>
            </div>
            <button class="btn" onclick="createGroup()">Salvar Lote</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalNewGroup')">Cancelar</button>
        </div>
    </div>

    <div id="modalNewPasture" class="modal">
        <div class="modal-content">
            <h3>Cadastrar Piquete</h3>
            <div class="form-group"><label>Identificação (Ex: Piquete 01)</label><input type="text" id="newPastureName" class="form-input"></div>
            <div class="form-group"><label>Área em Hectares (ha)</label><input type="number" id="newPastureArea" class="form-input"></div>
            <div class="form-group"><label>Tipo de Forrageira</label><input type="text" id="newPastureGrass" class="form-input" placeholder="Ex: Brachiaria Brizantha"></div>
            <button class="btn" onclick="createPasture()">Salvar Piquete</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalNewPasture')">Cancelar</button>
        </div>
    </div>

    <div id="modalNewStockItem" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-cart-plus"></i> Entrada de Estoque</h3>
            <p class="text-sm text-gray" style="margin-bottom:15px;">Adicione quantidade e o valor total gasto.</p>

            <div class="form-group">
                <label>Nome do Produto</label>
                <input type="text" id="stockName" class="form-input" placeholder="Ex: Ração, Ivermectina...">
            </div>

            <div class="form-group">
                <label>Categoria</label>
                <select id="stockCategory" class="form-input">
                    <option value="Ração">Ração / Nutrição</option>
                    <option value="Sal Mineral">Sal Mineral</option>
                    <option value="Vacina">Vacina</option>
                    <option value="Medicamento">Medicamento</option>
                    <option value="Outros">Outros Materiais</option>
                </select>
            </div>

            <div class="flex-between gap-2">
                <div class="form-group" style="flex:1">
                    <label>Qtd Comprada</label>
                    <input type="number" id="stockQty" class="form-input" placeholder="Ex: 50" step="0.01">
                </div>
                <div class="form-group" style="flex:1">
                    <label>Unidade</label>
                    <select id="stockUnit" class="form-input">
                        <option value="kg">Kg (Quilos)</option>
                        <option value="ml">ml (Mililitros)</option>
                        <option value="lt">Lt (Litros)</option>
                        <option value="ds">Doses</option>
                        <option value="un">Unid.</option>
                        <option value="sc">Sacos</option>
                        <option value="fr">Frascos</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Valor TOTAL Gasto (R$)</label>
                <input type="number" id="stockTotalSpend" class="form-input" placeholder="0.00" oninput="calculateUnitCost()">
                <div class="text-sm text-gray text-center" id="unitCostDisplay" style="margin-top:5px;">Custo Unitário: R$ 0,00</div>
            </div>

            <div class="form-group">
                <label style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="autoLaunchFinance" checked> 
                    Lançar Despesa no Financeiro automaticamente?
                </label>
            </div>

            <button class="btn btn-secondary" onclick="addStockItem()">Adicionar ao Estoque</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalNewStockItem')">Cancelar</button>
        </div>
    </div>

    <div id="modalGroupDetails" class="modal">
        <div class="modal-content">
            <div class="flex-between">
                <h3 id="detailGroupTitle">Lote</h3>
                <span class="badge badge-success" id="detailGroupStatus">ATIVO</span>
            </div>
            <p id="detailGroupSubtitle" class="text-sm text-gray" style="margin-bottom: 15px;"></p>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('tabOverview', event)">Resumo</div>
                <div class="tab" onclick="switchTab('tabStockUse', event)">Usar Estoque</div>
                <div class="tab" onclick="switchTab('tabWeights', event)">Pesagem</div>
                <div class="tab" onclick="switchTab('tabAnimals', event)">Animais</div>
                <div class="tab" onclick="switchTab('tabSim', event)">Simulador</div>
            </div>

            <div id="tabOverview" class="tab-content">
                <div class="card" style="background: #f8fafc;">
                    <h4><i class="fas fa-calculator"></i> Custos & Desempenho</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <span class="text-sm text-gray">GMD Atual</span>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);" id="calcGMD">0.000</div>
                        </div>
                        <div>
                            <span class="text-sm text-gray">Custo Total Lote</span>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--danger);" id="calcTotalCost">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Movimentação de Pasto</label>
                    <select id="movePastureSelect" class="form-input" onchange="moveGroup(this.value)"></select>
                </div>
            </div>

            <div id="tabStockUse" class="tab-content hidden">
                <div class="card" style="background: #eff6ff; border: 1px solid #bfdbfe;">
                    <label style="color:var(--secondary); font-weight:bold;">1. O que foi usado?</label>
                    <select id="useStockType" class="form-input" onchange="populateStockUsageSelect()" style="margin-bottom:10px;">
                        <option value="nutrition">Nutrição (Ração/Sal)</option>
                        <option value="health">Sanitário (Vacina/Remédio)</option>
                        <option value="other">Outros</option>
                    </select>

                    <label style="color:var(--secondary); font-weight:bold; margin-top:15px;">2. Tipo de Uso</label>
                    <div class="flex-between gap-2" style="margin-bottom: 15px;">
                        <label style="flex:1; display:flex; align-items:center; gap:5px; font-weight:normal;">
                            <input type="radio" name="usageScope" value="lot" id="scopeLot" checked onchange="toggleIndividualUsage()"> Uso no Lote
                        </label>
                        <label style="flex:1; display:flex; align-items:center; gap:5px; font-weight:normal;">
                            <input type="radio" name="usageScope" value="individual" id="scopeIndividual" onchange="toggleIndividualUsage()"> Uso Individual
                        </label>
                    </div>
                    
                    <div id="individualAnimalSelect" class="form-group hidden">
                        <label class="text-sm">Animal Alvo (Brinco/ID)</label>
                        <select id="useAnimalId" class="form-input"></select>
                    </div>
                    <label class="text-sm">Selecione o Produto do Estoque</label>
                    <select id="useStockProduct" class="form-input" style="margin-bottom:10px;"></select>

                    <div id="usageBlockNutrition"> 
                        <label class="text-sm" id="labelQtyTotal">Quantidade Total fornecida ao lote</label>
                        <div class="flex-between gap-2">
                            <input type="number" id="useQtyTotal" class="form-input" placeholder="Ex: 40">
                            <span id="useUnitDisplay1" style="font-weight:bold;">kg</span>
                        </div>
                    </div>

                    <div id="usageBlockHealth" class="hidden">
                        <label class="text-sm">Dose por Animal</label>
                        <div class="flex-between gap-2">
                            <input type="number" id="useDosePerAnimal" class="form-input" placeholder="Ex: 5">
                            <span id="useUnitDisplay2" style="font-weight:bold;">ml</span>
                        </div>
                        <div class="text-sm text-gray" id="healthDoseHint" style="margin-top:5px;">O sistema multiplicará pela quantidade de animais.</div>
                        
                        <label class="text-sm" style="margin-top:10px;">Carência (Dias)</label>
                        <input type="number" id="useWithdrawal" class="form-input" placeholder="0">
                    </div>

                    <label class="text-sm" style="margin-top:10px;">Data da Aplicação/Uso</label>
                    <input type="date" id="useDate" class="form-input">

                    <button class="btn btn-secondary" style="margin-top:15px;" onclick="confirmStockUsage()">Confirmar Uso e Custo</button>
                </div>

                <h4 style="margin-top:20px;">Histórico de Custos do Lote</h4>
                <div id="groupCostList"></div>
            </div>

            <div id="tabWeights" class="tab-content hidden">
                <div class="card">
                    <label>Nova Pesagem do Lote (Média)</label>
                    <div class="flex-between gap-2">
                        <input type="date" id="weightDate" class="form-input">
                        <input type="number" id="weightValue" class="form-input" placeholder="Kg Médio">
                        <button class="btn btn-sm" onclick="addWeight()">Salvar</button>
                    </div>
                </div>
                <div id="weightHistoryList" style="margin-top: 10px;"></div>
            </div>

            <div id="tabAnimals" class="tab-content hidden">
                <div class="form-group">
                    <div class="flex-between gap-2">
                        <input type="text" id="newAnimalId" class="form-input" placeholder="ID/Brinco/RFID">
                        <button class="btn btn-sm" onclick="addAnimalToGroup()">Adicionar</button>
                    </div>
                </div>
                <div id="animalList" style="max-height: 250px; overflow-y: auto;"></div>
            </div>

            <div id="tabSim" class="tab-content hidden">
                <div class="card" style="border: 1px solid #fed7aa; background-color: #fffaf0;">
                    <h4><i class="fas fa-stopwatch"></i> Previsão de Abate</h4>
                    <div class="form-group"><label>Data Prevista</label><input type="date" id="simDate" class="form-input"></div>
                    <div class="form-group"><label>GMD Projetado (kg/dia)</label><input type="number" id="simGMD" class="form-input" step="0.01"></div>
                    <div class="form-group"><label>Preço Venda Arroba (R$)</label><input type="number" id="simPrice" class="form-input"></div>
                    <button class="btn btn-accent" onclick="runSimulation()">Calcular</button>
                    <div id="simResult" class="sim-result-box hidden">
                        <div class="flex-between"><span>Peso Proj:</span><strong id="resWeight">0</strong></div>
                        <div class="flex-between" style="color:var(--primary);"><span>Receita Total:</span><strong id="resRevenue">R$ 0,00</strong></div>
                    </div>
                </div>
            </div>

            <button class="btn btn-outline" style="margin-top: 20px;" onclick="closeModal('modalGroupDetails')">Fechar</button>
        </div>
    </div>

    <div id="modalEditAnimal" class="modal">
        <div class="modal-content">
            <h3>Editar Animal</h3>
            <div class="form-group">
                <label>Brinco/ID</label>
                <input type="text" id="editAnimalIdInput" class="form-input">
            </div>
            <div class="form-group">
                <label>Peso Individual (kg)</label>
                <input type="number" id="editAnimalWeightInput" class="form-input" placeholder="0.00" step="0.01">
            </div>
            <input type="hidden" id="editAnimalIndex">
            <button class="btn" onclick="saveAnimalEdit()">Salvar Alteração</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalEditAnimal')">Cancelar</button>
        </div>
    </div>

    <div id="modalTransaction" class="modal">
        <div class="modal-content">
            <h3 id="transTitle">Nova Transação</h3>
            <div class="form-group">
                <label>Descrição</label>
                <input type="text" id="transDesc" class="form-input" placeholder="Ex: Venda Lote 01, Energia...">
            </div>
            <div class="form-group">
                <label>Valor Total (R$)</label>
                <input type="number" id="transAmount" class="form-input" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="transDate" class="form-input">
            </div>
            <input type="hidden" id="transType">
            <button class="btn" id="btnSaveTrans" onclick="addTransaction()">Salvar</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalTransaction')">Cancelar</button>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyKezs7gqjE9HUw_HjUMqA7ofxc5Sp9Bc",
            authDomain: "meu-gado-site.firebaseapp.com",
            projectId: "meu-gado-site",
            storageBucket: "meu-gado-site.firebasestorage.app",
            messagingSenderId: "913921456792",
            appId: "1:913921456792:web:5f1ccdbf20d423ee822eed",
            measurementId: "G-MYK82JG8E2"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DATA STRUCTURE ---
        let currentUser = null; 
        let appData = {
            groups: [], 
            pastures: [], 
            rainfall: [],
            financials: [],
            inventory: [], 
            market: { price: 0 }
        };

        // --- INIT ---
        window.onload = function() {
            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long'});
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
        };

        // --- CLOUD SYNC ---
        async function loadData(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    const data = doc.data();
                    appData.groups = data.groups || [];
                    appData.pastures = data.pastures || [];
                    appData.rainfall = data.rainfall || [];
                    appData.financials = data.financials || [];
                    appData.inventory = data.inventory || [];
                } else {
                    appData = { groups: [], pastures: [], rainfall: [], financials: [], inventory: [] };
                    await saveData(); 
                }
                renderAll();
            } catch (error) {
                console.error("Erro ao carregar:", error);
                alert("Erro ao carregar dados.");
            }
        }

        async function saveData() {
            if (!currentUser) return;
            try {
                await db.collection('users').doc(currentUser.id).set(appData, { merge: true });
            } catch (error) {
                console.error("Erro ao salvar:", error);
            }
        }

        // --- AUTH LOGIC ---
        function toggleAuthMode(mode) {
            document.getElementById('authMessage').innerText = '';
            if(mode === 'register') {
                document.getElementById('loginFormBlock').classList.add('hidden');
                document.getElementById('registerFormBlock').classList.remove('hidden');
            } else {
                document.getElementById('loginFormBlock').classList.remove('hidden');
                document.getElementById('registerFormBlock').classList.add('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value;
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('authMessage');

            if(!user || !pass) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            msg.innerText = '';

            const userId = user.toLowerCase().replace(/[^a-z0-9_]/g, '_');

            try {
                const authDoc = await db.collection('auth').doc(userId).get();
                if (!authDoc.exists) throw new Error('Usuário não encontrado.');
                const authData = authDoc.data();
                if (authData.passwordHash !== btoa(pass + userId)) throw new Error('Senha incorreta.');

                currentUser = { id: userId, name: authData.userName, fullName: authData.fullName };
                await loadData(userId);

                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('welcomeMsg').innerText = `Olá, ${currentUser.fullName.split(' ')[0]}`;

            } catch (error) {
                msg.innerText = error.message;
                btn.disabled = false;
                btn.innerHTML = '<span>Entrar</span> <i class="fas fa-sign-in-alt"></i>';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const user = document.getElementById('regUser').value.trim();
            const name = document.getElementById('regName').value.trim();
            const pass = document.getElementById('regPass').value;
            const btn = document.getElementById('btnRegister');
            const msg = document.getElementById('authMessage');

            if(user.length < 3) { msg.innerText = "Usuário muito curto."; return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';

            const userId = user.toLowerCase().replace(/[^a-z0-9_]/g, '_');

            try {
                const authDoc = await db.collection('auth').doc(userId).get();
                if (authDoc.exists) throw new Error('Este usuário já existe.');

                await db.collection('auth').doc(userId).set({
                    userName: user, fullName: name, passwordHash: btoa(pass + userId), createdAt: new Date().toISOString()
                });

                currentUser = { id: userId, name: user, fullName: name };
                appData = { groups: [], pastures: [], rainfall: [], financials: [], inventory: [] };
                await saveData();

                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('welcomeMsg').innerText = `Olá, ${name.split(' ')[0]}`;

            } catch (error) {
                msg.innerText = error.message;
                btn.disabled = false;
                btn.innerHTML = '<span>Criar Conta</span> <i class="fas fa-user-plus"></i>';
            }
        }

        function logout() {
            if(confirm('Sair do sistema?')) { location.reload(); }
        }

        // --- CORE FUNCTIONS ---
        function calculateGMD(group) {
            if (!group.weighings || group.weighings.length < 2) return 0;
            const sorted = [...group.weighings].sort((a,b) => new Date(a.date) - new Date(b.date));
            const last = sorted[sorted.length - 1];
            const prev = sorted[sorted.length - 2];
            const diffTime = Math.abs(new Date(last.date) - new Date(prev.date));
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return 0;
            return ((last.weight - prev.weight) / diffDays).toFixed(3);
        }

        // NOVO: Função para obter o peso médio atual (prefere individual)
        function getCurrentLotWeight(group) {
            if (group.animals && group.animals.length > 0) {
                const animalsWithWeight = group.animals.filter(a => a.weight > 0);
                if (animalsWithWeight.length > 0) {
                    const totalWeight = animalsWithWeight.reduce((sum, a) => sum + a.weight, 0);
                    return { weight: (totalWeight / animalsWithWeight.length), source: 'INDIVIDUAL' };
                }
            }
            // Fallback para a última pesagem do lote
            if (group.weighings && group.weighings.length > 0) {
                return { weight: group.weighings[group.weighings.length - 1].weight, source: 'LOTE' };
            }
            return { weight: 0, source: 'N/A' };
        }

        function calculateGroupCost(group) {
            let total = 0;
            if(group.costHistory) {
                total += group.costHistory.reduce((a, b) => a + b.totalCost, 0);
            }
            return total.toFixed(2);
        }

        function getStockingRate(pastureId) {
            const pasture = appData.pastures.find(p => p.id == pastureId);
            if (!pasture || !pasture.area) return 0;
            let totalWeight = 0;
            appData.groups.forEach(g => {
                if (g.currentPastureId == pastureId) {
                    // Usa o peso médio atual, seja do lote ou individual
                    const currentWeight = getCurrentLotWeight(g).weight; 
                    const qtd = g.animals && g.animals.length > 0 ? g.animals.length : (g.quantity || 0);
                    totalWeight += (currentWeight * qtd);
                }
            });
            const ua = totalWeight / 450; 
            return (ua / pasture.area).toFixed(2);
        }

        // --- ACTIONS: GROUP & PASTURE ---
        async function createGroup() {
            const name = document.getElementById('newGroupName').value;
            const category = document.getElementById('newGroupCategory').value;
            const initialCost = parseFloat(document.getElementById('newGroupInitialCost').value) || 0;
            
            if(!name) return;
            
            const newGroup = {
                id: Date.now(), 
                name, 
                category, 
                quantity: 0, 
                animals: [], 
                weighings: [], 
                health: [], 
                costHistory: [], 
                currentPastureId: null
            };

            // Adiciona o custo inicial ao histórico
            if (initialCost > 0) {
                newGroup.costHistory.push({
                    date: new Date().toISOString().split('T')[0],
                    itemName: "Compra Inicial do Lote",
                    category: "Custo Fixo",
                    qty: 1,
                    unit: 'un',
                    totalCost: initialCost,
                    isInitialCost: true
                });
                
                // === CORREÇÃO: Adicionar ao Financeiro (Despesa) ===
                appData.financials.push({
                    id: Date.now() + 1,
                    type: 'expense',
                    desc: `Compra Lote: ${name}`,
                    amount: initialCost,
                    date: new Date().toISOString().split('T')[0],
                    isGroupPurchase: true
                });
                // ==============================================
            }

            appData.groups.push(newGroup);
            await saveData();
            closeModal('modalNewGroup');
            
            // Limpa inputs
            document.getElementById('newGroupName').value = '';
            document.getElementById('newGroupInitialCost').value = ''; 

            renderAll();
        }

        async function createPasture() {
            const name = document.getElementById('newPastureName').value;
            const area = parseFloat(document.getElementById('newPastureArea').value);
            const grass = document.getElementById('newPastureGrass').value;
            if(!name || !area) return;
            appData.pastures.push({ id: Date.now(), name, area, grass });
            await saveData();
            closeModal('modalNewPasture');
            renderAll();
        }

        async function addRainfall() {
            const date = document.getElementById('rainDate').value;
            const mm = parseFloat(document.getElementById('rainMm').value);
            if(date && mm >= 0) {
                const existing = appData.rainfall.find(r => r.date === date);
                if(existing) existing.mm = mm;
                else appData.rainfall.push({date, mm});
                appData.rainfall.sort((a,b) => new Date(a.date) - new Date(b.date));
                await saveData();
                alert('Chuva registrada!');
                renderAll();
            }
        }

        // --- ESTOQUE ---
        function calculateUnitCost() {
            const qty = parseFloat(document.getElementById('stockQty').value) || 0;
            const total = parseFloat(document.getElementById('stockTotalSpend').value) || 0;
            const display = document.getElementById('unitCostDisplay');
            if(qty > 0 && total > 0) {
                display.innerText = `Custo Unitário: R$ ${(total / qty).toFixed(2)}`;
            } else {
                display.innerText = `Custo Unitário: R$ 0,00`;
            }
        }

        async function addStockItem() {
            const name = document.getElementById('stockName').value;
            const category = document.getElementById('stockCategory').value;
            const unit = document.getElementById('stockUnit').value;
            const qty = parseFloat(document.getElementById('stockQty').value);
            const totalSpend = parseFloat(document.getElementById('stockTotalSpend').value);
            const autoLaunch = document.getElementById('autoLaunchFinance').checked;

            if(!name || !qty || !totalSpend) { alert("Preencha todos os campos."); return; }

            // Verifica se já existe produto com mesmo nome E unidade
            let existingItem = appData.inventory.find(i => i.name.toLowerCase() === name.toLowerCase() && i.unit === unit);
            
            if(existingItem) {
                // Média ponderada do custo
                const totalValueOld = existingItem.currentQty * existingItem.avgPrice;
                const totalValueNew = totalSpend;
                const newQty = existingItem.currentQty + qty;
                existingItem.avgPrice = (totalValueOld + totalValueNew) / newQty;
                existingItem.currentQty = newQty;
            } else {
                appData.inventory.push({
                    id: Date.now(),
                    name: name,
                    category: category,
                    unit: unit,
                    avgPrice: totalSpend / qty,
                    currentQty: qty
                });
            }

            if(autoLaunch) {
                appData.financials.push({
                    id: Date.now(),
                    type: 'expense',
                    desc: `Compra Estoque: ${name}`,
                    amount: totalSpend,
                    date: new Date().toISOString().split('T')[0],
                    isStock: true
                });
            }

            await saveData();
            closeModal('modalNewStockItem');
            
            document.getElementById('stockName').value = '';
            document.getElementById('stockQty').value = '';
            document.getElementById('stockTotalSpend').value = '';
            
            renderAll();
        }

        // --- USO DE ESTOQUE ---
        let activeGroupId = null;

        function openGroupDetails(id) {
            activeGroupId = id;
            const group = appData.groups.find(g => g.id == id);
            
            document.getElementById('detailGroupTitle').innerText = group.name;
            document.getElementById('detailGroupSubtitle').innerText = `${group.category} • ${group.animals.length || group.quantity} animais`;

            const inWithdrawal = group.health && group.health.some(h => new Date(h.withdrawEnd) >= new Date());
            const statusBadge = document.getElementById('detailGroupStatus');
            statusBadge.className = inWithdrawal ? 'badge badge-danger' : 'badge badge-success';
            statusBadge.innerText = inWithdrawal ? 'EM CARÊNCIA' : 'LIBERADO';

            document.getElementById('calcGMD').innerText = `${calculateGMD(group)} kg/dia`;
            document.getElementById('calcTotalCost').innerText = `R$ ${calculateGroupCost(group)}`;

            // Reset Tab Estoque
            document.getElementById('useDate').value = new Date().toISOString().split('T')[0];
            
            // Popula o seletor de animal individual
            const animalSelect = document.getElementById('useAnimalId');
            animalSelect.innerHTML = group.animals.map(a => `<option value="${a.id}">${a.id}</option>`).join('') || 
                                     '<option value="">Nenhum animal cadastrado</option>';

            // Reseta o escopo de uso e atualiza o estado dos inputs
            document.getElementById('scopeLot').checked = true; // Default para uso no lote
            toggleIndividualUsage(); // Chama para aplicar o estado inicial (Uso no Lote)

            renderGroupCostHistory(group);
            renderWeightList(group);
            renderAnimalList(group);
            
            const pSelect = document.getElementById('movePastureSelect');
            pSelect.innerHTML = '<option value="">Sem pasto definido</option>' + 
                appData.pastures.map(p => `<option value="${p.id}" ${group.currentPastureId == p.id ? 'selected' : ''}>${p.name}</option>`).join('');

            openModal('modalGroupDetails');
        }

        // Altera os labels e visibilidade com base no escopo de uso
        function toggleIndividualUsage() {
            const scope = document.querySelector('input[name="usageScope"]:checked').value;
            const individualSelect = document.getElementById('individualAnimalSelect');
            const healthDoseHint = document.getElementById('healthDoseHint');
            const labelQtyTotal = document.getElementById('labelQtyTotal');

            if (scope === 'individual') {
                individualSelect.classList.remove('hidden');
                healthDoseHint.innerText = 'Quantidade utilizada é a dose única (Ex: 5ml).';
                labelQtyTotal.innerText = 'Quantidade/Dose única utilizada';
            } else {
                individualSelect.classList.add('hidden');
                healthDoseHint.innerText = 'O sistema multiplicará pela quantidade de animais.';
                labelQtyTotal.innerText = 'Quantidade Total fornecida ao lote';
            }
            populateStockUsageSelect(); // Para re-renderizar unidades se necessário
        }


        function populateStockUsageSelect() {
            const type = document.getElementById('useStockType').value;
            const select = document.getElementById('useStockProduct');
            const list = appData.inventory || [];
            
            let filtered = [];
            
            // Esconde/Mostra inputs baseados no tipo
            document.getElementById('usageBlockNutrition').classList.add('hidden');
            document.getElementById('usageBlockHealth').classList.add('hidden');

            if(type === 'nutrition') {
                filtered = list.filter(i => (i.category === 'Ração' || i.category === 'Sal Mineral') && i.currentQty > 0);
                document.getElementById('usageBlockNutrition').classList.remove('hidden');
            } else if (type === 'health') {
                filtered = list.filter(i => (i.category === 'Vacina' || i.category === 'Medicamento') && i.currentQty > 0);
                document.getElementById('usageBlockHealth').classList.remove('hidden');
            } else {
                filtered = list.filter(i => i.category === 'Outros' && i.currentQty > 0);
                document.getElementById('usageBlockNutrition').classList.remove('hidden');
            }

            select.innerHTML = '<option value="">Selecione...</option>' + 
                filtered.map(i => `<option value="${i.id}" data-unit="${i.unit}">${i.name} (Disp: ${parseFloat(i.currentQty).toFixed(2)} ${i.unit})</option>`).join('');

            // Atualiza labels de unidade
            select.onchange = function() {
                const opt = select.options[select.selectedIndex];
                const u = opt ? (opt.getAttribute('data-unit') || '--') : '--';
                document.getElementById('useUnitDisplay1').innerText = u;
                document.getElementById('useUnitDisplay2').innerText = u;
            }
        }

        async function confirmStockUsage() {
            const group = appData.groups.find(g => g.id == activeGroupId);
            const usageType = document.getElementById('useStockType').value;
            const prodId = document.getElementById('useStockProduct').value;
            const date = document.getElementById('useDate').value;
            const scope = document.querySelector('input[name="usageScope"]:checked').value;
            const animalId = document.getElementById('useAnimalId').value;

            if(!prodId || !date) { alert('Selecione um produto e a data.'); return; }
            if(scope === 'individual' && !animalId) { alert('Selecione o animal para uso individual.'); return; }

            // BUSCA CORRIGIDA (numero vs string)
            const product = appData.inventory.find(i => i.id == prodId);
            
            if(!product) { alert('Erro: Produto não encontrado no estoque.'); return; }

            let qtyUsed = 0;
            const numAnimals = group.animals.length || group.quantity || 1;

            if(usageType === 'health') {
                const dose = parseFloat(document.getElementById('useDosePerAnimal').value);
                const withdrawal = parseInt(document.getElementById('useWithdrawal').value) || 0;
                
                if(!dose) { alert('Informe a dose por animal.'); return; }
                
                if (scope === 'individual') {
                    qtyUsed = dose; // Apenas uma dose para um animal
                } else { 
                    qtyUsed = dose * numAnimals; // Dose para todos os animais
                }

                if(qtyUsed > product.currentQty) {
                    alert(`Estoque insuficiente! Você precisa de ${qtyUsed.toFixed(2)} ${product.unit}, mas só tem ${parseFloat(product.currentQty).toFixed(2)} ${product.unit}.`);
                    return;
                }

                if(withdrawal > 0) {
                    const endDate = new Date(date);
                    endDate.setDate(endDate.getDate() + withdrawal);
                    group.health.push({
                        name: product.name,
                        date: date,
                        withdrawDays: withdrawal,
                        withdrawEnd: endDate.toISOString().split('T')[0],
                        scope: scope, 
                        animalId: scope === 'individual' ? animalId : null 
                    });
                }
            } else { // nutrition or other
                qtyUsed = parseFloat(document.getElementById('useQtyTotal').value);
                if(!qtyUsed) { alert('Informe a quantidade utilizada.'); return; }

                if(qtyUsed > product.currentQty) {
                    alert(`Estoque insuficiente! Você precisa de ${qtyUsed.toFixed(2)} ${product.unit}, mas só tem ${parseFloat(product.currentQty).toFixed(2)} ${product.unit}.`);
                    return;
                }
            }

            // Baixa no estoque
            product.currentQty -= qtyUsed;
            const cost = qtyUsed * product.avgPrice;
            
            // Adiciona ao histórico de custo do lote
            group.costHistory.push({
                date: date,
                itemName: product.name,
                category: product.category,
                qty: qtyUsed,
                unit: product.unit,
                totalCost: cost,
                scope: scope,
                animalId: scope === 'individual' ? animalId : null
            });

            await saveData();
            
            alert(`Sucesso! Custo de R$ ${cost.toFixed(2)} lançado.`);
            openGroupDetails(activeGroupId);
            renderAll();
        }

        // Adicionado badge para custo individual/inicial
        function renderGroupCostHistory(group) {
            const list = document.getElementById('groupCostList');
            if(!group.costHistory || group.costHistory.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray text-center">Nenhum custo registrado.</p>';
                return;
            }
            
            list.innerHTML = [...group.costHistory].sort((a,b) => new Date(b.date) - new Date(a.date)).map(c => {
                let scopeInfo = '';
                if (c.scope === 'individual' && c.animalId) {
                    scopeInfo = ` <span class="badge badge-warning">Animal: ${c.animalId}</span>`;
                } else if (c.isInitialCost) {
                    scopeInfo = ' <span class="badge badge-purple">CUSTO INICIAL</span>';
                }

                return `
                <div class="list-item text-sm">
                    <div>
                        <strong>${c.itemName}</strong>${scopeInfo}
                        <span class="text-gray">(${c.qty.toFixed(1)} ${c.unit})</span>
                        <div style="font-size:0.75rem;">${new Date(c.date).toLocaleDateString('pt-BR')}</div>
                    </div>
                    <div class="text-danger font-bold">- R$ ${c.totalCost.toFixed(2)}</div>
                </div>
            `;}).join('');
        }

        // --- SUB-FUNCTIONS ---
        async function moveGroup(pid) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.currentPastureId = pid || null;
            await saveData();
            renderAll();
        }

        async function addWeight() {
            const date = document.getElementById('weightDate').value;
            const weight = parseFloat(document.getElementById('weightValue').value);
            if(!date || !weight) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.weighings.push({date, weight});
            await saveData();
            openGroupDetails(activeGroupId);
            renderAll();
        }

        function renderWeightList(group) {
            const list = document.getElementById('weightHistoryList');
            list.innerHTML = group.weighings.sort((a,b) => new Date(b.date) - new Date(a.date)).map(w => 
                `<div class="list-item text-sm"><span>${new Date(w.date).toLocaleDateString('pt-BR')}</span> <strong>${w.weight} kg</strong></div>`
            ).join('');
        }

        async function addAnimalToGroup() {
            const id = document.getElementById('newAnimalId').value;
            if(!id) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            // MODIFICADO: Adicionando 'weight: 0' como padrão
            group.animals.push({ id, entryDate: new Date().toISOString().split('T')[0], weight: 0 }); 
            group.quantity = group.animals.length;
            document.getElementById('newAnimalId').value = '';
            await saveData();
            renderAnimalList(group);
            renderAll();
        }

        // MODIFICADO: Agora exibe o peso individual
        function renderAnimalList(group) {
            const list = document.getElementById('animalList');
            list.innerHTML = group.animals.map((a, idx) => 
                `<div class="list-item text-sm">
                    <div>
                        <span><i class="fas fa-tag"></i> <strong>${a.id}</strong></span>
                        <div class="text-xs text-gray" style="margin-top:2px;">Peso: ${a.weight ? a.weight.toFixed(2) + ' kg' : 'Não informado'}</div>
                    </div>
                    <div class="btn-group-row">
                        <button class="btn btn-outline btn-sm" onclick="openEditAnimal(${idx})" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="removeAnimal(${idx})" title="Remover"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`
            ).join('');
        }

        function openEditAnimal(idx) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            const animal = group.animals[idx];
            document.getElementById('editAnimalIndex').value = idx;
            document.getElementById('editAnimalIdInput').value = animal.id;
            // NOVO: Preenche o campo de peso
            document.getElementById('editAnimalWeightInput').value = animal.weight || ''; 
            openModal('modalEditAnimal');
        }

        async function saveAnimalEdit() {
            const idx = document.getElementById('editAnimalIndex').value;
            const newId = document.getElementById('editAnimalIdInput').value;
            // NOVO: Lê o peso
            const newWeight = parseFloat(document.getElementById('editAnimalWeightInput').value) || 0; 

            if(!newId) return;
            
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.animals[idx].id = newId;
            group.animals[idx].weight = newWeight; // NOVO: Salva o peso
            
            await saveData();
            closeModal('modalEditAnimal');
            renderAnimalList(group);
            renderAll();
        }

        async function removeAnimal(idx) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.animals.splice(idx, 1);
            group.quantity = group.animals.length;
            await saveData();
            renderAnimalList(group);
            renderAll();
        }

        // --- SIMULATOR ---
        function runSimulation() {
            const date = document.getElementById('simDate').value;
            const gmd = parseFloat(document.getElementById('simGMD').value);
            const price = parseFloat(document.getElementById('simPrice').value);
            
            if(!date || !gmd || !price || !activeGroupId) { alert('Preencha todos os campos.'); return; }

            const group = appData.groups.find(g => g.id == activeGroupId);
            
            // MODIFICADO: Usa a função que prioriza o peso individual
            const currentWeightInfo = getCurrentLotWeight(group);
            const currentWeight = currentWeightInfo.weight; // será 0 se N/A
            
            const qtd = group.animals.length || group.quantity;

            if(currentWeight === 0) { alert('O lote precisa ter o peso médio atual (individual ou por lote) para simulação.'); return; }

            const today = new Date();
            const targetDate = new Date(date);
            const diffTime = targetDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if(diffDays <= 0) { alert('A data deve ser futura.'); return; }

            const futureWeightPerAnimal = currentWeight + (gmd * diffDays);
            const totalWeight = futureWeightPerAnimal * qtd;
            const totalArrobas = totalWeight / 30; 
            const revenue = totalArrobas * price;

            document.getElementById('resWeight').innerText = futureWeightPerAnimal.toFixed(1) + ' kg';
            document.getElementById('resRevenue').innerText = `R$ ${revenue.toFixed(2)}`;
            document.getElementById('simResult').classList.remove('hidden');
        }

        // --- FINANCEIRO ---
        function openTransactionModal(type) {
            document.getElementById('transType').value = type;
            document.getElementById('transDesc').value = '';
            document.getElementById('transAmount').value = '';
            document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transTitle').innerText = type === 'income' ? 'Nova Receita' : 'Nova Despesa';
            document.getElementById('transTitle').className = type === 'income' ? 'text-success' : 'text-danger';
            document.getElementById('btnSaveTrans').className = type === 'income' ? 'btn btn-success' : 'btn btn-danger';
            openModal('modalTransaction');
        }

        async function addTransaction() {
            const type = document.getElementById('transType').value;
            const desc = document.getElementById('transDesc').value;
            const amount = parseFloat(document.getElementById('transAmount').value);
            const date = document.getElementById('transDate').value;
            
            if(!desc || !amount || !date) return;

            appData.financials.push({ id: Date.now(), type, desc, amount, date });
            await saveData();
            closeModal('modalTransaction');
            
            renderAll();
        }

        // --- RENDER ---
        let chartInstance = null;

        function renderAll() {
            // Stats
            let totalAnimals = 0;
            appData.groups.forEach(g => {
                const qtd = g.animals.length || g.quantity;
                totalAnimals += qtd;
            });
            document.getElementById('dashTotalAnimals').innerText = totalAnimals;

            // GMD
            let sumGmd = 0, countGmd = 0;
            appData.groups.forEach(g => {
                const val = parseFloat(calculateGMD(g));
                if(val > 0) { sumGmd += val; countGmd++; }
            });
            document.getElementById('dashAvgGMD').innerText = countGmd ? (sumGmd/countGmd).toFixed(3) : '0.000';

            // Lists (MODIFICADO para usar peso individual)
            document.getElementById('groupsList').innerHTML = appData.groups.map(g => {
                const currentWeightInfo = getCurrentLotWeight(g);
                const displayWeight = currentWeightInfo.weight > 0 ? currentWeightInfo.weight.toFixed(2) : '-';
                const sourceTag = currentWeightInfo.source === 'INDIVIDUAL' ? '<span class="stock-tag">Ind.</span>' : '';

                return `
                <div class="card list-item" onclick="openGroupDetails(${g.id})">
                    <div>
                        <div style="font-weight:bold; color:var(--dark);">${g.name}</div>
                        <div class="text-sm text-gray">${g.category} • ${g.animals.length || g.quantity} cab</div>
                    </div>
                    <div class="text-center">
                        <div style="font-weight:bold; color:var(--primary);">${displayWeight} kg ${sourceTag}</div>
                        <div class="text-sm text-gray">Peso Médio</div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('pasturesGrid').innerHTML = appData.pastures.map(p => {
                const ua = getStockingRate(p.id);
                const groups = appData.groups.filter(g => g.currentPastureId == p.id);
                const isOccupied = groups.length > 0;
                return `
                <div class="paddock-cell ${isOccupied ? 'occupied' : ''}">
                    <strong>${p.name}</strong>
                    <div class="text-sm">${p.area} ha</div>
                    <div style="font-size:0.75rem; margin-top:4px;">${ua} UA/ha</div>
                    ${isOccupied ? `<small style="color:var(--primary-dark); font-weight:bold;">${groups.length} Lotes</small>` : ''}
                </div>`;
            }).join('');

            // Estoque Render
            let stockTotal = 0;
            const inventoryList = document.getElementById('inventoryList');
            if(appData.inventory.length === 0) {
                inventoryList.innerHTML = '<p class="text-center text-gray" style="padding:20px;">Estoque vazio.</p>';
            } else {
                inventoryList.innerHTML = appData.inventory.map(i => {
                    stockTotal += (i.currentQty * i.avgPrice);
                    let badgeClass = 'badge-info';
                    if(i.category === 'Vacina') badgeClass = 'badge-danger';
                    if(i.category === 'Ração') badgeClass = 'badge-success';
                    return `
                    <div class="list-item">
                        <div>
                            <div style="font-weight:bold;">${i.name} <span class="badge ${badgeClass}">${i.category}</span></div>
                            <div class="text-sm text-gray">Custo Médio: R$ ${i.avgPrice.toFixed(2)} / ${i.unit}</div>
                        </div>
                        <div class="text-center">
                            <strong style="font-size:1.1rem; color:var(--primary);">${parseFloat(i.currentQty).toFixed(2)} ${i.unit}</strong>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('stockTotalValue').innerText = `R$ ${stockTotal.toFixed(2)}`;

            // Financeiro
            let totalIncome = 0;
            let totalExpense = 0;
            const listFin = document.getElementById('financialList');
            let allTrans = appData.financials ? [...appData.financials] : [];
            
            allTrans.forEach(t => { if(t.type === 'income') totalIncome += t.amount; else totalExpense += t.amount; });
            allTrans.sort((a,b) => new Date(b.date) - new Date(a.date));

            listFin.innerHTML = allTrans.map(t => {
                const color = t.type === 'income' ? 'text-success' : 'text-danger';
                return `
                <div class="list-item">
                    <div>
                        <div style="font-weight:600;">${t.desc}</div>
                        <div class="text-sm text-gray">${new Date(t.date).toLocaleDateString('pt-BR')}</div>
                    </div>
                    <div class="${color}" style="font-weight:bold;">${t.type === 'income' ? '+' : '-'} R$ ${t.amount.toFixed(2)}</div>
                </div>`;
            }).join('');

            document.getElementById('finTotalRevenue').innerText = `R$ ${totalIncome.toFixed(2)}`;
            document.getElementById('finTotalExpense').innerText = `R$ ${totalExpense.toFixed(2)}`;
            const net = totalIncome - totalExpense;
            const elNet = document.getElementById('finNetProfit');
            elNet.innerText = `R$ ${net.toFixed(2)}`;
            elNet.className = net >= 0 ? 'text-success' : 'text-danger';

            // Chart
            const ctx = document.getElementById('rainWeightChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: appData.rainfall.map(r => r.date.substring(5)),
                    datasets: [
                        { label: 'Chuva (mm)', data: appData.rainfall.map(r=>r.mm), backgroundColor: '#60a5fa', yAxisID: 'y' },
                        { label: 'Peso Simulado', data: appData.rainfall.map(r=>Math.random()*5+300), type: 'line', borderColor: '#059669', yAxisID: 'y1' }
                    ]
                },
                options: { responsive: true, scales: { y: {position:'left'}, y1: {position:'right', grid:{drawOnChartArea:false}} } }
            });
        }

        function switchView(id, nav) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            nav.classList.add('active');
        }

        function switchTab(id, event) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    </script>
</body>
</html>
