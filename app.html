<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MeuGado</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#059669">
    <link rel="apple-touch-icon" href="Verde.jpg">
    <link rel="icon" type="image/jpeg" href="Verde.jpg">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            /* Cores Padrão (Modo Claro) */
            --primary: #059669;       /* Emerald 600 */
            --primary-dark: #047857;  /* Emerald 700 */
            --primary-light: #d1fae5; /* Emerald 100 */
            --secondary: #2563eb;     /* Blue 600 */
            --accent: #d97706;        /* Amber 600 */
            --danger: #dc2626;        /* Red 600 */
            --dark: #1f2937;          /* Gray 800 (Texto Principal) */
            --gray: #6b7280;          /* Gray 500 (Texto Secundário) */
            --light: #f3f4f6;         /* Gray 100 (Fundo Geral) */
            --white: #ffffff;         /* Fundo Cards */
            --border: #f1f5f9;
            --input-bg: #f8fafc;
            --pink: #db2777;          /* Pink 600 - Reprodução */
        }

        /* --- MODO ESCURO (Overrides) --- */
        body.dark-mode {
            --primary: #10b981;       /* Emerald 500 */
            --primary-dark: #059669;
            --primary-light: #064e3b; /* Emerald 900 */
            --secondary: #3b82f6;     /* Blue 500 */
            --accent: #f59e0b;        /* Amber 500 */
            --danger: #ef4444;        /* Red 500 */
            --dark: #f3f4f6;          /* Texto vira Claro */
            --gray: #9ca3af;          /* Texto Secundário mais claro */
            --light: #0f172a;         /* Fundo Geral Escuro (Slate 900) */
            --white: #1e293b;         /* Fundo Cards Escuro (Slate 800) */
            --border: #334155;        /* Bordas mais escuras */
            --input-bg: #0f172a;
            --pink: #f472b6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        /* CORREÇÃO DE OVERFLOW: Garante que nada saia da largura da tela */
        html, body {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            padding-bottom: 90px;
            transition: background-color 0.3s, color 0.3s;
            position: relative;
            min-height: 100vh;
        }

        /* --- MARCA D'ÁGUA (BACKGROUND) --- */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('Branco-removebg-preview.png');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 50%; /* Tamanho da logo no fundo */
            opacity: 0.05; /* Bem suave */
            pointer-events: none;
            z-index: 0;
            transition: filter 0.3s;
        }

        body:not(.dark-mode)::before { filter: invert(1); }

        .app-container, .nav-bar, .modal { position: relative; z-index: 1; }

        /* --- Layout --- */
        .app-container { max-width: 1280px; margin: 0 auto; padding: 16px; width: 100%; }
        
        /* --- Navigation --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--white);
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-between;
            padding: 10px 10px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            z-index: 1000;
            border-top: 1px solid var(--border);
            overflow-x: auto; /* Mantém rolagem apenas na barra se necessário */
            transition: background 0.3s;
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--gray); text-decoration: none; font-size: 0.7rem;
            cursor: pointer; transition: 0.3s; flex: 1; min-width: 50px; padding: 4px 0;
        }

        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item.active i { transform: translateY(-3px); color: var(--primary); }

        /* --- Cards --- */
        .card {
            background: var(--white); border-radius: 16px; padding: 20px;
            margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border); transition: background 0.3s, border-color 0.3s;
            max-width: 100%; /* Segurança extra */
        }

        .card h3 { 
            font-size: 1.1rem; margin-bottom: 15px; color: var(--dark); 
            display: flex; align-items: center; gap: 8px;
        }

        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Reduzi levemente o min para telas muito pequenas */
            gap: 16px; margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white); padding: 20px; border-radius: 16px;
            display: flex; flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
            position: relative; overflow: hidden; /* Importante para o ícone de fundo não vazar */
            border-top: 1px solid var(--border);
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }
        
        .stat-card i {
            position: absolute; right: -10px; bottom: -10px;
            font-size: 4rem; opacity: 0.05; color: var(--dark);
        }

        .stat-value { font-size: 1.75rem; font-weight: 800; color: var(--dark); margin: 5px 0; }
        .stat-label { color: var(--gray); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Lists --- */
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; border-bottom: 1px solid var(--border);
            cursor: pointer; transition: background 0.2s;
            flex-wrap: wrap; /* CORREÇÃO: Permite que itens longos quebrem linha */
            gap: 10px;
        }
        .list-item:hover { background-color: var(--border); }
        .list-item:last-child { border-bottom: none; }

        /* --- Badges --- */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
        .badge-warning { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
        .badge-danger { background: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }
        .badge-success { background: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
        .badge-info { background: #eff6ff; color: #1d4ed8; border: 1px solid #93c5fd; }
        .badge-purple { background: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; }
        .badge-gray { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
        .badge-pink { background: #fce7f3; color: #be185d; border: 1px solid #f9a8d4; }

        body.dark-mode .badge-warning { background: #78350f; color: #fcd34d; border-color: #92400e; }
        body.dark-mode .badge-danger { background: #7f1d1d; color: #fca5a5; border-color: #991b1b; }
        body.dark-mode .badge-success { background: #064e3b; color: #6ee7b7; border-color: #065f46; }
        body.dark-mode .badge-info { background: #1e3a8a; color: #93c5fd; border-color: #1e40af; }
        body.dark-mode .badge-purple { background: #581c87; color: #d8b4fe; border-color: #6b21a8; }
        body.dark-mode .badge-gray { background: #374151; color: #9ca3af; border-color: #4b5563; }
        body.dark-mode .badge-pink { background: #831843; color: #fbcfe8; border-color: #be185d; }

        /* --- Forms & Buttons --- */
        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 20px; border-radius: 10px; font-weight: 600;
            width: 100%; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary-light); }
        
        .btn-danger { background: var(--danger); }
        .btn-success { background: #16a34a; }
        .btn-secondary { background: var(--secondary); }
        .btn-pink { background: var(--pink); color: white; }
        .btn-dark { background: var(--dark); color: white; }

        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; }
        
        /* CORREÇÃO: Adicionado flex-wrap para botões não estourarem a tela */
        .btn-group-row { display: flex; gap: 8px; flex-wrap: wrap; }

        .form-group { margin-bottom: 16px; width: 100%; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: var(--dark); font-size: 0.9rem; }
        .form-input {
            width: 100%; padding: 12px; border: 2px solid var(--border);
            border-radius: 10px; font-size: 1rem; transition: border-color 0.2s;
            background: var(--input-bg); color: var(--dark);
            max-width: 100%; /* Segurança contra overflow */
        }
        .form-input:focus { border-color: var(--primary); }
        .form-input:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- Tabs --- */
        .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 20px; gap: 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab { padding: 10px 5px; cursor: pointer; color: var(--gray); font-weight: 600; white-space: nowrap; position: relative; }
        .tab.active { color: var(--primary); }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--primary); }

        /* --- Modal --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 2000; justify-content: center; align-items: flex-end;
            overflow: hidden; /* Evita rolagem no fundo do modal */
        }
        @media(min-width: 768px) { .modal { align-items: center; } }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: var(--white); color: var(--dark); width: 100%; max-width: 650px;
            border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh;
            overflow-y: auto; animation: slideUp 0.3s ease; border: 1px solid var(--border);
        }
        @media(min-width: 768px) { .modal-content { border-radius: 24px; } }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        
        /* CORREÇÃO: Adicionado flex-wrap para elementos flexíveis não vazarem */
        .flex-between { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            width: 100%;
        }
        
        .gap-2 { gap: 8px; }
        .text-sm { font-size: 0.85rem; }
        .text-xs { font-size: 0.75rem; } 
        .text-gray { color: var(--gray); }
        .text-danger { color: var(--danger); }
        .text-success { color: #16a34a; }
        .text-pink { color: var(--pink); }

        /* Utilitário para inputs lado a lado terem tamanho mínimo e não quebrarem layout */
        .flex-between.gap-2 > .form-input, 
        .flex-between.gap-2 > .form-group {
            min-width: 120px; /* Garante que não fique esmagado */
            flex: 1; /* Ocupa espaço disponível */
        }

        /* --- Specific Components --- */
        .header-user { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .paddock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .paddock-cell { 
            background: var(--white); border: 2px solid var(--border); 
            border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; 
        }
        .paddock-cell:hover { border-color: var(--primary); }
        .paddock-cell.occupied { background: var(--primary-light); border-color: var(--primary); color: var(--primary-dark); }
        body.dark-mode .paddock-cell.occupied { color: #a7f3d0; }
        
        .auth-toggle { margin-top: 15px; font-size: 0.9rem; color: var(--primary); cursor: pointer; text-decoration: underline; }

        .financial-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .fin-box { background: var(--white); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .fin-box div { font-size: 1.1rem; font-weight: bold; }
        
        .sim-result-box { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 16px; margin-top: 16px; }
        body.dark-mode .sim-result-box { background: #064e3b; border-color: #065f46; color: white; }

        .stock-tag { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        body.dark-mode .stock-tag { background: #1e3a8a; color: #bae6fd; }

        .btn-icon-only { padding: 8px 12px; display: flex; align-items: center; justify-content: center; }

        /* Cards coloridos */
        .bg-card-rain { background: linear-gradient(135deg, #eff6ff, #dbeafe); border-color: #bfdbfe; }
        body.dark-mode .bg-card-rain { background: linear-gradient(135deg, #1e3a8a, #172554); border-color: #1e40af; }
        .bg-card-stock { background: #f0f9ff; border-color: #bae6fd; }
        body.dark-mode .bg-card-stock { background: #0c4a6e; border-color: #075985; color: white; }
        .bg-card-calc { background: #f8fafc; }
        body.dark-mode .bg-card-calc { background: #1e293b; }
        .bg-card-use { background: #eff6ff; border: 1px solid #bfdbfe; }
        body.dark-mode .bg-card-use { background: #172554; border-color: #1e40af; }
        .bg-card-sim { border: 1px solid #fed7aa; background-color: #fffaf0; }
        body.dark-mode .bg-card-sim { background-color: #451a03; border-color: #78350f; color: white;}
        .bg-card-repro { border: 1px solid #f9a8d4; background-color: #fdf2f8; }
        body.dark-mode .bg-card-repro { background-color: #831843; border-color: #be185d; color: white; }

        .fin-box-neutral { background-color: #f8fafc; }
        body.dark-mode .fin-box-neutral { background-color: #1e293b; }

        .login-logo { font-size: 4rem; margin-bottom: 20px; color: var(--primary); }

        /* Estilos Legais e Footer */
        .legal-footer { margin-top: 30px; font-size: 0.75rem; color: var(--gray); text-align: center; border-top: 1px solid var(--border); padding-top: 15px; }
        .legal-links { margin-top: 15px; display: flex; justify-content: center; gap: 15px; font-size: 0.8rem; flex-wrap: wrap;}
        .link-term { color: var(--gray); text-decoration: underline; cursor: pointer; }
        .link-term:hover { color: var(--primary); }
        .legal-content-box { font-size: 0.9rem; line-height: 1.5; color: var(--dark); text-align: left; }
        .legal-content-box h4 { margin-top: 15px; margin-bottom: 5px; color: var(--primary); }
        .legal-content-box ul { padding-left: 20px; margin-bottom: 10px; }

        /* --- ESTILOS DE IMPRESSÃO PDF --- */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 20mm;
            position: relative;
            font-family: 'Helvetica', sans-serif;
            color: #000;
        }

        .watermark-img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            opacity: 0.08; /* Marca d'água bem suave */
            z-index: 0;
            pointer-events: none;
        }

        .pdf-header, .pdf-footer, #pdf-body {
            position: relative;
            z-index: 1; /* Fica acima da marca d'agua */
        }

        .pdf-footer {
            position: absolute;
            bottom: 10mm;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.7rem;
            color: #999;
        }

        /* Tabelas para o PDF */
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        .pdf-table th {
            background-color: #059669;
            color: white;
            padding: 8px;
            text-align: left;
        }
        .pdf-table td {
            border-bottom: 1px solid #ddd;
            padding: 8px;
        }
        .pdf-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .text-right { text-align: right; }

        /* --- DESKTOP / DASHBOARD MODE (Telas grandes) --- */
        @media (min-width: 1024px) {

            /* 1. Ajuste Geral do Layout */
            body {
                /* Removemos o padding do body para não afetar o Login */
                padding-bottom: 0;
                background-color: var(--input-bg); 
            }

            /* Aplicamos o espaço do menu APENAS na área do App Logado */
            #appScreen {
                padding-left: 260px;
            }

            .app-container {
                max-width: 1600px; /* Permite que o conteúdo estique mais */
                padding: 30px;
            }

            /* 2. Transformar Nav-Bar inferior em Sidebar Lateral */
            .nav-bar {
                top: 0;
                left: 0;
                bottom: auto;
                width: 250px;
                height: 100vh; /* Altura total */
                flex-direction: column; /* Itens um embaixo do outro */
                justify-content: flex-start;
                padding: 20px;
                border-top: none;
                border-right: 1px solid var(--border);
                background: var(--white);
                box-shadow: 4px 0 24px rgba(0,0,0,0.02);
                overflow-y: auto; /* Rolagem vertical no menu */
            }

            /* Adicionar logo fictícia no topo do menu lateral via CSS */
            .nav-bar::before {
                content: "MeuGado";
                font-size: 1.5rem;
                font-weight: 800;
                color: var(--primary);
                margin-bottom: 30px;
                padding-left: 15px;
                display: block;
            }

            .nav-item {
                flex: 0 0 auto;
                width: 100%;
                flex-direction: row; /* Ícone ao lado do texto */
                gap: 15px;
                padding: 12px 15px;
                margin-bottom: 8px;
                border-radius: 10px;
                font-size: 0.95rem;
                justify-content: flex-start; /* Alinha à esquerda */
            }

            .nav-item i {
                font-size: 1.1rem;
                margin-bottom: 0;
                width: 24px;
                text-align: center;
            }
            
            .nav-item:hover {
                background-color: var(--light);
            }

            .nav-item.active {
                background-color: var(--primary-light);
                color: var(--primary-dark);
            }
            .nav-item.active i {
                transform: none; /* Remove a animação de "pulo" do mobile */
            }

            /* 3. Reorganizar o Dashboard (Grid) */
            #viewDashboard {
                display: grid;
                grid-template-columns: 3fr 2fr; /* Coluna maior p/ stats, menor p/ gráfico */
                gap: 24px;
                align-items: start;
            }

            /* Cards de Estatística (Cabeças, GMD) lado a lado */
            .dashboard-grid {
                grid-column: 1 / -1; /* Ocupa largura total */
                display: grid;
                grid-template-columns: repeat(4, 1fr); /* 4 cards por linha */
                gap: 20px;
            }

            .stat-card {
                padding: 24px;
                height: 100%;
                transition: transform 0.2s;
            }
            .stat-card:hover {
                transform: translateY(-5px);
            }

            /* 4. Melhorar Visualização de Tabelas/Listas */
            /* Faz os itens de lista parecerem uma tabela real */
            .list-item {
                padding: 15px 24px;
                border: 1px solid var(--border);
                margin-bottom: 8px;
                border-radius: 8px;
                display: grid;
                grid-template-columns: 1fr auto; /* Força estrutura */
                align-items: center;
            }

            /* Grid de Pastos */
            .paddock-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 20px;
            }

            /* 5. Modais Estilo Desktop (Centralizados) */
            .modal {
                align-items: center; /* Centraliza verticalmente */
                backdrop-filter: blur(8px); /* Blur mais forte no fundo */
            }

            .modal-content {
                max-width: 500px;
                border-radius: 16px; /* Arredondado completo */
                box-shadow: 0 20px 50px -12px rgba(0,0,0,0.25);
                border: 1px solid var(--border);
                max-height: 85vh;
            }

            /* Ajuste específico para o modal de Relatórios ou Detalhes que são grandes */
            #modalReports .modal-content, #modalGroupDetails .modal-content, #modalLegal .modal-content {
                max-width: 800px; /* Mais largo no PC */
            }

            /* 6. Header do Usuário */
            .header-user {
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 1px solid var(--border);
            }
            
            /* Botões maiores e mais visíveis */
            .btn {
                padding: 12px 24px;
            }
        }
    </style>
</head>
<body>

    <div id="authScreen" class="app-container" style="display: flex; height: 100vh; align-items: center; justify-content: center;">
        <div class="card text-center" style="width: 100%; max-width: 400px; padding: 40px 20px;">
            <div class="login-logo">☁️</div>
            <h1 style="color: var(--dark); margin-bottom: 5px;">MeuGado</h1>
            <p style="color: var(--gray); margin-bottom: 30px;">Versão 1.5</p>
            
            <div id="loginFormBlock">
                <form onsubmit="handleLogin(event)">
                    <div class="form-group"><input type="text" id="loginUser" class="form-input" placeholder="Usuário (Login)" required autocomplete="username"></div>
                    <div class="form-group"><input type="password" id="loginPass" class="form-input" placeholder="Senha" required autocomplete="current-password"></div>
                    <button type="submit" class="btn" id="btnLogin"><span>Entrar</span> <i class="fas fa-sign-in-alt"></i></button>
                </form>
                <div class="auth-toggle" onclick="toggleAuthMode('register')">Não tem conta? Registrar-se</div>
            </div>

            <div id="registerFormBlock" class="hidden">
                <form onsubmit="handleRegister(event)">
                    <div class="form-group"><input type="text" id="regUser" class="form-input" placeholder="Novo Usuário (Login)" required></div>
                    <div class="form-group"><input type="text" id="regName" class="form-input" placeholder="Nome Completo" required></div>
                    <div class="form-group"><input type="password" id="regPass" class="form-input" placeholder="Criar Senha" required></div>
                    <button type="submit" class="btn" id="btnRegister"><span>Criar Conta</span> <i class="fas fa-user-plus"></i></button>
                </form>
                <div class="auth-toggle" onclick="toggleAuthMode('login')">Já tem conta? Fazer Login</div>
            </div>
            <p id="authMessage" style="margin-top:20px; color: var(--danger); font-size: 0.9rem;"></p>

            <div class="legal-links">
                <span class="link-term" onclick="openLegal('terms')">Termos de Uso</span>
                <span class="link-term" onclick="openLegal('privacy')">Privacidade</span>
                <span class="link-term" onclick="openLegal('eula')">EULA</span>
            </div>
            <div class="legal-footer">
                <p>63.992.533 JOAO GUILHERME POZZEBON LORENZ</p>
            </div>
        </div>
    </div>

    <div id="appScreen" class="hidden">
        
        <div class="app-container" style="padding-bottom: 0;">
            <div class="header-user">
                <div class="header-title">
                    <h2 id="welcomeMsg">Olá, Produtor</h2>
                    <p id="dateDisplay" class="text-sm text-gray"></p>
                </div>
                
                <div id="contextSelectorContainer" class="hidden" style="flex: 1; margin: 0 15px; min-width: 200px;">
                    <select id="farmContextSelector" class="form-input" style="padding: 8px; font-weight: bold; color: var(--primary-dark);" onchange="switchFarmContext(this.value)">
                        </select>
                </div>
            
                <div class="btn-group-row">
                    <button id="btnAdminPanel" onclick="switchView('viewAdmin', this)" class="btn btn-sm btn-dark hidden" title="Painel Admin">
                        <i class="fas fa-user-shield"></i>
                    </button>
            
                    <button onclick="openModal('modalReports')" class="btn btn-outline btn-sm btn-icon-only" title="Relatórios PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>

                    <button onclick="openModal('modalSettings')" class="btn btn-outline btn-sm btn-icon-only" title="Configurações">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button onclick="logout()" class="btn btn-outline btn-sm"><i class="fas fa-sign-out-alt"></i> Sair</button>
                </div>
            </div>
            <div id="alertArea"></div>
        </div>

        <div class="app-container" id="mainContent">
            
            <div id="viewDashboard" class="view-section">
                <div class="dashboard-grid">
                    <div class="stat-card" style="border-color: var(--primary);">
                        <i class="fas fa-paw"></i><div class="stat-value" id="dashTotalAnimals">0</div><div class="stat-label">Total Animais</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--secondary);">
                        <i class="fas fa-weight-hanging"></i><div class="stat-value" id="dashAvgGMD">0.00</div><div class="stat-label">GMD Médio (kg/dia)</div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-cloud-showers-heavy"></i> Desempenho: Chuva x Peso</h3>
                    <div style="width: 100%; overflow-x: auto;">
                        <canvas id="rainWeightChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div id="viewGroups" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Meus Lotes</h2>
                    <button class="btn btn-sm" onclick="openModal('modalNewGroup')"><i class="fas fa-plus"></i> Novo Lote</button>
                </div>
                <div id="groupsList"></div>
            </div>

            <div id="viewPastures" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Gestão de Pastos</h2>
                    <button class="btn btn-sm" onclick="openModal('modalNewPasture')"><i class="fas fa-plus"></i> Piquete</button>
                </div>
                <div class="card">
                    <h3><i class="fas fa-map-marked-alt"></i> Mapa de Lotação</h3>
                    <div class="paddock-grid" id="pasturesGrid"></div>
                </div>
                <div class="card bg-card-rain">
                    <h3><i class="fas fa-cloud-rain"></i> Pluviômetro Digital</h3>
                    <div class="flex-between gap-2">
                        <input type="date" id="rainDate" class="form-input" style="flex:1;">
                        <input type="number" id="rainMm" class="form-input" placeholder="mm" style="flex:1;">
                        <button class="btn btn-secondary" style="width: auto;" onclick="addRainfall()">Lançar</button>
                    </div>
                </div>
            </div>

            <div id="viewStock" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Controle de Estoque</h2>
                    <button class="btn btn-sm btn-secondary" onclick="openModal('modalNewStockItem')"><i class="fas fa-box-open"></i> Novo Item</button>
                </div>
                
                <div class="card bg-card-stock">
                    <div class="flex-between">
                        <div><h4>Valor em Estoque</h4><div class="text-sm">Produtos armazenados</div></div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: var(--secondary);" id="stockTotalValue">R$ 0,00</div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-cubes"></i> Meus Produtos</h3>
                    <div id="inventoryList"></div>
                </div>
            </div>

            <div id="viewFinancial" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Financeiro</h2>
                    <div class="btn-group-row">
                        <button class="btn btn-sm btn-success" onclick="openTransactionModal('income')"><i class="fas fa-plus"></i> Receita</button>
                        <button class="btn btn-sm btn-danger" onclick="openTransactionModal('expense')"><i class="fas fa-minus"></i> Despesa</button>
                    </div>
                </div>

                <div class="card">
                    <div class="financial-summary">
                        <div class="fin-box">
                            <h4>Receitas</h4>
                            <div class="text-success" id="finTotalRevenue">R$ 0,00</div>
                        </div>
                        <div class="fin-box">
                            <h4>Despesas</h4>
                            <div class="text-danger" id="finTotalExpense">R$ 0,00</div>
                        </div>
                        <div class="fin-box fin-box-neutral">
                            <h4>Saldo Líquido</h4>
                            <div id="finNetProfit">R$ 0,00</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-list"></i> Histórico</h3>
                    <div id="financialList"></div>
                </div>
            </div>

            <div id="viewAdmin" class="view-section hidden">
                <div class="flex-between" style="margin-bottom: 16px;">
                    <h2>Gestão de Acessos</h2>
                    <span class="badge badge-purple">ADMINISTRADOR</span>
                </div>

                <div class="card">
                    <h3><i class="fas fa-users-cog"></i> Usuários do Sistema</h3>
                    <p class="text-sm text-gray" style="margin-bottom: 15px;">Defina cargos e atribua fazendas aos gerentes.</p>
                    <div id="adminUserList">
                        <div class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
                    </div>
                </div>
            </div>

        </div>

        <div class="nav-bar">
            <div class="nav-item active" onclick="switchView('viewDashboard', this)">
                <i class="fas fa-chart-pie"></i> Dash
            </div>
            <div class="nav-item" onclick="switchView('viewGroups', this)">
                <i class="fas fa-layer-group"></i> Lotes
            </div>
            <div class="nav-item" onclick="switchView('viewPastures', this)">
                <i class="fas fa-seedling"></i> Pastos
            </div>
            <div class="nav-item" onclick="switchView('viewStock', this)">
                <i class="fas fa-boxes"></i> Estoque
            </div>
            <div class="nav-item" onclick="switchView('viewFinancial', this)">
                <i class="fas fa-wallet"></i> Caixa
            </div>
        </div>

    </div>

    <div id="modalSettings" class="modal">
        <div class="modal-content">
            <h3>Configurações</h3>
            <p class="text-gray" style="margin-bottom: 20px;">Personalize a aparência do aplicativo.</p>
            
            <label style="display:block; margin-bottom:10px; font-weight:600;">Tema do Sistema</label>
            <div class="btn-group-row">
                <button class="btn btn-outline" onclick="toggleTheme('light')"><i class="fas fa-sun"></i> Claro</button>
                <button class="btn btn-dark" onclick="toggleTheme('dark')"><i class="fas fa-moon"></i> Escuro</button>
            </div>

            <h4 style="margin-top:25px; margin-bottom:10px;">Jurídico & Termos</h4>
            <div class="btn-group-row">
                <button class="btn btn-outline btn-sm" onclick="openLegal('terms')">Termos de Uso</button>
                <button class="btn btn-outline btn-sm" onclick="openLegal('privacy')">Privacidade</button>
                <button class="btn btn-outline btn-sm" onclick="openLegal('eula')">EULA</button>
            </div>
            <div class="legal-footer">
                <p>63.992.533 JOAO GUILHERME POZZEBON LORENZ</p>
            </div>

            <button class="btn btn-outline" style="margin-top: 20px;" onclick="closeModal('modalSettings')">Fechar</button>
        </div>
    </div>

    <div id="modalLegal" class="modal">
        <div class="modal-content">
            <h3 id="legalTitle">Documento</h3>
            <div id="legalBody" class="legal-content-box" style="margin-top:20px; max-height: 60vh; overflow-y:auto; padding-right:5px;"></div>
            <button class="btn btn-outline" style="margin-top: 20px;" onclick="closeModal('modalLegal')">Fechar</button>
        </div>
    </div>

    <div id="modalReports" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-print"></i> Central de Relatórios</h3>
            <p class="text-sm text-gray" style="margin-bottom: 20px;">Selecione o tipo de documento para gerar em PDF.</p>

            <div class="form-group">
                <label>Tipo de Relatório</label>
                <select id="reportType" class="form-input" onchange="toggleReportOptions()">
                    <option value="general_summary">Resumo Geral da Fazenda</option>
                    <option value="financial">Relatório Financeiro (Completo)</option>
                    <option value="rainfall">Relatório de Pluviometria</option>
                    <option value="group_specific">Relatório Detalhado de Lote</option>
                    <option value="sanitary_general">Controle Sanitário (Geral)</option>
                </select>
            </div>

            <div id="reportGroupSelectDiv" class="form-group hidden">
                <label>Selecione o Lote</label>
                <select id="reportGroupTarget" class="form-input"></select>
            </div>

            <button class="btn" onclick="generatePDF()">Gerar PDF</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalReports')">Fechar</button>
        </div>
    </div>

    <div id="pdf-hidden-container" style="position: fixed; left: 0; top: 0; width: 0; height: 0; overflow: hidden; z-index: -1; visibility: hidden;">
        <div id="pdf-template" class="a4-page">
            <img src="Branco-removebg-preview.png" class="watermark-img">
            
            <div class="pdf-header">
                <div style="display:flex; align-items:center; gap:15px;">
                    <img src="Verde.jpg" style="height: 50px; border-radius:50%;">
                    <div>
                        <h1 style="margin:0; font-size:1.5rem; color:#059669;">MeuGado</h1>
                        <div style="font-size:0.8rem; color:#555;" id="pdf-farm-name">Fazenda</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:0.7rem; color:#777;">Gerado em:</div>
                    <div style="font-weight:bold;" id="pdf-date-generation">--/--/----</div>
                </div>
            </div>
            <hr style="border: 1px solid #eee; margin: 10px 0;">

            <h2 id="pdf-title" style="text-align:center; margin-bottom:20px; color:#1f2937;">Título do Relatório</h2>
            <div id="pdf-body">
                </div>

            <div class="pdf-footer">
                <p>Documento gerado eletronicamente pelo sistema MeuGado.</p>
            </div>
        </div>
    </div>

    <div id="modalAdminAssign" class="modal">
        <div class="modal-content">
            <h3>Atribuir Fazendas</h3>
            <p class="text-sm text-gray">Selecione quais fazendas o gerente <strong id="assignManagerName"></strong> pode acessar.</p>
            
            <div id="assignFarmList" style="max-height: 300px; overflow-y: auto; margin: 15px 0; border: 1px solid var(--border); border-radius: 8px; padding: 10px;">
                </div>

            <input type="hidden" id="targetManagerId">
            <button class="btn" onclick="saveManagerAssignments()">Salvar Permissões</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalAdminAssign')">Fechar</button>
        </div>
    </div>

    <div id="modalNewGroup" class="modal">
        <div class="modal-content">
            <h3>Novo Lote de Animais</h3>
            <div class="form-group"><label>Nome do Lote</label><input type="text" id="newGroupName" class="form-input"></div>
            
            <div class="form-group">
                <label>Tipo de Criação</label>
                <select id="newGroupType" class="form-input" onchange="updateCategoryOptions()">
                    <option value="Bovinos">Bovinos (Gado de Corte/Leite)</option>
                    <option value="Ovinos">Ovinos (Ovelhas)</option>
                    <option value="Caprinos">Caprinos (Cabras)</option>
                    <option value="Aves">Aves (Galinhas/Frangos)</option>
                    <option value="Suínos">Suínos (Porcos)</option>
                    <option value="Equinos">Equinos (Cavalos)</option>
                </select>
            </div>

            <div class="form-group"><label>Categoria</label>
                <select id="newGroupCategory" class="form-input">
                    </select>
            </div>
            <div class="form-group">
                <label>Valor Total de Compra (R$)</label>
                <input type="number" id="newGroupInitialCost" class="form-input" placeholder="0.00" step="0.01">
                <div class="text-sm text-gray" style="margin-top: 5px;">Custo inicial do lote (será adicionado ao histórico e despesas).</div>
            </div>
            <button class="btn" onclick="createGroup()">Salvar Lote</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalNewGroup')">Cancelar</button>
        </div>
    </div>

    <div id="modalNewPasture" class="modal">
        <div class="modal-content">
            <h3>Cadastrar Piquete</h3>
            <div class="form-group"><label>Identificação (Ex: Piquete 01)</label><input type="text" id="newPastureName" class="form-input"></div>
            <div class="form-group"><label>Área em Hectares (ha)</label><input type="number" id="newPastureArea" class="form-input"></div>
            <div class="form-group"><label>Tipo de Forrageira</label><input type="text" id="newPastureGrass" class="form-input" placeholder="Ex: Brachiaria Brizantha"></div>
            <button class="btn" onclick="createPasture()">Salvar Piquete</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalNewPasture')">Cancelar</button>
        </div>
    </div>

    <div id="modalEditPasture" class="modal">
        <div class="modal-content">
            <h3>Editar Piquete</h3>
            <input type="hidden" id="editPastureId">
            <div class="form-group"><label>Identificação</label><input type="text" id="editPastureName" class="form-input"></div>
            <div class="form-group"><label>Área (ha)</label><input type="number" id="editPastureArea" class="form-input"></div>
            <div class="form-group"><label>Tipo de Forrageira</label><input type="text" id="editPastureGrass" class="form-input"></div>
            
            <div class="btn-group-row">
                <button class="btn" onclick="updatePasture()">Salvar Alterações</button>
                <button class="btn btn-danger" onclick="deletePasture()"><i class="fas fa-trash"></i> Excluir</button>
            </div>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalEditPasture')">Cancelar</button>
        </div>
    </div>

    <div id="modalNewStockItem" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-cart-plus"></i> Entrada de Estoque</h3>
            <div class="form-group">
                <label>Nome do Produto / Touro</label>
                <input type="text" id="stockName" class="form-input" placeholder="Ex: Ração, Touro Nelore...">
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="stockCategory" class="form-input" onchange="toggleStockCategory(this.value)">
                    <option value="Ração">Ração / Nutrição</option>
                    <option value="Sal Mineral">Sal Mineral</option>
                    <option value="Vacina">Vacina</option>
                    <option value="Medicamento">Medicamento</option>
                    <option value="Sêmen">Sêmen / Genética</option>
                    <option value="Outros">Outros Materiais</option>
                </select>
            </div>
            <div id="stockSanitaryFields" class="hidden">
                <div class="flex-between gap-2">
                    <div class="form-group" style="flex:1">
                        <label>Marca/Laboratório</label>
                        <input type="text" id="stockBrand" class="form-input" placeholder="Ex: Zoetis">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Lote</label>
                        <input type="text" id="stockBatch" class="form-input" placeholder="Ex: 12345ABC">
                    </div>
                </div>
            </div>
            <div id="stockSemenFields" class="hidden" style="background: var(--light); padding:10px; border-radius:10px; margin-bottom:15px; border:1px dashed var(--primary);">
                <h4 style="color:var(--primary); margin-bottom:10px;"><i class="fas fa-dna"></i> Dados do Reprodutor</h4>
                <div class="form-group">
                    <label>Raça</label>
                    <input type="text" id="stockSemenBreed" class="form-input" placeholder="Ex: Nelore, Angus...">
                </div>
                <div class="flex-between gap-2">
                    <div class="form-group" style="flex:1">
                        <label>Registro (RGN)</label>
                        <input type="text" id="stockSemenReg" class="form-input">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Central</label>
                        <input type="text" id="stockSemenCenter" class="form-input" placeholder="Ex: Alta, ABS">
                    </div>
                </div>
            </div>
            <div class="flex-between gap-2">
                <div class="form-group" style="flex:1">
                    <label>Qtd Comprada</label>
                    <input type="number" id="stockQty" class="form-input" placeholder="Ex: 50" step="0.01">
                </div>
                <div class="form-group" style="flex:1">
                    <label>Unidade</label>
                    <select id="stockUnit" class="form-input">
                        <option value="kg">Kg (Quilos)</option>
                        <option value="ds">Doses (Palhetas)</option>
                        <option value="ml">ml (Mililitros)</option>
                        <option value="lt">Lt (Litros)</option>
                        <option value="un">Unid.</option>
                        <option value="sc">Sacos</option>
                        <option value="fr">Frascos</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Valor TOTAL Gasto (R$)</label>
                <input type="number" id="stockTotalSpend" class="form-input" placeholder="0.00" oninput="calculateUnitCost()">
                <div class="text-sm text-gray text-center" id="unitCostDisplay" style="margin-top:5px;">Custo Unitário: R$ 0,00</div>
            </div>
            <div class="form-group">
                <label style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="autoLaunchFinance" checked> 
                    Lançar Despesa no Financeiro automaticamente?
                </label>
            </div>
            <button class="btn btn-secondary" onclick="addStockItem()">Adicionar ao Estoque</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalNewStockItem')">Cancelar</button>
        </div>
    </div>

    <div id="modalGroupDetails" class="modal">
        <div class="modal-content">
            <div class="flex-between">
                <h3 id="detailGroupTitle">Lote</h3>
                <span class="badge badge-success" id="detailGroupStatus">ATIVO</span>
            </div>
            <p id="detailGroupSubtitle" class="text-sm text-gray" style="margin-bottom: 15px;"></p>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('tabOverview', event)">Resumo</div>
                <div class="tab" onclick="switchTab('tabStockUse', event)">Usar Estoque</div>
                <div class="tab" onclick="switchTab('tabWeights', event)">Pesagem</div>
                <div class="tab" onclick="switchTab('tabBreeding', event)" style="color:var(--pink);">Reprodução</div> <div class="tab" onclick="switchTab('tabAnimals', event)">Animais</div>
                <div class="tab" onclick="switchTab('tabSim', event)">Simulador</div>
                <div class="tab" onclick="switchTab('tabSale', event)">Venda</div> 
            </div>

            <div id="tabOverview" class="tab-content">
                <div class="card bg-card-calc">
                    <h4><i class="fas fa-calculator"></i> Custos & Desempenho</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <span class="text-sm text-gray">GMD Atual</span>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);" id="calcGMD">0.000</div>
                        </div>
                        <div>
                            <span class="text-sm text-gray">Custo Total Lote</span>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--danger);" id="calcTotalCost">R$ 0,00</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Movimentação de Pasto</label>
                    <select id="movePastureSelect" class="form-input" onchange="moveGroup(this.value)"></select>
                </div>
            </div>

            <div id="tabBreeding" class="tab-content hidden">
                <div class="card bg-card-repro">
                    <h4 style="color: #be185d;"><i class="fas fa-venus-mars"></i> Nova Inseminação (IA/IATF)</h4>
                    <div class="form-group" style="margin-top:10px;">
                        <label>Protocolo / Tipo</label>
                        <div class="flex-between gap-2">
                            <select id="breedingType" class="form-input">
                                <option value="IATF">IATF (Tempo Fixo)</option>
                                <option value="Natural">Cio Natural / Observado</option>
                            </select>
                            <input type="date" id="breedingDate" class="form-input">
                        </div>
                    </div>

                    <div id="iatfPlanDiv" style="margin-bottom:10px;">
                        <label class="text-sm text-pink">Data Início Protocolo (D0)</label>
                        <input type="date" id="iatfStartDate" class="form-input" onchange="calcIatfDate()">
                        <div class="text-xs text-gray" style="margin-top:5px;">O sistema sugere a IA para D10/D11 após início.</div>
                    </div>

                    <div class="form-group">
                        <label>Touro (Estoque de Sêmen)</label>
                        <select id="breedingBullSelect" class="form-input"></select>
                        <div id="breedingBullAlert" class="text-xs text-danger hidden" style="margin-top:2px;">Estoque baixo!</div>
                    </div>

                    <div class="form-group">
                        <label>Inseminador</label>
                        <input type="text" id="breedingInseminator" class="form-input" placeholder="Nome do técnico">
                    </div>
                    
                    <div class="form-group">
                         <label>Matrizes (Vacas)</label>
                         <div class="flex-between gap-2" style="margin-bottom:5px;">
                            <label style="flex:1; display:flex; align-items:center; gap:5px; font-weight:normal;">
                                <input type="radio" name="breedingScope" value="all" checked onchange="toggleBreedingScope()"> Lote Inteiro
                            </label>
                            <label style="flex:1; display:flex; align-items:center; gap:5px; font-weight:normal;">
                                <input type="radio" name="breedingScope" value="individual" onchange="toggleBreedingScope()"> Individual
                            </label>
                        </div>
                        <select id="breedingCowSelect" class="form-input hidden"></select>
                    </div>

                    <div class="form-group">
                        <label>Escore Corporal (ECC Médio)</label>
                        <input type="number" id="breedingECC" class="form-input" placeholder="1 a 5" step="0.1">
                    </div>

                    <button class="btn btn-pink" onclick="saveInsemination()">Registrar IA e Baixar Estoque</button>
                </div>

                <h4 style="margin-top:20px;">Histórico Reprodutivo</h4>
                <div id="breedingList"></div>
            </div>
            <div id="tabStockUse" class="tab-content hidden">
                <div class="card bg-card-use">
                    <label style="color:var(--secondary); font-weight:bold;">1. O que foi usado?</label>
                    <select id="useStockType" class="form-input" onchange="populateStockUsageSelect()" style="margin-bottom:10px;">
                        <option value="nutrition">Nutrição (Ração/Sal)</option>
                        <option value="health">Sanitário (Vacina/Remédio)</option>
                        <option value="other">Outros</option>
                    </select>
                    <label style="color:var(--secondary); font-weight:bold; margin-top:15px;">2. Tipo de Uso</label>
                    <div class="flex-between gap-2" style="margin-bottom: 15px;">
                        <label style="flex:1; display:flex; align-items:center; gap:5px; font-weight:normal;">
                            <input type="radio" name="usageScope" value="lot" id="scopeLot" checked onchange="toggleIndividualUsage()"> Uso no Lote
                        </label>
                        <label style="flex:1; display:flex; align-items:center; gap:5px; font-weight:normal;">
                            <input type="radio" name="usageScope" value="individual" id="scopeIndividual" onchange="toggleIndividualUsage()"> Uso Individual
                        </label>
                    </div>
                    <div id="individualAnimalSelect" class="form-group hidden">
                        <label class="text-sm">Animal Alvo (Brinco/ID)</label>
                        <select id="useAnimalId" class="form-input"></select>
                    </div>
                    <label class="text-sm">Selecione o Produto do Estoque</label>
                    <select id="useStockProduct" class="form-input" style="margin-bottom:10px;"></select>
                    <div id="usageBlockNutrition"> 
                        <label class="text-sm" id="labelQtyTotal">Quantidade Total fornecida ao lote</label>
                        <div class="flex-between gap-2">
                            <input type="number" id="useQtyTotal" class="form-input" placeholder="Ex: 40">
                            <span id="useUnitDisplay1" style="font-weight:bold;">kg</span>
                        </div>
                    </div>
                    <div id="usageBlockHealth" class="hidden">
                        <label class="text-sm">Dose por Animal</label>
                        <div class="flex-between gap-2">
                            <input type="number" id="useDosePerAnimal" class="form-input" placeholder="Ex: 5">
                            <span id="useUnitDisplay2" style="font-weight:bold;">ml</span>
                        </div>
                        <div class="text-sm text-gray" id="healthDoseHint" style="margin-top:5px;">O sistema multiplicará pela quantidade de animais.</div>
                        <label class="text-sm" style="margin-top:10px;">Carência (Dias)</label>
                        <input type="number" id="useWithdrawal" class="form-input" placeholder="0">
                    </div>
                    <label class="text-sm" style="margin-top:10px;">Data da Aplicação/Uso</label>
                    <input type="date" id="useDate" class="form-input">
                    <button class="btn btn-secondary" style="margin-top:15px;" onclick="confirmStockUsage()">Confirmar Uso e Custo</button>
                </div>
                <h4 style="margin-top:20px;">Histórico de Custos do Lote</h4>
                <div id="groupCostList"></div>
            </div>

            <div id="tabWeights" class="tab-content hidden">
                <div class="card">
                    <label>Nova Pesagem do Lote (Média)</label>
                    <div class="flex-between gap-2">
                        <input type="date" id="weightDate" class="form-input">
                        <input type="number" id="weightValue" class="form-input" placeholder="Kg Médio">
                        <button class="btn btn-sm" onclick="addWeight()">Salvar</button>
                    </div>
                </div>
                <div id="weightHistoryList" style="margin-top: 10px;"></div>
            </div>

            <div id="tabAnimals" class="tab-content hidden">
                <div class="form-group">
                    <div class="flex-between gap-2">
                        <input type="text" id="newAnimalId" class="form-input" placeholder="ID/Brinco/RFID">
                        <button class="btn btn-sm" onclick="addAnimalToGroup()">Adicionar</button>
                    </div>
                </div>
                <div id="animalList" style="max-height: 250px; overflow-y: auto;"></div>
            </div>

            <div id="tabSim" class="tab-content hidden">
                <div class="card bg-card-sim">
                    <h4><i class="fas fa-stopwatch"></i> Previsão de Abate</h4>
                    <div class="form-group"><label>Data Prevista</label><input type="date" id="simDate" class="form-input"></div>
                    <div class="form-group"><label>GMD Projetado (kg/dia)</label><input type="number" id="simGMD" class="form-input" step="0.01"></div>
                    <div class="form-group"><label>Preço Venda Arroba (R$)</label><input type="number" id="simPrice" class="form-input"></div>
                    <button class="btn btn-accent" style="background-color: var(--accent); color: white;" onclick="runSimulation()">Calcular</button>
                    <div id="simResult" class="sim-result-box hidden">
                        <div class="flex-between"><span>Peso Proj:</span><strong id="resWeight">0</strong></div>
                        <div class="flex-between" style="color:var(--primary);"><span>Receita Total:</span><strong id="resRevenue">R$ 0,00</strong></div>
                    </div>
                </div>
            </div>

            <div id="tabSale" class="tab-content hidden">
                <div id="saleFormBlock">
                    <div class="card" style="border-color: var(--primary);">
                        <h4><i class="fas fa-hand-holding-usd"></i> Encerrar Lote (Venda)</h4>
                        <p class="text-sm text-gray" style="margin-bottom:15px;">Informe o valor final da venda. O sistema lançará a receita e calculará o lucro.</p>
                        <div class="form-group">
                            <label>Valor TOTAL da Venda (R$)</label>
                            <input type="number" id="saleTotalValue" class="form-input" placeholder="Ex: 50000.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Data da Venda</label>
                            <input type="date" id="saleDate" class="form-input">
                        </div>
                        <button class="btn btn-success" onclick="processGroupSale()">Confirmar Venda e Lucro</button>
                    </div>
                </div>
                <div id="saleResultBlock" class="hidden">
                    <div class="card sim-result-box" style="background-color: #f0fdf4; border-color: #bbf7d0;">
                        <h3 style="color: var(--primary-dark); margin-bottom: 15px;"><i class="fas fa-check-circle"></i> Lote Vendido</h3>
                        <div class="list-item" style="border-bottom: 1px dashed #cbd5e1;">
                            <span>Valor da Venda (Receita)</span>
                            <strong class="text-success" id="reportSaleValue">R$ 0,00</strong>
                        </div>
                        <div class="list-item" style="border-bottom: 1px dashed #cbd5e1;">
                            <span>(-) Custos Totais</span>
                            <strong class="text-danger" id="reportTotalCost">R$ 0,00</strong>
                        </div>
                        <div class="list-item" style="margin-top: 10px;">
                            <span style="font-size: 1.1rem; font-weight: bold;">Lucro Líquido</span>
                            <strong style="font-size: 1.3rem;" id="reportNetProfit">R$ 0,00</strong>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-outline" style="margin-top: 20px;" onclick="closeModal('modalGroupDetails')">Fechar</button>
        </div>
    </div>

    <div id="modalEditAnimal" class="modal">
        <div class="modal-content">
            <h3>Editar Animal</h3>
            <div class="form-group">
                <label>Brinco/ID</label>
                <input type="text" id="editAnimalIdInput" class="form-input">
            </div>
            <div class="form-group">
                <label>Peso Individual (kg)</label>
                <input type="number" id="editAnimalWeightInput" class="form-input" placeholder="0.00" step="0.01">
            </div>
            <input type="hidden" id="editAnimalIndex">
            <button class="btn" onclick="saveAnimalEdit()">Salvar Alteração</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalEditAnimal')">Cancelar</button>
        </div>
    </div>

    <div id="modalTransaction" class="modal">
        <div class="modal-content">
            <h3 id="transTitle">Nova Transação</h3>
            <div class="form-group">
                <label>Descrição</label>
                <input type="text" id="transDesc" class="form-input" placeholder="Ex: Venda Lote 01, Energia...">
            </div>
            <div class="form-group">
                <label>Valor Total (R$)</label>
                <input type="number" id="transAmount" class="form-input" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Data</label>
                <input type="date" id="transDate" class="form-input">
            </div>
            <input type="hidden" id="transType">
            <button class="btn" id="btnSaveTrans" onclick="addTransaction()">Salvar</button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="closeModal('modalTransaction')">Cancelar</button>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyKezs7gqjE9HUw_HjUMqA7ofxc5Sp9Bc",
            authDomain: "meu-gado-site.firebaseapp.com",
            projectId: "meu-gado-site",
            storageBucket: "meu-gado-site.firebasestorage.app",
            messagingSenderId: "913921456792",
            appId: "1:913921456792:web:5f1ccdbf20d423ee822eed",
            measurementId: "G-MYK82JG8E2"
        };
        
        firebase.initializeApp(firebaseConfig);
        // MODIFICAÇÃO OFFLINE-FIRST: Ativar persistência
        const db = firebase.firestore();
        db.enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log('Múltiplas abas abertas impedem a persistência offline.');
                } else if (err.code == 'unimplemented') {
                    console.log('O navegador atual não suporta persistência offline.');
                }
            });

        // --- DATA STRUCTURE ---
        let currentUser = null; 
        let activeFarmId = null; 
        let allUsersCache = []; 
        let appData = {
            groups: [], 
            pastures: [], 
            rainfall: [],
            financials: [],
            inventory: [], 
            market: { price: 0 }
        };

        // --- LEGAL TEXTS CONTENT ---
        const legalTexts = {
            terms: `
                <h4>1. Definições</h4>
                <p>O sistema MeuGado é uma plataforma digital para gerenciamento de informações zootécnicas. Usuário é quem utiliza; Empresa Gestora é quem contrata.</p>
                <h4>2. Objeto</h4>
                <p>O software apoia a gestão pecuária. Não presta consultoria técnica, veterinária ou zootécnica.</p>
                <h4>3. Elegibilidade</h4>
                <p>Empresas devem possuir CNPJ válido. O usuário declara possuir capacidade legal.</p>
                <h4>4. Responsabilidade</h4>
                <p>Todos os dados inseridos e decisões tomadas são de responsabilidade exclusiva do usuário.</p>
                <h4>5. Disponibilidade</h4>
                <p>O sistema é fornecido "como está". Podem ocorrer indisponibilidades por manutenção ou falhas técnicas.</p>
                <h4>6. Planos e Cobrança</h4>
                <p>Cobrança aplica-se a empresas gestoras. O não pagamento pode resultar em suspensão.</p>
                <h4>7. Uso Indevido</h4>
                <p>É proibido utilizar para fins ilegais, copiar, revender ou realizar engenharia reversa.</p>
                <h4>8. Suspensão</h4>
                <p>Contas que violem os termos podem ser suspensas sem aviso prévio.</p>
            `,
            privacy: `
                <h4>1. Dados Coletados</h4>
                <ul>
                    <li>Identificação: nome, e-mail, login.</li>
                    <li>Profissionais: empresa, propriedades.</li>
                    <li>Produtivos: animais, manejo, custos.</li>
                    <li>Técnicos: cookies, cache offline.</li>
                </ul>
                <h4>2. Finalidade</h4>
                <p>Operação do sistema, relatórios, melhoria da plataforma e cumprimento legal.</p>
                <h4>3. Armazenamento</h4>
                <p>Nuvem e bancos de dados locais no dispositivo (para uso offline). Medidas de segurança são adotadas.</p>
                <h4>4. Compartilhamento</h4>
                <p>Dados não são vendidos. Compartilhados apenas entre usuários autorizados da mesma gestão.</p>
                <h4>5. Direitos do Titular</h4>
                <p>Acesso, correção, exclusão e portabilidade. Solicitações via e-mail.</p>
                <h4>6. Exclusão</h4>
                <p>A exclusão pode implicar perda definitiva das informações.</p>
            `,
            eula: `
                <h4>1. Licença</h4>
                <p>O MeuGado é licenciado, não vendido. Concessão de licença limitada, não exclusiva, intransferível e revogável.</p>
                <h4>2. Propriedade Intelectual</h4>
                <p>Todo o sistema, código e marca pertencem a <strong>63.992.533 JOAO GUILHERME POZZEBON LORENZ</strong>.</p>
                <h4>3. Restrições</h4>
                <p>É proibido copiar, modificar, criar produtos derivados ou comercializar sem autorização.</p>
                <h4>4. Encerramento</h4>
                <p>A licença encerra automaticamente em caso de violação dos termos.</p>
            `
        };

        function openLegal(type) {
            const titles = { 'terms': 'Termos de Uso', 'privacy': 'Política de Privacidade', 'eula': 'EULA - Licença' };
            document.getElementById('legalTitle').innerText = titles[type];
            document.getElementById('legalBody').innerHTML = legalTexts[type];
            openModal('modalLegal');
        }

        // --- MULTI-SPECIES CONFIG ---
        const speciesConfig = {
            'Bovinos': ['Bezerros', 'Garrotes', 'Novilhas', 'Vacas', 'Touros', 'Bois'],
            'Ovinos': ['Borregos', 'Ovelhas', 'Carneiros', 'Cordeiros'],
            'Caprinos': ['Cabritos', 'Cabras', 'Bodes'],
            'Suínos': ['Leitões', 'Porcas', 'Cachaços', 'Terminação'],
            'Aves': ['Pintos', 'Frangos', 'Poedeiras', 'Galos'],
            'Equinos': ['Potros', 'Éguas', 'Cavalos']
        };

        function updateCategoryOptions() {
            const type = document.getElementById('newGroupType').value;
            const catSelect = document.getElementById('newGroupCategory');
            const options = speciesConfig[type] || speciesConfig['Bovinos'];
            
            catSelect.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        function getIconForType(type) {
            // Retorna classes do FontAwesome
            if(!type || type === 'Bovinos') return 'fas fa-cow';
            if(type === 'Aves') return 'fas fa-feather'; // ou fa-dove
            if(type === 'Suínos') return 'fas fa-piggy-bank'; // ou fa-bacon
            if(type === 'Equinos') return 'fas fa-horse';
            return 'fas fa-paw'; // Ovinos, Caprinos e genéricos
        }

        // --- INIT ---
        window.onload = function() {
            // Theme Init
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }

            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('pt-BR', {weekday: 'long', day: 'numeric', month: 'long'});
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);

            // Init Categories
            updateCategoryOptions();

            // MODIFICAÇÃO OFFLINE-FIRST: Checar Login Salvo
            const savedUser = localStorage.getItem('meugado_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                setupRoleBasedUI();
                loadData(currentUser.id);
            }
            
            // UI de Status Offline
            const div = document.createElement('div');
            div.id = 'connectionStatus';
            document.body.appendChild(div);
            updateOnlineStatus();
        };

        // --- THEME LOGIC ---
        function toggleTheme(mode) {
            if (mode === 'dark') {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
            closeModal('modalSettings');
        }

        // --- CLOUD SYNC & CONTEXT ---
        async function loadData(targetUserId) {
            activeFarmId = targetUserId;
            document.body.style.cursor = 'wait';
            try {
                const doc = await db.collection('users').doc(activeFarmId).get();
                if (doc.exists) {
                    const data = doc.data();
                    appData.groups = data.groups || [];
                    appData.pastures = data.pastures || [];
                    appData.rainfall = data.rainfall || [];
                    appData.financials = data.financials || [];
                    appData.inventory = data.inventory || [];
                } else {
                    appData = { groups: [], pastures: [], rainfall: [], financials: [], inventory: [] };
                    if(activeFarmId === currentUser.id) await saveData(); 
                }
                renderAll();
                const welcome = document.getElementById('welcomeMsg');
                if(activeFarmId !== currentUser.id) {
                    welcome.style.color = 'var(--accent)';
                    welcome.innerHTML = `<i class="fas fa-eye"></i> Visualizando Externo`;
                } else {
                    welcome.style.color = 'var(--dark)';
                    welcome.innerText = `Olá, ${currentUser.fullName.split(' ')[0]}`;
                }
            } catch (error) {
                console.error("Erro ao carregar:", error);
                // Em offline, talvez não carregue na primeira vez se não tiver cache, mas não deve travar
            } finally {
                document.body.style.cursor = 'default';
            }
        }

        async function saveData() {
            if (!activeFarmId) return;
            try {
                await db.collection('users').doc(activeFarmId).set(appData, { merge: true });
            } catch (error) {
                console.error("Erro ao salvar:", error);
                // Em offline, o erro pode ser suprimido pelo Firebase que salva localmente
            }
        }

        // --- AUTH & ROLES LOGIC ---
        function toggleAuthMode(mode) {
            document.getElementById('authMessage').innerText = '';
            if(mode === 'register') {
                document.getElementById('loginFormBlock').classList.add('hidden');
                document.getElementById('registerFormBlock').classList.remove('hidden');
            } else {
                document.getElementById('loginFormBlock').classList.remove('hidden');
                document.getElementById('registerFormBlock').classList.add('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('loginUser').value.trim();
            const pass = document.getElementById('loginPass').value;
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('authMessage');

            if(!user || !pass) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
            msg.innerText = '';

            const userId = user.toLowerCase().replace(/[^a-z0-9_]/g, '_');

            try {
                const authDoc = await db.collection('auth').doc(userId).get();
                if (!authDoc.exists) throw new Error('Usuário não encontrado.');
                const authData = authDoc.data();
                if (authData.passwordHash !== btoa(pass + userId)) throw new Error('Senha incorreta.');

                currentUser = { 
                    id: userId, 
                    name: authData.userName, 
                    fullName: authData.fullName,
                    role: authData.role || 'basic', 
                    managedFarms: authData.managedFarms || []
                };

                // MODIFICAÇÃO OFFLINE-FIRST: Salvar Sessão
                localStorage.setItem('meugado_user', JSON.stringify(currentUser));

                setupRoleBasedUI();
                await loadData(userId);

                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');

            } catch (error) {
                msg.innerText = error.message;
                btn.disabled = false;
                btn.innerHTML = '<span>Entrar</span> <i class="fas fa-sign-in-alt"></i>';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const user = document.getElementById('regUser').value.trim();
            const name = document.getElementById('regName').value.trim();
            const pass = document.getElementById('regPass').value;
            const btn = document.getElementById('btnRegister');
            const msg = document.getElementById('authMessage');

            if(user.length < 3) { msg.innerText = "Usuário muito curto."; return; }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';

            const userId = user.toLowerCase().replace(/[^a-z0-9_]/g, '_');

            try {
                const authDoc = await db.collection('auth').doc(userId).get();
                if (authDoc.exists) throw new Error('Este usuário já existe.');

                await db.collection('auth').doc(userId).set({
                    userName: user, 
                    fullName: name, 
                    passwordHash: btoa(pass + userId), 
                    createdAt: new Date().toISOString(),
                    role: 'basic',      
                    managedFarms: []    
                });

                currentUser = { id: userId, name: user, fullName: name, role: 'basic', managedFarms: [] };
                
                // MODIFICAÇÃO OFFLINE-FIRST: Salvar Sessão no Registro também
                localStorage.setItem('meugado_user', JSON.stringify(currentUser));

                appData = { groups: [], pastures: [], rainfall: [], financials: [], inventory: [] };
                await saveData();

                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                document.getElementById('welcomeMsg').innerText = `Olá, ${name.split(' ')[0]}`;

            } catch (error) {
                msg.innerText = error.message;
                btn.disabled = false;
                btn.innerHTML = '<span>Criar Conta</span> <i class="fas fa-user-plus"></i>';
            }
        }

        function logout() {
            if(confirm('Sair do sistema?')) { 
                // MODIFICAÇÃO OFFLINE-FIRST: Limpar Sessão
                localStorage.removeItem('meugado_user');
                location.reload(); 
            }
        }

        async function setupRoleBasedUI() {
            const selectorContainer = document.getElementById('contextSelectorContainer');
            const btnAdmin = document.getElementById('btnAdminPanel');
            const selector = document.getElementById('farmContextSelector');

            selectorContainer.classList.add('hidden');
            btnAdmin.classList.add('hidden');
            selector.innerHTML = '';

            if (currentUser.role === 'admin') {
                btnAdmin.classList.remove('hidden');
                loadAdminUserList(); 
            }

            if (currentUser.role === 'manager' || currentUser.role === 'admin') {
                selectorContainer.classList.remove('hidden');
                let optionsHtml = `<option value="${currentUser.id}">Minha Fazenda (Padrão)</option>`;

                if (currentUser.role === 'admin') {
                    const snapshot = await db.collection('auth').get();
                    snapshot.forEach(doc => {
                        if(doc.id !== currentUser.id) {
                            const d = doc.data();
                            optionsHtml += `<option value="${doc.id}">Fazenda: ${d.fullName}</option>`;
                        }
                    });
                } else if (currentUser.role === 'manager' && currentUser.managedFarms.length > 0) {
                    for (const farmId of currentUser.managedFarms) {
                        const farmDoc = await db.collection('auth').doc(farmId).get();
                        if(farmDoc.exists) {
                            optionsHtml += `<option value="${farmId}">Gerenciar: ${farmDoc.data().fullName}</option>`;
                        }
                    }
                }
                selector.innerHTML = optionsHtml;
            }
        }

        function switchFarmContext(targetId) {
            if(targetId !== activeFarmId) {
                loadData(targetId);
            }
        }

        // --- CORE FUNCTIONS ---
        function calculateGMD(group) {
            if (!group.weighings || group.weighings.length < 2) return 0;
            const sorted = [...group.weighings].sort((a,b) => new Date(a.date) - new Date(b.date));
            const last = sorted[sorted.length - 1];
            const prev = sorted[sorted.length - 2];
            const diffTime = Math.abs(new Date(last.date) - new Date(prev.date));
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays === 0) return 0;
            return ((last.weight - prev.weight) / diffDays).toFixed(3);
        }

        function getCurrentLotWeight(group) {
            if (group.animals && group.animals.length > 0) {
                const animalsWithWeight = group.animals.filter(a => a.weight > 0);
                if (animalsWithWeight.length > 0) {
                    const totalWeight = animalsWithWeight.reduce((sum, a) => sum + a.weight, 0);
                    return { weight: (totalWeight / animalsWithWeight.length), source: 'INDIVIDUAL' };
                }
            }
            if (group.weighings && group.weighings.length > 0) {
                return { weight: group.weighings[group.weighings.length - 1].weight, source: 'LOTE' };
            }
            return { weight: 0, source: 'N/A' };
        }

        function calculateGroupCost(group) {
            let total = 0;
            if(group.costHistory) {
                total += group.costHistory.reduce((a, b) => a + b.totalCost, 0);
            }
            return total.toFixed(2);
        }

        function getGroupTotalCostNumber(group) {
            if(!group.costHistory) return 0;
            return group.costHistory.reduce((a, b) => a + b.totalCost, 0);
        }

        function getStockingRate(pastureId) {
            const pasture = appData.pastures.find(p => p.id == pastureId);
            if (!pasture || !pasture.area) return 0;
            let totalWeight = 0;
            appData.groups.forEach(g => {
                if (g.currentPastureId == pastureId) {
                    const currentWeight = getCurrentLotWeight(g).weight; 
                    const qtd = g.animals && g.animals.length > 0 ? g.animals.length : (g.quantity || 0);
                    totalWeight += (currentWeight * qtd);
                }
            });
            // UA (Unidade Animal) padrão = 450kg (serve como base para outros animais também para simplificação)
            const ua = totalWeight / 450; 
            return (ua / pasture.area).toFixed(2);
        }

        // --- ACTIONS: GROUP & PASTURE ---
        async function createGroup() {
            const name = document.getElementById('newGroupName').value;
            const category = document.getElementById('newGroupCategory').value;
            const type = document.getElementById('newGroupType').value;
            const initialCost = parseFloat(document.getElementById('newGroupInitialCost').value) || 0;
            
            if(!name) return;
            
            const newGroup = {
                id: Date.now(), name, category, herdType: type, // Salva o tipo
                quantity: 0, animals: [], weighings: [], 
                health: [], costHistory: [], breedingEvents: [], 
                currentPastureId: null, sold: false, salePrice: 0, saleDate: null
            };

            if (initialCost > 0) {
                newGroup.costHistory.push({
                    date: new Date().toISOString().split('T')[0], itemName: "Compra Inicial do Lote",
                    category: "Custo Fixo", qty: 1, unit: 'un', totalCost: initialCost, isInitialCost: true
                });
                appData.financials.push({
                    id: Date.now() + 1, type: 'expense', desc: `Compra Lote: ${name}`, amount: initialCost,
                    date: new Date().toISOString().split('T')[0], isGroupPurchase: true
                });
            }

            appData.groups.push(newGroup);
            await saveData();
            closeModal('modalNewGroup');
            document.getElementById('newGroupName').value = '';
            document.getElementById('newGroupInitialCost').value = ''; 
            renderAll();
        }

        async function createPasture() {
            const name = document.getElementById('newPastureName').value;
            const area = parseFloat(document.getElementById('newPastureArea').value);
            const grass = document.getElementById('newPastureGrass').value;
            if(!name || !area) return;
            appData.pastures.push({ id: Date.now(), name, area, grass });
            await saveData();
            closeModal('modalNewPasture');
            renderAll();
        }

        // --- FUNÇÕES DE EDIÇÃO DE PASTO (NOVO) ---
        function openEditPasture(id) {
            const p = appData.pastures.find(x => x.id == id);
            if(!p) return;
            document.getElementById('editPastureId').value = p.id;
            document.getElementById('editPastureName').value = p.name;
            document.getElementById('editPastureArea').value = p.area;
            document.getElementById('editPastureGrass').value = p.grass || '';
            openModal('modalEditPasture');
        }

        async function updatePasture() {
            const id = document.getElementById('editPastureId').value;
            const p = appData.pastures.find(x => x.id == id);
            if(p) {
                p.name = document.getElementById('editPastureName').value;
                p.area = parseFloat(document.getElementById('editPastureArea').value);
                p.grass = document.getElementById('editPastureGrass').value;
                await saveData();
                closeModal('modalEditPasture');
                renderAll();
            }
        }

        async function deletePasture() {
            const id = document.getElementById('editPastureId').value;
            // Check for animals
            const hasAnimals = appData.groups.some(g => g.currentPastureId == id && !g.sold);
            if(hasAnimals) { 
                alert('Não é possível excluir: Há animais vinculados a este pasto. Mova-os primeiro.'); 
                return; 
            }
            if(!confirm('Tem certeza que deseja excluir este piquete?')) return;

            appData.pastures = appData.pastures.filter(x => x.id != id);
            await saveData();
            closeModal('modalEditPasture');
            renderAll();
        }

        async function addRainfall() {
            const date = document.getElementById('rainDate').value;
            const mm = parseFloat(document.getElementById('rainMm').value);
            if(date && mm >= 0) {
                const existing = appData.rainfall.find(r => r.date === date);
                if(existing) existing.mm = mm;
                else appData.rainfall.push({date, mm});
                appData.rainfall.sort((a,b) => new Date(a.date) - new Date(b.date));
                await saveData();
                alert('Chuva registrada!');
                renderAll();
            }
        }

        // --- ESTOQUE ---
        function calculateUnitCost() {
            const qty = parseFloat(document.getElementById('stockQty').value) || 0;
            const total = parseFloat(document.getElementById('stockTotalSpend').value) || 0;
            const display = document.getElementById('unitCostDisplay');
            if(qty > 0 && total > 0) display.innerText = `Custo Unitário: R$ ${(total / qty).toFixed(2)}`;
            else display.innerText = `Custo Unitário: R$ 0,00`;
        }

        function toggleStockCategory(val) {
            const fields = document.getElementById('stockSanitaryFields');
            const semenFields = document.getElementById('stockSemenFields'); 
            
            // Lógica Sanitario
            if(val === 'Vacina' || val === 'Medicamento') fields.classList.remove('hidden');
            else fields.classList.add('hidden');

            // Lógica Sêmen
            if(val === 'Sêmen') semenFields.classList.remove('hidden');
            else semenFields.classList.add('hidden');

            // Ajuste Unidade Padrão
            const unitSel = document.getElementById('stockUnit');
            if(val === 'Sêmen') unitSel.value = 'ds';
        }

        async function addStockItem() {
            const name = document.getElementById('stockName').value;
            const category = document.getElementById('stockCategory').value;
            const unit = document.getElementById('stockUnit').value;
            const qty = parseFloat(document.getElementById('stockQty').value);
            const totalSpend = parseFloat(document.getElementById('stockTotalSpend').value);
            const autoLaunch = document.getElementById('autoLaunchFinance').checked;
            
            const brand = document.getElementById('stockBrand').value;
            const batch = document.getElementById('stockBatch').value;
            
            const breed = document.getElementById('stockSemenBreed').value;
            const reg = document.getElementById('stockSemenReg').value;
            const center = document.getElementById('stockSemenCenter').value;

            if(!name || !qty || !totalSpend) { alert("Preencha todos os campos."); return; }

            let existingItem = appData.inventory.find(i => i.name.toLowerCase() === name.toLowerCase() && i.unit === unit);
            
            if(existingItem) {
                const totalValueOld = existingItem.currentQty * existingItem.avgPrice;
                const newQty = existingItem.currentQty + qty;
                existingItem.avgPrice = (totalValueOld + totalSpend) / newQty;
                existingItem.currentQty = newQty;
                if(brand) existingItem.brand = brand;
                if(batch) existingItem.batch = batch;
            } else {
                appData.inventory.push({
                    id: Date.now(), name, category, unit, avgPrice: totalSpend / qty,
                    currentQty: qty, brand, batch,
                    breed, reg, center 
                });
            }

            if(autoLaunch) {
                appData.financials.push({
                    id: Date.now(), type: 'expense', desc: `Compra Estoque: ${name}`, amount: totalSpend,
                    date: new Date().toISOString().split('T')[0], isStock: true
                });
            }

            await saveData();
            closeModal('modalNewStockItem');
            
            document.getElementById('stockName').value = '';
            document.getElementById('stockQty').value = '';
            document.getElementById('stockTotalSpend').value = '';
            document.getElementById('stockBrand').value = '';
            document.getElementById('stockBatch').value = '';
            document.getElementById('stockSemenBreed').value = ''; 
            document.getElementById('stockSemenReg').value = '';
            renderAll();
        }

        // --- USO DE ESTOQUE E GESTÃO DE LOTE ---
        let activeGroupId = null;

        function openGroupDetails(id) {
            activeGroupId = id;
            const group = appData.groups.find(g => g.id == id);
            
            document.getElementById('detailGroupTitle').innerText = group.name;
            document.getElementById('detailGroupSubtitle').innerText = `${group.category} • ${group.animals.length || group.quantity} animais`;

            const statusBadge = document.getElementById('detailGroupStatus');
            if(group.sold) {
                statusBadge.className = 'badge badge-gray'; statusBadge.innerText = 'VENDIDO';
                document.getElementById('saleFormBlock').classList.add('hidden');
                document.getElementById('saleResultBlock').classList.remove('hidden');
                const totalCost = getGroupTotalCostNumber(group);
                const profit = group.salePrice - totalCost;
                document.getElementById('reportSaleValue').innerText = `R$ ${group.salePrice.toFixed(2)}`;
                document.getElementById('reportTotalCost').innerText = `R$ ${totalCost.toFixed(2)}`;
                const elProfit = document.getElementById('reportNetProfit');
                elProfit.innerText = `R$ ${profit.toFixed(2)}`;
                elProfit.style.color = profit >= 0 ? '#16a34a' : '#dc2626';
            } else {
                const inWithdrawal = group.health && group.health.some(h => new Date(h.withdrawEnd) >= new Date());
                statusBadge.className = inWithdrawal ? 'badge badge-danger' : 'badge badge-success';
                statusBadge.innerText = inWithdrawal ? 'EM CARÊNCIA' : 'ATIVO';
                document.getElementById('saleFormBlock').classList.remove('hidden');
                document.getElementById('saleResultBlock').classList.add('hidden');
                document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('saleTotalValue').value = '';
            }

            document.getElementById('calcGMD').innerText = `${calculateGMD(group)} kg/dia`;
            document.getElementById('calcTotalCost').innerText = `R$ ${calculateGroupCost(group)}`;
            document.getElementById('useDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('breedingDate').value = new Date().toISOString().split('T')[0]; 
            
            const animalSelect = document.getElementById('useAnimalId');
            const breedingAnimalSelect = document.getElementById('breedingCowSelect'); 
            const animalsHtml = group.animals.map(a => `<option value="${a.id}">${a.id}</option>`).join('') || '<option value="">Nenhum animal cadastrado</option>';
            
            animalSelect.innerHTML = animalsHtml;
            breedingAnimalSelect.innerHTML = animalsHtml;

            document.getElementById('scopeLot').checked = true; 
            toggleIndividualUsage();
            renderGroupCostHistory(group);
            renderWeightList(group);
            renderAnimalList(group);
            renderBreedingList(group); 
            populateBreedingStock(); 
            
            const pSelect = document.getElementById('movePastureSelect');
            if(group.sold) {
                pSelect.disabled = true; pSelect.innerHTML = '<option>Lote vendido</option>';
            } else {
                pSelect.disabled = false;
                pSelect.innerHTML = '<option value="">Sem pasto definido</option>' + 
                    appData.pastures.map(p => `<option value="${p.id}" ${group.currentPastureId == p.id ? 'selected' : ''}>${p.name}</option>`).join('');
            }
            openModal('modalGroupDetails');
        }

        async function processGroupSale() {
            const saleValue = parseFloat(document.getElementById('saleTotalValue').value);
            const saleDate = document.getElementById('saleDate').value;
            if (!saleValue || !saleDate) { alert("Informe valor e data."); return; }
            if (!confirm(`Confirmar a venda por R$ ${saleValue.toFixed(2)}?`)) return;

            const group = appData.groups.find(g => g.id == activeGroupId);
            group.sold = true; group.salePrice = saleValue; group.saleDate = saleDate; group.currentPastureId = null;

            appData.financials.push({
                id: Date.now(), type: 'income', desc: `Venda Lote: ${group.name}`,
                amount: saleValue, date: saleDate, isGroupSale: true, groupId: group.id
            });

            await saveData();
            openGroupDetails(activeGroupId);
            renderAll();
            alert("Venda realizada!");
        }

        // --- LÓGICA DE USO DE ESTOQUE ---
        function toggleIndividualUsage() {
            const scope = document.querySelector('input[name="usageScope"]:checked').value;
            const individualSelect = document.getElementById('individualAnimalSelect');
            const healthDoseHint = document.getElementById('healthDoseHint');
            const labelQtyTotal = document.getElementById('labelQtyTotal');

            if (scope === 'individual') {
                individualSelect.classList.remove('hidden');
                healthDoseHint.innerText = 'Quantidade utilizada é a dose única (Ex: 5ml).';
                labelQtyTotal.innerText = 'Quantidade/Dose única utilizada';
            } else {
                individualSelect.classList.add('hidden');
                healthDoseHint.innerText = 'O sistema multiplicará pela quantidade de animais.';
                labelQtyTotal.innerText = 'Quantidade Total fornecida ao lote';
            }
            populateStockUsageSelect(); 
        }

        function populateStockUsageSelect() {
            const type = document.getElementById('useStockType').value;
            const select = document.getElementById('useStockProduct');
            const list = appData.inventory || [];
            let filtered = [];
            
            document.getElementById('usageBlockNutrition').classList.add('hidden');
            document.getElementById('usageBlockHealth').classList.add('hidden');

            if(type === 'nutrition') {
                filtered = list.filter(i => (i.category === 'Ração' || i.category === 'Sal Mineral') && i.currentQty > 0);
                document.getElementById('usageBlockNutrition').classList.remove('hidden');
            } else if (type === 'health') {
                filtered = list.filter(i => (i.category === 'Vacina' || i.category === 'Medicamento') && i.currentQty > 0);
                document.getElementById('usageBlockHealth').classList.remove('hidden');
            } else {
                filtered = list.filter(i => i.category === 'Outros' && i.currentQty > 0);
                document.getElementById('usageBlockNutrition').classList.remove('hidden');
            }

            select.innerHTML = '<option value="">Selecione...</option>' + 
                filtered.map(i => `<option value="${i.id}" data-unit="${i.unit}">${i.name} (Disp: ${parseFloat(i.currentQty).toFixed(2)} ${i.unit})</option>`).join('');

            select.onchange = function() {
                const opt = select.options[select.selectedIndex];
                const u = opt ? (opt.getAttribute('data-unit') || '--') : '--';
                document.getElementById('useUnitDisplay1').innerText = u;
                document.getElementById('useUnitDisplay2').innerText = u;
            }
        }

        async function confirmStockUsage() {
            const group = appData.groups.find(g => g.id == activeGroupId);
            if(group.sold) { alert('Lote vendido.'); return; }

            const usageType = document.getElementById('useStockType').value;
            const prodId = document.getElementById('useStockProduct').value;
            const date = document.getElementById('useDate').value;
            const scope = document.querySelector('input[name="usageScope"]:checked').value;
            const animalId = document.getElementById('useAnimalId').value;
            
            if(!prodId || !date) { alert('Selecione produto e data.'); return; }
            if(scope === 'individual' && !animalId) { alert('Selecione o animal.'); return; }

            const product = appData.inventory.find(i => i.id == prodId);
            if(!product) return;

            let qtyUsed = 0;
            const numAnimals = group.animals.length || group.quantity || 1;

            if(usageType === 'health') {
                const dose = parseFloat(document.getElementById('useDosePerAnimal').value);
                const withdrawal = parseInt(document.getElementById('useWithdrawal').value) || 0;
                if(!dose) return;
                qtyUsed = scope === 'individual' ? dose : dose * numAnimals;

                if(qtyUsed > product.currentQty) { alert(`Estoque insuficiente.`); return; }

                if(withdrawal > 0) {
                    const endDate = new Date(date);
                    endDate.setDate(endDate.getDate() + withdrawal);
                    group.health.push({
                        name: product.name, date, withdrawDays: withdrawal, withdrawEnd: endDate.toISOString().split('T')[0],
                        scope, animalId: scope === 'individual' ? animalId : null, brand: product.brand, batch: product.batch
                    });
                }
            } else { 
                qtyUsed = parseFloat(document.getElementById('useQtyTotal').value);
                if(!qtyUsed) return;
                if(qtyUsed > product.currentQty) { alert(`Estoque insuficiente.`); return; }
            }

            product.currentQty -= qtyUsed;
            const cost = qtyUsed * product.avgPrice;
            group.costHistory.push({
                date, itemName: product.name, category: product.category, qty: qtyUsed, unit: product.unit,
                totalCost: cost, scope, animalId: scope === 'individual' ? animalId : null, brand: product.brand, batch: product.batch
            });

            await saveData();
            openGroupDetails(activeGroupId);
            renderAll();
        }

        // --- LÓGICA DE REPRODUÇÃO ---
        function populateBreedingStock() {
            const select = document.getElementById('breedingBullSelect');
            const bulls = appData.inventory.filter(i => i.category === 'Sêmen' && i.currentQty > 0);
            
            select.innerHTML = '<option value="">Selecione Touro/Sêmen</option>' + 
                bulls.map(b => `<option value="${b.id}" data-stock="${b.currentQty}">${b.name} (${b.currentQty} doses) - ${b.breed || ''}</option>`).join('');
            
            select.onchange = function() {
                const opt = select.options[select.selectedIndex];
                const stock = opt ? parseFloat(opt.getAttribute('data-stock')) : 0;
                const alertEl = document.getElementById('breedingBullAlert');
                if(stock <= 10 && stock > 0) {
                    alertEl.innerText = `Atenção: Apenas ${stock} doses restantes!`;
                    alertEl.classList.remove('hidden');
                } else {
                    alertEl.classList.add('hidden');
                }
            };
        }

        function calcIatfDate() {
            const start = document.getElementById('iatfStartDate').value;
            if(start) {
                const d = new Date(start);
                d.setDate(d.getDate() + 11); 
                document.getElementById('breedingDate').value = d.toISOString().split('T')[0];
            }
        }

        function toggleBreedingScope() {
            const scope = document.querySelector('input[name="breedingScope"]:checked').value;
            const sel = document.getElementById('breedingCowSelect');
            if(scope === 'individual') sel.classList.remove('hidden');
            else sel.classList.add('hidden');
        }

        async function saveInsemination() {
            const group = appData.groups.find(g => g.id == activeGroupId);
            const type = document.getElementById('breedingType').value;
            const date = document.getElementById('breedingDate').value;
            const bullId = document.getElementById('breedingBullSelect').value;
            const inseminator = document.getElementById('breedingInseminator').value;
            const scope = document.querySelector('input[name="breedingScope"]:checked').value;
            const animalId = document.getElementById('breedingCowSelect').value;
            const ecc = document.getElementById('breedingECC').value;

            if(!date || !bullId) { alert("Data e Touro são obrigatórios."); return; }
            if(scope === 'individual' && !animalId) { alert("Selecione a vaca."); return; }

            const bullItem = appData.inventory.find(i => i.id == bullId);
            const dosesNeeded = (scope === 'individual') ? 1 : (group.animals.length || group.quantity); 

            if(bullItem.currentQty < dosesNeeded) {
                alert(`Estoque insuficiente de sêmen. Necessário: ${dosesNeeded}, Disponível: ${bullItem.currentQty}`);
                return;
            }

            if(!confirm(`Confirmar IA em ${dosesNeeded} animais?\nIsso baixará ${dosesNeeded} doses do estoque.`)) return;

            bullItem.currentQty -= dosesNeeded;
            const cost = dosesNeeded * bullItem.avgPrice;

            group.costHistory.push({
                date, itemName: `IA (${bullItem.name})`, category: "Reprodução", qty: dosesNeeded, unit: 'ds',
                totalCost: cost, scope, animalId: scope === 'individual' ? animalId : null, brand: bullItem.brand, batch: bullItem.batch
            });

            const diagDate = new Date(date);
            diagDate.setDate(diagDate.getDate() + 30);

            const eventData = {
                id: Date.now(),
                date, type, bullName: bullItem.name, inseminator, ecc,
                scope, animalId: scope === 'individual' ? animalId : 'LOTE',
                diagnosisDate: diagDate.toISOString().split('T')[0],
                status: 'Aguardando Toque', 
                cost: cost
            };

            if(!group.breedingEvents) group.breedingEvents = [];
            group.breedingEvents.push(eventData);

            await saveData();
            alert("Inseminação registrada com sucesso!");
            populateBreedingStock(); 
            renderBreedingList(group);
            renderGroupCostHistory(group);
            openGroupDetails(activeGroupId);
        }

        async function updatePregnancyStatus(eventId, newStatus) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            const event = group.breedingEvents.find(e => e.id == eventId);
            if(event) {
                event.status = newStatus;
                await saveData();
                renderBreedingList(group);
            }
        }

        function renderBreedingList(group) {
            const list = document.getElementById('breedingList');
            if(!group.breedingEvents || group.breedingEvents.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray text-center">Nenhum registro.</p>';
                return;
            }

            list.innerHTML = [...group.breedingEvents].sort((a,b) => new Date(b.date) - new Date(a.date)).map(evt => {
                let statusColor = 'var(--gray)';
                if(evt.status === 'Prenha') statusColor = 'var(--primary)';
                if(evt.status === 'Vazia') statusColor = 'var(--danger)';
                
                let actions = '';
                if(evt.status === 'Aguardando Toque') {
                    actions = `
                    <div style="margin-top:8px; display:flex; gap:10px;">
                        <button class="btn btn-sm btn-success" style="padding:4px 8px; font-size:0.7rem;" onclick="updatePregnancyStatus(${evt.id}, 'Prenha')"><i class="fas fa-check"></i> Prenha</button>
                        <button class="btn btn-sm btn-danger" style="padding:4px 8px; font-size:0.7rem;" onclick="updatePregnancyStatus(${evt.id}, 'Vazia')"><i class="fas fa-times"></i> Vazia</button>
                    </div>`;
                }

                return `
                <div class="list-item" style="display:block;">
                    <div class="flex-between">
                        <div>
                            <strong>${new Date(evt.date).toLocaleDateString('pt-BR')}</strong> <span class="badge badge-pink">${evt.type}</span>
                            <div class="text-sm">Touro: ${evt.bullName}</div>
                            <div class="text-xs text-gray">Escopo: ${evt.scope === 'individual' ? 'Vaca ' + evt.animalId : 'Lote Todo'}</div>
                        </div>
                        <div class="text-right">
                            <div style="font-weight:bold; color:${statusColor};">${evt.status}</div>
                            <div class="text-xs text-gray">Prev. Toque: ${new Date(evt.diagnosisDate).toLocaleDateString('pt-BR')}</div>
                        </div>
                    </div>
                    ${actions}
                </div>`;
            }).join('');
        }

        function renderGroupCostHistory(group) {
            const list = document.getElementById('groupCostList');
            if(!group.costHistory || group.costHistory.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray text-center">Nenhum custo registrado.</p>'; return;
            }
            list.innerHTML = [...group.costHistory].sort((a,b) => new Date(b.date) - new Date(a.date)).map(c => {
                let scopeInfo = (c.scope === 'individual' && c.animalId) ? ` <span class="badge badge-warning">Animal: ${c.animalId}</span>` : '';
                if (c.isInitialCost) scopeInfo = ' <span class="badge badge-purple">CUSTO INICIAL</span>';
                let batchInfo = (c.batch || c.brand) ? `<div class="text-xs text-gray">Marca: ${c.brand || '-'} | Lote: ${c.batch || '-'}</div>` : '';
                return `
                <div class="list-item text-sm">
                    <div><strong>${c.itemName}</strong>${scopeInfo} <span class="text-gray">(${c.qty.toFixed(1)} ${c.unit})</span>
                    ${batchInfo}<div style="font-size:0.75rem;">${new Date(c.date).toLocaleDateString('pt-BR')}</div></div>
                    <div class="text-danger font-bold">- R$ ${c.totalCost.toFixed(2)}</div>
                </div>`;
            }).join('');
        }

        // --- SUB-FUNCTIONS ---
        async function moveGroup(pid) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            if(group.sold) return;
            group.currentPastureId = pid || null;
            await saveData();
            renderAll();
        }

        async function addWeight() {
            const date = document.getElementById('weightDate').value;
            const weight = parseFloat(document.getElementById('weightValue').value);
            if(!date || !weight) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            if(group.sold) return;
            group.weighings.push({date, weight});
            await saveData();
            openGroupDetails(activeGroupId);
            renderAll();
        }

        function renderWeightList(group) {
            const list = document.getElementById('weightHistoryList');
            list.innerHTML = group.weighings.sort((a,b) => new Date(b.date) - new Date(a.date)).map(w => 
                `<div class="list-item text-sm"><span>${new Date(w.date).toLocaleDateString('pt-BR')}</span> <strong>${w.weight} kg</strong></div>`
            ).join('');
        }

        async function addAnimalToGroup() {
            const id = document.getElementById('newAnimalId').value;
            if(!id) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            if(group.sold) return;
            group.animals.push({ id, entryDate: new Date().toISOString().split('T')[0], weight: 0 }); 
            group.quantity = group.animals.length;
            document.getElementById('newAnimalId').value = '';
            await saveData();
            renderAnimalList(group);
            renderAll();
        }

        function renderAnimalList(group) {
            const list = document.getElementById('animalList');
            list.innerHTML = group.animals.map((a, idx) => 
                `<div class="list-item text-sm">
                    <div><span><i class="fas fa-tag"></i> <strong>${a.id}</strong></span><div class="text-xs text-gray">Peso: ${a.weight ? a.weight.toFixed(2) + ' kg' : 'N/A'}</div></div>
                    <div class="btn-group-row">
                        <button class="btn btn-outline btn-sm" onclick="openEditAnimal(${idx})"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="removeAnimal(${idx})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`
            ).join('');
        }

        function openEditAnimal(idx) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            if(group.sold) return;
            const animal = group.animals[idx];
            document.getElementById('editAnimalIndex').value = idx;
            document.getElementById('editAnimalIdInput').value = animal.id;
            document.getElementById('editAnimalWeightInput').value = animal.weight || ''; 
            openModal('modalEditAnimal');
        }

        async function saveAnimalEdit() {
            const idx = document.getElementById('editAnimalIndex').value;
            const newId = document.getElementById('editAnimalIdInput').value;
            const newWeight = parseFloat(document.getElementById('editAnimalWeightInput').value) || 0; 
            if(!newId) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            group.animals[idx].id = newId; group.animals[idx].weight = newWeight; 
            await saveData();
            closeModal('modalEditAnimal');
            renderAnimalList(group);
            renderAll();
        }

        async function removeAnimal(idx) {
            const group = appData.groups.find(g => g.id == activeGroupId);
            if(group.sold) return;
            group.animals.splice(idx, 1); group.quantity = group.animals.length;
            await saveData();
            renderAnimalList(group);
            renderAll();
        }

        function runSimulation() {
            const date = document.getElementById('simDate').value;
            const gmd = parseFloat(document.getElementById('simGMD').value);
            const price = parseFloat(document.getElementById('simPrice').value);
            if(!date || !gmd || !price || !activeGroupId) return;
            const group = appData.groups.find(g => g.id == activeGroupId);
            const currentWeightInfo = getCurrentLotWeight(group);
            if(currentWeightInfo.weight === 0) return;
            const diffDays = Math.ceil((new Date(date) - new Date()) / (86400000));
            if(diffDays <= 0) return;
            const futureWeight = currentWeightInfo.weight + (gmd * diffDays);
            const revenue = (futureWeight * (group.animals.length || group.quantity) / 30) * price;
            document.getElementById('resWeight').innerText = futureWeight.toFixed(1) + ' kg';
            document.getElementById('resRevenue').innerText = `R$ ${revenue.toFixed(2)}`;
            document.getElementById('simResult').classList.remove('hidden');
        }

        // --- FINANCEIRO ---
        function openTransactionModal(type) {
            document.getElementById('transType').value = type;
            document.getElementById('transDesc').value = '';
            document.getElementById('transAmount').value = '';
            document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transTitle').innerText = type === 'income' ? 'Nova Receita' : 'Nova Despesa';
            document.getElementById('transTitle').className = type === 'income' ? 'text-success' : 'text-danger';
            document.getElementById('btnSaveTrans').className = type === 'income' ? 'btn btn-success' : 'btn btn-danger';
            openModal('modalTransaction');
        }

        async function addTransaction() {
            const type = document.getElementById('transType').value;
            const desc = document.getElementById('transDesc').value;
            const amount = parseFloat(document.getElementById('transAmount').value);
            const date = document.getElementById('transDate').value;
            if(!desc || !amount || !date) return;
            appData.financials.push({ id: Date.now(), type, desc, amount, date });
            await saveData();
            closeModal('modalTransaction');
            renderAll();
        }

        // --- ADMIN FUNCTIONS ---
        async function loadAdminUserList() {
            if(currentUser.role !== 'admin') return;
            const listContainer = document.getElementById('adminUserList');
            listContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando lista...</div>';
            try {
                const snapshot = await db.collection('auth').get();
                allUsersCache = [];
                snapshot.forEach(doc => allUsersCache.push({ id: doc.id, ...doc.data() }));
                renderAdminList();
            } catch (e) { listContainer.innerHTML = '<p class="text-danger">Erro ao listar usuários.</p>'; }
        }

        function renderAdminList() {
            const listContainer = document.getElementById('adminUserList');
            if(allUsersCache.length === 0) { listContainer.innerHTML = '<p>Nenhum usuário.</p>'; return; }
            listContainer.innerHTML = allUsersCache.map(u => {
                const isMe = u.id === currentUser.id;
                let roleBadge = u.role === 'admin' ? '<span class="badge badge-purple">Admin</span>' : (u.role === 'manager' ? '<span class="badge badge-info">Gerente</span>' : '<span class="badge badge-gray">Produtor</span>');
                const manageBtn = (u.role === 'manager') ? `<button class="btn btn-sm btn-secondary" onclick="openAssignModal('${u.id}')" style="margin-top:5px;"><i class="fas fa-network-wired"></i> Atribuir Fazendas</button>` : '';
                const roleSelector = !isMe ? `<select class="form-input text-sm" style="width:auto; padding:5px;" onchange="changeUserRole('${u.id}', this.value)">
                        <option value="basic" ${u.role === 'basic' ? 'selected' : ''}>Produtor</option>
                        <option value="manager" ${u.role === 'manager' ? 'selected' : ''}>Gerente</option>
                        <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>` : '<span class="text-xs text-gray">Você</span>';
                return `<div class="card" style="display:flex; flex-direction:column; gap:10px; border-left: 4px solid var(--primary);">
                    <div class="flex-between">
                        <div><strong>${u.fullName}</strong> <small class="text-gray">(${u.userName})</small><div style="margin-top:4px;">${roleBadge}</div></div>
                        <div>${roleSelector}</div>
                    </div>
                    ${manageBtn}
                </div>`;
            }).join('');
        }

        async function changeUserRole(targetId, newRole) {
            if(!confirm(`Alterar para ${newRole.toUpperCase()}?`)) { loadAdminUserList(); return; }
            try {
                await db.collection('auth').doc(targetId).update({ role: newRole });
                const user = allUsersCache.find(u => u.id === targetId);
                if(user) user.role = newRole;
                renderAdminList();
            } catch (e) { alert('Erro ao atualizar permissão.'); }
        }

        function openAssignModal(managerId) {
            const manager = allUsersCache.find(u => u.id === managerId);
            if(!manager) return;
            document.getElementById('targetManagerId').value = managerId;
            document.getElementById('assignManagerName').innerText = manager.fullName;
            const list = document.getElementById('assignFarmList');
            const potentialFarms = allUsersCache.filter(u => u.id !== managerId && u.role !== 'admin');
            list.innerHTML = potentialFarms.map(farm => {
                const isChecked = manager.managedFarms && manager.managedFarms.includes(farm.id);
                // FIX: Adicionado display: flex explícito para sobrescrever regra de Grid do desktop e manter alinhamento à esquerda
                return `<label class="list-item" style="display: flex; justify-content: flex-start; gap: 10px; align-items: center;">
                    <input type="checkbox" value="${farm.id}" ${isChecked ? 'checked' : ''}>
                    <div><strong>${farm.fullName}</strong><div class="text-xs text-gray">Usuário: ${farm.userName}</div></div>
                </label>`;
            }).join('');
            openModal('modalAdminAssign');
        }

        async function saveManagerAssignments() {
            const managerId = document.getElementById('targetManagerId').value;
            const checkboxes = document.querySelectorAll('#assignFarmList input[type="checkbox"]:checked');
            const selectedFarms = Array.from(checkboxes).map(cb => cb.value);
            try {
                await db.collection('auth').doc(managerId).update({ managedFarms: selectedFarms });
                const manager = allUsersCache.find(u => u.id === managerId);
                if(manager) manager.managedFarms = selectedFarms;
                alert('Atribuições salvas!');
                closeModal('modalAdminAssign');
                renderAdminList();
            } catch (e) { alert('Erro: ' + e.message); }
        }

        // --- LÓGICA DE RELATÓRIOS PDF ---

        function toggleReportOptions() {
            const type = document.getElementById('reportType').value;
            const groupDiv = document.getElementById('reportGroupSelectDiv');
            const groupSelect = document.getElementById('reportGroupTarget');

            if (type === 'group_specific') {
                groupDiv.classList.remove('hidden');
                groupSelect.innerHTML = appData.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            } else {
                groupDiv.classList.add('hidden');
            }
        }

        async function generatePDF() {
            const type = document.getElementById('reportType').value;
            const titleEl = document.getElementById('pdf-title');
            const bodyEl = document.getElementById('pdf-body');
            const dateEl = document.getElementById('pdf-date-generation');
            const farmEl = document.getElementById('pdf-farm-name');

            // Configura Cabeçalho
            dateEl.innerText = new Date().toLocaleString('pt-BR');
            farmEl.innerText = currentUser ? `Produtor: ${currentUser.fullName}` : 'MeuGado';

            let contentHtml = '';

            // 1. Relatório Financeiro
            if (type === 'financial') {
                titleEl.innerText = 'Relatório Financeiro Completo';
                let totalIncome = 0;
                let totalExpense = 0;
                
                const rows = appData.financials.sort((a,b) => new Date(b.date) - new Date(a.date)).map(f => {
                    if(f.type === 'income') totalIncome += f.amount;
                    else totalExpense += f.amount;
                    const color = f.type === 'income' ? 'green' : 'red';
                    return `<tr>
                        <td>${new Date(f.date).toLocaleDateString('pt-BR')}</td>
                        <td>${f.desc}</td>
                        <td style="color:${color}; font-weight:bold;">${f.type === 'income' ? 'Receita' : 'Despesa'}</td>
                        <td class="text-right">R$ ${f.amount.toFixed(2)}</td>
                    </tr>`;
                }).join('');

                contentHtml = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:bold;">
                        <div style="color:green;">Total Receitas: R$ ${totalIncome.toFixed(2)}</div>
                        <div style="color:red;">Total Despesas: R$ ${totalExpense.toFixed(2)}</div>
                        <div style="color:${(totalIncome - totalExpense) >= 0 ? 'black' : 'red'}">Saldo: R$ ${(totalIncome - totalExpense).toFixed(2)}</div>
                    </div>
                    <table class="pdf-table">
                        <thead><tr><th>Data</th><th>Descrição</th><th>Tipo</th><th class="text-right">Valor</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>`;
            }

            // 2. Relatório de Lote Específico
            else if (type === 'group_specific') {
                const groupId = document.getElementById('reportGroupTarget').value;
                const group = appData.groups.find(g => g.id == groupId);
                
                if (group) {
                    titleEl.innerText = `Relatório do Lote: ${group.name}`;
                    const currentWeight = getCurrentLotWeight(group).weight;
                    
                    // Tabela de Custos
                    const costRows = (group.costHistory || []).map(c => `<tr>
                        <td>${new Date(c.date).toLocaleDateString('pt-BR')}</td>
                        <td>${c.itemName}</td>
                        <td>${c.qty} ${c.unit}</td>
                        <td class="text-right">R$ ${c.totalCost.toFixed(2)}</td>
                    </tr>`).join('');

                    // Tabela de Animais
                    const animalRows = (group.animals || []).map(a => `<tr>
                        <td>${a.id}</td>
                        <td class="text-right">${a.weight ? a.weight.toFixed(2) + ' kg' : '-'}</td>
                    </tr>`).join('');

                    contentHtml = `
                        <div style="background:#f3f4f6; padding:10px; border-radius:8px; margin-bottom:15px;">
                            <strong>Categoria:</strong> ${group.category} <br>
                            <strong>Qtd Animais:</strong> ${group.animals.length || group.quantity} <br>
                            <strong>GMD Médio:</strong> ${calculateGMD(group)} kg/dia <br>
                            <strong>Custo Total:</strong> R$ ${calculateGroupCost(group)}
                        </div>
                        
                        <h3>Custos e Insumos</h3>
                        <table class="pdf-table" style="margin-bottom:20px;">
                            <thead><tr><th>Data</th><th>Item</th><th>Qtd</th><th class="text-right">Custo</th></tr></thead>
                            <tbody>${costRows || '<tr><td colspan="4">Sem registros</td></tr>'}</tbody>
                        </table>

                        <h3>Animais do Lote</h3>
                        <table class="pdf-table">
                            <thead><tr><th>Identificação</th><th class="text-right">Peso Atual</th></tr></thead>
                            <tbody>${animalRows || '<tr><td colspan="2">Sem animais cadastrados</td></tr>'}</tbody>
                        </table>
                    `;
                }
            }

            // 3. Resumo Geral
            else if (type === 'general_summary') {
                titleEl.innerText = 'Resumo Geral da Fazenda';
                
                const rows = appData.groups.map(g => {
                    const weightInfo = getCurrentLotWeight(g);
                    return `<tr>
                        <td>${g.name} ${g.sold ? '(Vendido)' : ''}</td>
                        <td>${g.category}</td>
                        <td>${g.animals.length || g.quantity}</td>
                        <td>${weightInfo.weight.toFixed(2)} kg</td>
                        <td class="text-right">R$ ${calculateGroupCost(g)}</td>
                    </tr>`;
                }).join('');

                contentHtml = `
                    <table class="pdf-table">
                        <thead><tr><th>Lote</th><th>Categoria</th><th>Cab</th><th>Peso Médio</th><th class="text-right">Custo Total</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>`;
            }

            // 4. Pluviometria
            else if (type === 'rainfall') {
                titleEl.innerText = 'Relatório de Chuvas (Pluviometria)';
                let totalMm = 0;
                
                const rows = appData.rainfall.map(r => {
                    totalMm += r.mm;
                    return `<tr>
                        <td>${new Date(r.date).toLocaleDateString('pt-BR')}</td>
                        <td class="text-right">${r.mm} mm</td>
                    </tr>`;
                }).join('');

                contentHtml = `
                    <div style="margin-bottom:15px;"><strong>Acumulado Total Registrado:</strong> ${totalMm} mm</div>
                    <table class="pdf-table">
                        <thead><tr><th>Data</th><th class="text-right">Milímetros (mm)</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>`;
            }

            // 5. Sanitário Geral
            else if (type === 'sanitary_general') {
                titleEl.innerText = 'Relatório Sanitário Geral';
                let htmlBuilder = '';

                appData.groups.forEach(g => {
                    if(g.health && g.health.length > 0) {
                        const healthRows = g.health.map(h => `<tr>
                            <td>${new Date(h.date).toLocaleDateString('pt-BR')}</td>
                            <td>${h.name}</td>
                            <td>${h.withdrawDays > 0 ? new Date(h.withdrawEnd).toLocaleDateString('pt-BR') : '-'}</td>
                            <td>${h.scope === 'individual' ? 'Individual (' + (h.animalId || '?') + ')' : 'Lote Todo'}</td>
                        </tr>`).join('');

                        htmlBuilder += `
                            <h4 style="margin-top:15px; border-bottom:1px solid #ccc;">Lote: ${g.name}</h4>
                            <table class="pdf-table">
                                <thead><tr><th>Data Aplicação</th><th>Produto</th><th>Fim Carência</th><th>Escopo</th></tr></thead>
                                <tbody>${healthRows}</tbody>
                            </table>
                        `;
                    }
                });

                contentHtml = htmlBuilder || '<p>Nenhum registro sanitário encontrado nos lotes.</p>';
            }

            // Injeta conteúdo
            bodyEl.innerHTML = contentHtml;

            // Configurações do HTML2PDF
            const element = document.getElementById('pdf-template');
            const opt = {
                margin:       0,
                filename:     `Relatorio_MeuGado_${type}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Gera e Salva
            closeModal('modalReports');
            
            // Pequeno delay para garantir renderização
            setTimeout(() => {
                html2pdf().set(opt).from(element).save().catch(err => {
                    console.error(err);
                    alert("Erro ao gerar PDF. Tente novamente.");
                });
            }, 500);
        }

        // --- RENDER ---
        let chartInstance = null;
        function renderAll() {
            // Stats
            let totalAnimals = 0;
            appData.groups.forEach(g => { if(!g.sold) totalAnimals += (g.animals.length || g.quantity); });
            document.getElementById('dashTotalAnimals').innerText = totalAnimals;

            let sumGmd = 0, countGmd = 0;
            appData.groups.forEach(g => {
                if(!g.sold) { const val = parseFloat(calculateGMD(g)); if(val > 0) { sumGmd += val; countGmd++; } }
            });
            document.getElementById('dashAvgGMD').innerText = countGmd ? (sumGmd/countGmd).toFixed(3) : '0.000';

            // Lists
            document.getElementById('groupsList').innerHTML = appData.groups.map(g => {
                const currentWeightInfo = getCurrentLotWeight(g);
                const displayWeight = currentWeightInfo.weight > 0 ? currentWeightInfo.weight.toFixed(2) : '-';
                const opacity = g.sold ? 'opacity: 0.7;' : '';
                const soldBadge = g.sold ? '<span class="badge badge-gray" style="margin-left:5px;">VENDIDO</span>' : '';
                
                // --- ÍCONE DINÂMICO ---
                const iconClass = getIconForType(g.herdType);

                return `<div class="card list-item" onclick="openGroupDetails(${g.id})" style="${opacity}">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="background:var(--primary-light); padding:10px; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; color:var(--primary-dark);">
                            <i class="${iconClass}"></i>
                        </div>
                        <div>
                            <div style="font-weight:bold; color:var(--dark);">${g.name} ${soldBadge}</div>
                            <div class="text-sm text-gray">${g.category} • ${g.animals.length || g.quantity} cab</div>
                        </div>
                    </div>
                    <div class="text-center"><div style="font-weight:bold; color:var(--primary);">${displayWeight} kg</div><div class="text-sm text-gray">Peso Médio</div></div>
                </div>`;
            }).join('');

            // --- RENDER PASTOS (COM ONCLICK PARA EDIÇÃO) ---
            document.getElementById('pasturesGrid').innerHTML = appData.pastures.map(p => {
                const ua = getStockingRate(p.id);
                const groups = appData.groups.filter(g => g.currentPastureId == p.id && !g.sold);
                const isOccupied = groups.length > 0;
                return `<div class="paddock-cell ${isOccupied ? 'occupied' : ''}" onclick="openEditPasture(${p.id})">
                    <strong>${p.name}</strong><div class="text-sm">${p.area} ha</div>
                    <div style="font-size:0.75rem; margin-top:4px;">${ua} UA/ha</div>
                    ${isOccupied ? `<small style="color:var(--primary-dark); font-weight:bold;">${groups.length} Lotes</small>` : ''}
                </div>`;
            }).join('');

            let stockTotal = 0;
            const inventoryList = document.getElementById('inventoryList');
            if(appData.inventory.length === 0) inventoryList.innerHTML = '<p class="text-center text-gray" style="padding:20px;">Vazio.</p>';
            else inventoryList.innerHTML = appData.inventory.map(i => {
                stockTotal += (i.currentQty * i.avgPrice);
                // Badge diferente para Sêmen
                let badgeClass = i.category === 'Vacina' ? 'badge-danger' : 
                                 (i.category === 'Ração' ? 'badge-success' : 
                                 (i.category === 'Sêmen' ? 'badge-pink' : 'badge-info'));
                
                return `<div class="list-item">
                    <div><div style="font-weight:bold;">${i.name} <span class="badge ${badgeClass}">${i.category}</span></div><div class="text-sm text-gray">Médio: R$ ${i.avgPrice.toFixed(2)}</div></div>
                    <div class="text-center"><strong style="font-size:1.1rem; color:var(--primary);">${parseFloat(i.currentQty).toFixed(2)} ${i.unit}</strong></div>
                </div>`;
            }).join('');
            document.getElementById('stockTotalValue').innerText = `R$ ${stockTotal.toFixed(2)}`;

            let totalIncome = 0, totalExpense = 0;
            const listFin = document.getElementById('financialList');
            let allTrans = appData.financials ? [...appData.financials] : [];
            allTrans.forEach(t => { if(t.type === 'income') totalIncome += t.amount; else totalExpense += t.amount; });
            allTrans.sort((a,b) => new Date(b.date) - new Date(a.date));
            listFin.innerHTML = allTrans.map(t => `<div class="list-item">
                <div><div style="font-weight:600;">${t.desc}</div><div class="text-sm text-gray">${new Date(t.date).toLocaleDateString('pt-BR')}</div></div>
                <div class="${t.type === 'income' ? 'text-success' : 'text-danger'}" style="font-weight:bold;">${t.type === 'income' ? '+' : '-'} R$ ${t.amount.toFixed(2)}</div>
            </div>`).join('');

            document.getElementById('finTotalRevenue').innerText = `R$ ${totalIncome.toFixed(2)}`;
            document.getElementById('finTotalExpense').innerText = `R$ ${totalExpense.toFixed(2)}`;
            const net = totalIncome - totalExpense;
            const elNet = document.getElementById('finNetProfit');
            elNet.innerText = `R$ ${net.toFixed(2)}`;
            elNet.className = net >= 0 ? 'text-success' : 'text-danger';

            const ctx = document.getElementById('rainWeightChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: appData.rainfall.map(r => r.date.substring(5)),
                    datasets: [
                        { label: 'Chuva (mm)', data: appData.rainfall.map(r=>r.mm), backgroundColor: '#60a5fa', yAxisID: 'y' },
                        { label: 'Peso Simulado', data: appData.rainfall.map(r=>Math.random()*5+300), type: 'line', borderColor: '#059669', yAxisID: 'y1' }
                    ]
                },
                options: { responsive: true, scales: { y: {position:'left'}, y1: {position:'right', grid:{drawOnChartArea:false}} } }
            });
        }

        function switchView(id, nav) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            nav.classList.add('active');
        }
        function switchTab(id, event) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
        }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // --- OFFLINE STATUS HELPER ---
        // Monitorar status da conexão
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        function updateOnlineStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            if (!statusDiv) return; // Se ainda não criou o elemento

            if (navigator.onLine) {
                statusDiv.innerHTML = '<i class="fas fa-wifi"></i> Online (Sincronizado)';
                statusDiv.className = 'badge badge-success';
                statusDiv.style.position = 'fixed';
                statusDiv.style.bottom = '10px';
                statusDiv.style.right = '10px';
                
                // Some depois de 3 segundos
                setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
            } else {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<i class="fas fa-cloud-slash"></i> Offline (Salvando no dispositivo)';
                statusDiv.className = 'badge badge-warning';
                statusDiv.style.position = 'fixed';
                statusDiv.style.bottom = '10px';
                statusDiv.style.right = '10px';
                statusDiv.style.zIndex = '9999';
            }
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => { console.log('Service Worker registrado:', registration.scope); })
                    .catch((error) => { console.log('Falha SW:', error); });
            });
        }
    </script>
</body>
</html>
